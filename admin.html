<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- orig: <title>관리자 ?�이지 - ?�소마�???/title> -->
  <title>관리자 페이지 - OSO Camping BBQ</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="env.js"></script>
</head>
<body style="background:#f5f6fa;">
  <!-- 관리자 헤더 -->
  <header class="admin-header" style="padding:20px 24px; background:#fff; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #e9ecef;">
    <!-- orig: <h1>?�약 관�??�스??/h1> -->
    <h1 style="font-size:1.4rem; font-weight:600;">OSO Camping BBQ 관리자</h1>
    <div style="display:flex; align-items:center; gap:20px;">
      <!-- 관리자 정보 및 로그아웃 -->
      <div class="admin-user-info" id="adminUserInfo" style="display:none;">
        <div class="user-avatar" id="userAvatar">👤</div>
        <div class="user-details">
          <div class="user-name" id="userName">관리자</div>
          <div class="user-role" id="userRole">admin</div>
        </div>
        <div class="user-menu" id="userMenu">
          <button class="user-menu-btn" onclick="toggleUserMenu()">▼</button>
          <div class="user-menu-dropdown" id="userMenuDropdown" style="display:none;">
            <div class="menu-item" onclick="showProfile()">
              <span>👤</span> 내 정보
            </div>
            <div class="menu-item" onclick="showActivityLog()">
              <span>📋</span> 활동 로그
            </div>
            <div class="menu-divider"></div>
            <div class="menu-item logout" onclick="handleLogout()">
              <span>🚪</span> 로그아웃
            </div>
          </div>
        </div>
      </div>
      
      <!-- 실시간 알림 벨 -->
      <div class="notification-bell" id="notificationBell">
        <svg viewBox="0 0 24 24">
          <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
        </svg>
        <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
        
        <!-- 알림 드롭다운 -->
        <div class="notification-dropdown" id="notificationDropdown">
          <div class="notification-header">
            <h3>알림</h3>
            <button class="mark-all-read-btn" id="markAllReadBtn">모두 읽음</button>
          </div>
          <div class="notification-list" id="notificationList">
            <!-- 알림 목록이 여기에 동적으로 추가됩니다 -->
          </div>
        </div>
      </div>
      
      <nav class="admin-nav" style="display:flex; gap:8px;">
        <a href="index.html" class="nav-btn">고객 페이지</a>
        <button class="nav-btn active" onclick="showSection('dashboard')">대시보드</button>
        <button class="nav-btn" onclick="showSection('reservations')">예약 신청</button>
        <button class="nav-btn" onclick="showSection('bookings')">예약 현황</button>
        <button class="nav-btn" onclick="showSection('catalog')">시설 관리</button>
        <button class="nav-btn" onclick="showSection('availability')">가용성 관리</button>
        <button class="nav-btn" onclick="showSection('modifications')">변경 요청</button>
        <button class="nav-btn" onclick="showSection('messages')">메시지 관리</button>
      </nav>
    </div>
  </header>

  <main class="admin-main" style="padding:20px; max-width:1100px; margin:0 auto;">
    <!-- 대시보드 섹션 -->
    <div id="dashboard-section" class="section active">
      <div class="stats-grid" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:12px;">
        <div class="stat-card" style="background:#fff; border-radius:10px; padding:16px; text-align:center;">
          <h3 id="totalReservations" style="font-size:2rem; color:#4facfe;">0</h3>
          <p>전체 예약 신청</p>
        </div>
        <div class="stat-card" style="background:#fff; border-radius:10px; padding:16px; text-align:center;">
          <h3 id="todayReservations" style="font-size:2rem; color:#28a745;">0</h3>
          <p>오늘 예약</p>
        </div>
        <div class="stat-card" style="background:#fff; border-radius:10px; padding:16px; text-align:center;">
          <h3 id="pendingReservations" style="font-size:2rem; color:#ffc107;">0</h3>
          <p>대기 중</p>
        </div>
        <div class="stat-card" style="background:#fff; border-radius:10px; padding:16px; text-align:center;">
          <h3 id="confirmedBookings" style="font-size:2rem; color:#17a2b8;">0</h3>
          <p>확정 예약</p>
        </div>
        <div class="stat-card" style="background:#fff; border-radius:10px; padding:16px; text-align:center;">
          <h3 id="availableSlots" style="font-size:2rem; color:#6f42c1;">78</h3>
          <p>총 슬롯 수</p>
        </div>
      </div>

      <!-- 최근 예약 -->
      <div class="reservations-section" style="margin-top:20px; background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; align-items:center; justify-content:space-between;">
          <h2>최근 예약</h2>
        </div>
        <!-- 빈상태 메시지 (대시보드) -->
        <div id="dashboardEmptyState" class="empty-state" style="display:none; padding:30px; text-align:center; color:#666;">
          <div class="empty-state-icon" style="font-size:2rem;">🗓️</div>
          <h3>아직 예약이 없습니다</h3>
          <p>첫 번째 예약을 받아보세요!</p>
          <a href="index.html" class="empty-state-btn">예약 페이지로 이동</a>
        </div>
        <div class="table-container">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>예약번호</th>
                <th>날짜</th>
                <th>장소</th>
                <th>시간</th>
                <th>이름</th>
                <th>연락처</th>
                <th>인원</th>
                <th>계정연결</th>
                <th>상태</th>
              </tr>
            </thead>
            <tbody id="recentReservationsTable">
              <tr><td colspan="9" class="text-center">데이터를 불러오는 중...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 예약 목록 섹션 -->
    <div id="reservations-section" class="section" style="display:none;">
      <div class="reservations-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>예약 신청 관리</h2>
          <div class="filter-controls" style="display:flex; gap:8px;">
            <select id="statusFilter">
              <option value="">전체 상태</option>
              <option value="pending">신청 대기</option>
              <option value="confirmed">승인 완료</option>
              <option value="cancelled">신청 취소</option>
            </select>
            <select id="categoryFilter">
              <option value="">전체 장소</option>
              <option value="PR">프라이빗룸</option>
              <option value="ST">소파테이블</option>
              <option value="TN">텐트동</option>
              <option value="VP">VIP동</option>
              <option value="YT">야장테이블</option>
            </select>
            <input type="date" id="dateFilter" placeholder="날짜 선택" />
            <button class="refresh-btn" onclick="loadReservations()"><span id="refreshText">새로고침</span></button>
          </div>
        </div>

        <!-- 빈상태 메시지 (예약 목록) -->
        <div id="reservationsEmptyState" class="empty-state" style="display:none; padding:30px; text-align:center; color:#666;">
          <div class="empty-state-icon" style="font-size:2rem;">🗓️</div>
          <h3>예약이 없습니다</h3>
          <p>아직 등록된 예약이 없습니다.<br />고객의 예약을 기다려보세요!</p>
          <a href="index.html" class="empty-state-btn">예약 페이지로 이동</a>
        </div>

        <div class="table-container">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>예약번호</th>
                <th>날짜</th>
                <th>장소</th>
                <th>시간</th>
                <th>이름</th>
                <th>연락처</th>
                <th>이메일</th>
                <th>인원</th>
                <th>계정연결</th>
                <th>상태</th>
                <th>액션</th>
              </tr>
            </thead>
            <tbody id="reservationsTable">
              <tr><td colspan="11" class="text-center">데이터를 불러오는 중...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 상품 등록 섹션 -->
    <div id="products-section" class="section" style="display:none;">
      <div class="products-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>상품 등록</h2>
            <button class="refresh-btn" onclick="loadProducts()"><span id="productRefreshText">새로고침</span></button>
        </div>

        <form id="productForm" style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:12px;">
          <div>
            <label>상품명</label>
            <input id="product_name" name="product_name" required />
          </div>
          <div>
            <label>표시명</label>
            <input id="display_name" name="display_name" required />
          </div>
          <div>
            <label>상품코드</label>
            <input id="product_code" name="product_code" required />
          </div>
          <div>
            <label>상품 날짜</label>
            <input type="date" id="product_date" name="product_date" required />
          </div>
          <div>
            <label>시작 시간</label>
            <input type="time" id="start_time" name="start_time" required />
          </div>
          <div>
            <label>종료 시간</label>
            <input type="time" id="end_time" name="end_time" required />
          </div>
          <div>
            <label>가격</label>
            <input type="number" id="product_price" name="product_price" min="0" step="1000" required />
          </div>
          <div>
            <label>설명</label>
            <input id="product_description" name="product_description" />
          </div>
          <div style="grid-column: 1 / -1;">
            <button type="submit" class="submit-btn">
              <span class="btn-text">상품 등록</span>
              <span class="btn-loader" style="display:none;">처리 중...</span>
            </button>
          </div>
        </form>

        <div class="table-container" style="margin-top:16px;">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>코드</th>
                <th>상품명</th>
                <th>날짜</th>
                <th>시간</th>
                <th>가격</th>
                <th>상태</th>
              </tr>
            </thead>
            <tbody id="productsTable">
              <tr><td colspan="6" class="text-center">데이터를 불러오는 중...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 상품 목록 섹션 -->
    <div id="product-list-section" class="section" style="display:none;">
      <div class="product-list-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>등록된 상품 목록</h2>
          <div class="filter-controls" style="display:flex; gap:8px;">
            <select id="productStatusFilter">
              <option value="">전체 상태</option>
              <option value="active">활성</option>
              <option value="inactive">비활성</option>
            </select>
            <input type="date" id="productDateFilter" placeholder="날짜 선택" />
            <input type="text" id="productSearchFilter" placeholder="상품명 검색" />
            <button class="refresh-btn" onclick="loadProductList()"><span id="productListRefreshText">새로고침</span></button>
          </div>
        </div>

        <!-- 빈상태 메시지 (상품 목록) -->
        <div id="productListEmptyState" class="empty-state" style="display:none; padding:30px; text-align:center; color:#666;">
          <div class="empty-state-icon" style="font-size:2rem;">📦</div>
          <h3>등록된 상품이 없습니다</h3>
          <p>아직 등록된 상품이 없습니다.<br />상품 등록 페이지에서 새 상품을 추가해보세요!</p>
          <button class="empty-state-btn" onclick="showSection('products')">상품 등록하기</button>
        </div>

        <div class="table-container">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>상품코드</th>
                <th>관리용 상품명</th>
                <th>고객용 표시명</th>
                <th>예약일</th>
                <th>시간</th>
                <th>가격</th>
                <th>설명</th>
                <th>상태</th>
                <th>예약여부</th>
                <th>등록일</th>
                <th>액션</th>
              </tr>
            </thead>
            <tbody id="productListTable">
              <tr><td colspan="11" class="text-center">데이터를 불러오는 중...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- 예약현황 섹션 -->
    <div id="bookings-section" class="section" style="display:none;">
      <div class="bookings-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>예약 현황</h2>
          <div class="filter-controls" style="display:flex; gap:8px;">
            <select id="bookingStatusFilter">
              <option value="">전체 상태</option>
              <option value="pending">대기</option>
              <option value="confirmed">확정</option>
              <option value="cancelled">취소</option>
              <option value="completed">완료</option>
            </select>
            <input type="date" id="bookingDateFilter" />
            <input type="text" id="customerSearchFilter" placeholder="고객명 검색" />
            <button class="refresh-btn" onclick="loadBookings()"><span id="bookingRefreshText">새로고침</span></button>
          </div>
        </div>

        <!-- 빈상태 메시지 (예약현황) -->
        <div id="bookingsEmptyState" class="empty-state" style="display:none; padding:30px; text-align:center; color:#666;">
          <div class="empty-state-icon" style="font-size:2rem;">🗓️</div>
          <h3>예약현황이 없습니다</h3>
          <p>아직 등록된 예약현황이 없습니다.<br />고객의 예약을 기다려보세요!</p>
        </div>

        <div class="table-container">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>예약번호</th>
                <th>고객명</th>
                <th>연락처</th>
                <th>이메일</th>
                <th>예약일</th>
                <th>예약시간</th>
                <th>장소</th>
                <th>인원수</th>
                <th>총금액</th>
                <th>상태</th>
                <th>계정여부</th>
                <th>예약일시</th>
                <th>액션</th>
              </tr>
            </thead>
            <tbody id="bookingsTable">
              <tr><td colspan="13" class="text-center">데이터를 불러오는 중...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- OSO 시설 관리 섹션 -->
    <div id="catalog-section" class="section" style="display:none;">
      <div class="catalog-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>시설 관리</h2>
          <button class="refresh-btn" onclick="loadCatalog()"><span id="catalogRefreshText">새로고침</span></button>
        </div>

        <!-- 카테고리별 시설 현황 -->
        <div class="catalog-stats" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:12px; margin-bottom:20px;">
          <div class="stat-card" style="background:#e8f5e8; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#28a745; margin:0;">프라이빗룸</h4>
            <p id="prCount" style="font-size:1.5rem; margin:5px 0 0 0;">0</p>
          </div>
          <div class="stat-card" style="background:#fff3cd; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#856404; margin:0;">소파테이블</h4>
            <p id="stCount" style="font-size:1.5rem; margin:5px 0 0 0;">0</p>
          </div>
          <div class="stat-card" style="background:#d4edda; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#155724; margin:0;">텐트동</h4>
            <p id="tnCount" style="font-size:1.5rem; margin:5px 0 0 0;">0</p>
          </div>
          <div class="stat-card" style="background:#cce5ff; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#0066cc; margin:0;">VIP동</h4>
            <p id="vpCount" style="font-size:1.5rem; margin:5px 0 0 0;">0</p>
          </div>
          <div class="stat-card" style="background:#f8d7da; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#721c24; margin:0;">야장테이블</h4>
            <p id="ytCount" style="font-size:1.5rem; margin:5px 0 0 0;">0</p>
          </div>
        </div>

        <!-- 시설 목록 -->
        <div class="table-container">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>시설코드</th>
                <th>카테고리</th>
                <th>시설명</th>
                <th>최대인원</th>
                <th>기본가격</th>
                <th>설명</th>
                <th>상태</th>
                <th>액션</th>
              </tr>
            </thead>
            <tbody id="catalogTable">
              <tr><td colspan="8" class="text-center">데이터를 불러오는 중...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- OSO 가용성 관리 섹션 -->
    <div id="availability-section" class="section" style="display:none;">
      <div class="availability-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>가용성 관리</h2>
          <div class="filter-controls" style="display:flex; gap:8px;">
            <input type="date" id="availabilityDateFilter" />
            <select id="availabilityCategoryFilter">
              <option value="">전체 카테고리</option>
              <option value="PR">프라이빗룸</option>
              <option value="ST">소파테이블</option>
              <option value="TN">텐트동</option>
              <option value="VP">VIP동</option>
              <option value="YT">야장테이블</option>
            </select>
            <button class="refresh-btn" onclick="loadAvailability()"><span id="availabilityRefreshText">새로고침</span></button>
          </div>
        </div>

        <!-- 시간별 가용성 그리드 -->
        <div class="availability-grid" style="margin-bottom:20px;">
          <div class="time-slots" style="display:flex; gap:10px; margin-bottom:15px;">
            <div class="time-slot-header">시설</div>
            <div class="time-slot-header">점심 (11:30-14:30)</div>
            <div class="time-slot-header">오후 (15:00-18:00)</div>
            <div class="time-slot-header">저녁 (18:30-21:30)</div>
          </div>
          <div id="availabilityGridContent">
            <div class="text-center" style="padding:20px; color:#666;">날짜를 선택하여 가용성을 확인하세요</div>
          </div>
        </div>

        <!-- 예약 통계 -->
        <div class="booking-stats" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:12px;">
          <div class="stat-card" style="background:#fff; border:1px solid #e9ecef; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#4facfe; margin:0 0 5px 0;">총 슬롯</h4>
            <p id="totalSlots" style="font-size:1.2rem; margin:0;">78</p>
          </div>
          <div class="stat-card" style="background:#fff; border:1px solid #e9ecef; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#28a745; margin:0 0 5px 0;">예약가능</h4>
            <p id="availableSlots" style="font-size:1.2rem; margin:0;">-</p>
          </div>
          <div class="stat-card" style="background:#fff; border:1px solid #e9ecef; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#ffc107; margin:0 0 5px 0;">예약됨</h4>
            <p id="bookedSlots" style="font-size:1.2rem; margin:0;">-</p>
          </div>
          <div class="stat-card" style="background:#fff; border:1px solid #e9ecef; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#dc3545; margin:0 0 5px 0;">비활성</h4>
            <p id="inactiveSlots" style="font-size:1.2rem; margin:0;">-</p>
          </div>
        </div>
      </div>
    </div>
    <!-- 메시지 관리 섹션 -->
    <div id="messages-section" class="section" style="display:none;">
      <div class="messages-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>메시지 관리</h2>
          <div class="message-controls" style="display:flex; gap:8px;">
            <select id="messageStatusFilter">
              <option value="">전체 상태</option>
              <option value="pending">발송 대기</option>
              <option value="sent">발송 완료</option>
              <option value="delivered">전달 완료</option>
              <option value="failed">발송 실패</option>
            </select>
            <select id="messageTypeFilter">
              <option value="">전체 타입</option>
              <option value="sms">SMS</option>
              <option value="email">이메일</option>
            </select>
            <button class="refresh-btn" onclick="loadMessageLogs()">새로고침</button>
            <button class="action-btn confirm" onclick="sendDailyReminders()">리마인더 발송</button>
            <button class="action-btn" onclick="retryFailedMessages()">실패 메시지 재발송</button>
          </div>
        </div>

        <!-- 메시지 통계 -->
        <div class="message-stats" style="display:grid; grid-template-columns: repeat(6, 1fr); gap:12px; margin:16px 0;">
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="totalMessages" style="font-size:1.5rem; color:#4facfe; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">전체 메시지</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="smsMessages" style="font-size:1.5rem; color:#28a745; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">SMS</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="emailMessages" style="font-size:1.5rem; color:#17a2b8; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">이메일</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="sentMessages" style="font-size:1.5rem; color:#28a745; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">발송 완료</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="failedMessages" style="font-size:1.5rem; color:#dc3545; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">발송 실패</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="pendingMessages" style="font-size:1.5rem; color:#ffc107; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">발송 대기</p>
          </div>
        </div>

        <!-- 메시지 발송 로그 테이블 -->
        <div class="table-container" style="overflow-x:auto; margin-top:16px;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background:#f8f9fa;">
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">발송 시간</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">예약번호</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">타입</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">수신자</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">템플릿</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">제목</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">상태</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">재시도</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">액션</th>
              </tr>
            </thead>
            <tbody id="messageLogsTable">
              <tr><td colspan="9" style="text-align:center; padding:16px;">데이터를 불러오는 중...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- 메시지 템플릿 관리 -->
      <div class="templates-section" style="background:#fff; border-radius:10px; padding:16px; margin-top:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>메시지 템플릿 관리</h2>
          <button class="refresh-btn" onclick="loadMessageTemplates()">새로고침</button>
        </div>

        <div class="template-list" id="templateList" style="margin-top:16px;">
          <!-- 템플릿 목록이 여기에 동적으로 추가됩니다 -->
        </div>
      </div>
    </div>

    <!-- 변경 요청 관리 섹션 -->
    <div id="modifications-section" class="section" style="display:none;">
      <div class="modifications-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>예약 변경 요청 관리</h2>
          <div class="modification-controls" style="display:flex; gap:8px;">
            <select id="modificationStatusFilter">
              <option value="">전체 상태</option>
              <option value="pending">대기 중</option>
              <option value="approved">승인됨</option>
              <option value="rejected">거부됨</option>
              <option value="completed">처리 완료</option>
            </select>
            <select id="modificationTypeFilter">
              <option value="">전체 타입</option>
              <option value="date">날짜 변경</option>
              <option value="guests">인원 변경</option>
              <option value="cancellation">예약 취소</option>
            </select>
            <button class="refresh-btn" onclick="loadModificationRequests()">새로고침</button>
          </div>
        </div>

        <!-- 변경 요청 통계 -->
        <div class="modification-stats" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:12px; margin:16px 0;">
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="totalModifications" style="font-size:1.5rem; color:#4facfe; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">전체 요청</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="pendingModifications" style="font-size:1.5rem; color:#ffc107; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">대기 중</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="approvedModifications" style="font-size:1.5rem; color:#28a745; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">승인됨</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="rejectedModifications" style="font-size:1.5rem; color:#dc3545; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">거부됨</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="completedModifications" style="font-size:1.5rem; color:#17a2b8; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">처리 완료</p>
          </div>
        </div>

        <!-- 변경 요청 테이블 -->
        <div class="table-container" style="overflow-x:auto; margin-top:16px;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background:#f8f9fa;">
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">요청 시간</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">예약번호</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">고객명</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">연락처</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">변경 타입</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">기존 정보</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">변경 요청</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">상태</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">액션</th>
              </tr>
            </thead>
            <tbody id="modificationsTable">
              <tr><td colspan="9" style="text-align:center; padding:16px;">데이터를 불러오는 중...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- 빈 상태 메시지 -->
        <div id="modificationsEmptyState" class="empty-state" style="display:none; padding:30px; text-align:center; color:#666;">
          <div class="empty-state-icon" style="font-size:2rem;">📝</div>
          <h3>변경 요청이 없습니다</h3>
          <p>고객의 예약 변경 요청이 들어오면 여기에 표시됩니다.</p>
        </div>
      </div>
    </div>

  </main>

  <!-- 변경 요청 상세 모달 -->
  <div id="modificationModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);">
    <div class="modal-content" style="background:#fff; max-width:800px; margin:40px auto; border-radius:10px; padding:20px;">
      <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3>변경 요청 상세</h3>
        <button class="modal-close" onclick="closeModificationModal()" aria-label="close">&times;</button>
      </div>
      <div id="modificationModalBody">
        <!-- 내용이 JavaScript로 동적 생성됩니다 -->
      </div>
      <div style="margin-top: 20px; text-align: right; display: flex; gap: 8px; justify-content: flex-end;">
        <button class="action-btn cancel" onclick="closeModificationModal()">닫기</button>
        <button class="action-btn" id="approveModificationBtn" onclick="processModification('approved')">승인</button>
        <button class="action-btn reject" id="rejectModificationBtn" onclick="processModification('rejected')">거부</button>
      </div>
    </div>
  </div>

  <!-- 예약 상세 모달 -->
  <div id="reservationModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);">
    <div class="modal-content" style="background:#fff; max-width:680px; margin:60px auto; border-radius:10px; padding:16px;">
      <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center;">
        <h3>예약 상세 정보</h3>
        <button class="modal-close" onclick="closeModal()" aria-label="close">&times;</button>
      </div>
      <div id="modalBody"></div>
      <div style="margin-top: 20px; text-align: right;">
        <button class="action-btn cancel" onclick="closeModal()">닫기</button>
      </div>
    </div>
  </div>

  <!-- 상태 변경 확인 모달 -->
  <div id="confirmModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); z-index: 1000;">
    <div class="modal-content" style="background:#fff; max-width:600px; margin:80px auto; border-radius:10px; padding:20px;">
      <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h3>상태 변경 확인</h3>
        <button class="modal-close" onclick="closeConfirmModal()" aria-label="close" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
      </div>
      
      <div id="confirmMessage" style="margin-bottom:20px; padding:12px; background:#f8f9fa; border-radius:6px;"></div>
      
      <!-- 관리자 입력 필드들 -->
      <div id="adminInputs" style="margin-bottom:20px;">
        <div id="cancellationReasonGroup" style="margin-bottom:16px; display:none;">
          <label for="cancellationReason" style="display:block; margin-bottom:4px; font-weight:500;">취소/삭제 사유:</label>
          <textarea id="cancellationReason" placeholder="취소 또는 삭제 사유를 입력하세요..." 
                   style="width:100%; min-height:60px; padding:8px; border:1px solid #ddd; border-radius:4px; resize:vertical;"></textarea>
        </div>
        
        <div style="margin-bottom:16px;">
          <label for="adminNotes" style="display:block; margin-bottom:4px; font-weight:500;">관리자 메모 (선택사항):</label>
          <textarea id="adminNotes" placeholder="추가 메모나 특이사항을 입력하세요..." 
                   style="width:100%; min-height:60px; padding:8px; border:1px solid #ddd; border-radius:4px; resize:vertical;"></textarea>
        </div>
      </div>
      
      <div style="text-align: right; border-top:1px solid #eee; padding-top:16px;">
        <button class="action-btn cancel" onclick="closeConfirmModal()" style="margin-right:8px;">취소</button>
        <button class="action-btn confirm" id="confirmButton">확인</button>
      </div>
    </div>
  </div>

  <!-- 알림 메시지 -->
  <div id="adminMessageContainer" class="message-container" style="display:none;">
    <div id="adminMessageContent" class="message"></div>
    <button id="closeAdminMessage" class="close-btn">×</button>
  </div>

  <!-- Scripts -->
  <script src="supabase-config-v2.js"></script>
  <script>
    // ============================
    // 관리자 인증 시스템 (Phase 2.3)
    // ============================
    
    class AdminAuthMiddleware {
      constructor() {
        this.supabaseClient = null;
        this.currentAdmin = null;
        this.sessionToken = null;
        this.isAuthenticated = false;
        this.init();
      }
      
      async init() {
        try {
          // Supabase 클라이언트 초기화
          if (typeof window.__ENV !== 'undefined') {
            this.supabaseClient = supabase.createClient(
              window.__ENV.SUPABASE_URL,
              window.__ENV.SUPABASE_ANON_KEY
            );
          } else {
            console.error('환경 설정이 로드되지 않았습니다.');
            this.redirectToLogin();
            return;
          }
          
          // 인증 상태 확인
          await this.checkAuthStatus();
          
        } catch (error) {
          console.error('관리자 인증 미들웨어 초기화 실패:', error);
          this.redirectToLogin();
        }
      }
      
      async checkAuthStatus() {
        try {
          // Supabase Auth 세션 확인
          const { data: { session }, error } = await this.supabaseClient.auth.getSession();
          
          if (error) {
            console.error('세션 확인 실패:', error);
            this.redirectToLogin();
            return;
          }
          
          if (!session || !session.user) {
            console.log('인증되지 않은 접근 시도');
            this.redirectToLogin();
            return;
          }
          
          // 관리자 권한 확인
          const isValidAdmin = await this.verifyAdminPermissions(session.user);
          
          if (!isValidAdmin) {
            console.log('관리자 권한 없음');
            await this.supabaseClient.auth.signOut();
            this.redirectToLogin();
            return;
          }
          
          // 인증 성공
          this.isAuthenticated = true;
          this.currentAdmin = session.user;
          
          // 관리자 프로필 로드
          await this.loadAdminProfile();
          
          // UI 업데이트
          this.updateAuthUI();
          
          // 활동 로그 기록
          this.logActivity('page_access', 'admin_dashboard');
          
          console.log('관리자 인증 성공:', this.currentAdmin.email);
          
        } catch (error) {
          console.error('인증 상태 확인 중 오류:', error);
          this.redirectToLogin();
        }
      }
      
      async verifyAdminPermissions(user) {
        try {
          const { data, error } = await this.supabaseClient
            .from('admin_profiles')
            .select('id, email, full_name, role, is_active, permissions')
            .eq('id', user.id)
            .eq('is_active', true)
            .single();
          
          if (error || !data) {
            console.error('관리자 프로필 조회 실패:', error);
            return false;
          }
          
          this.adminProfile = data;
          return true;
          
        } catch (error) {
          console.error('관리자 권한 확인 실패:', error);
          return false;
        }
      }
      
      async loadAdminProfile() {
        try {
          const { data, error } = await this.supabaseClient.rpc('get_admin_profile');
          
          if (error) {
            console.error('관리자 프로필 로드 실패:', error);
            return;
          }
          
          if (data && data.length > 0) {
            this.adminProfile = data[0];
          }
          
        } catch (error) {
          console.error('관리자 프로필 로드 중 오류:', error);
        }
      }
      
      updateAuthUI() {
        const adminUserInfo = document.getElementById('adminUserInfo');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const userAvatar = document.getElementById('userAvatar');
        
        if (adminUserInfo && this.adminProfile) {
          adminUserInfo.style.display = 'flex';
          
          if (userName) {
            userName.textContent = this.adminProfile.full_name || this.adminProfile.email || '관리자';
          }
          
          if (userRole) {
            const roleNames = {
              'super_admin': '최고관리자',
              'admin': '관리자',
              'viewer': '조회자'
            };
            userRole.textContent = roleNames[this.adminProfile.role] || this.adminProfile.role;
          }
          
          if (userAvatar) {
            const avatarEmojis = {
              'super_admin': '👑',
              'admin': '👤',
              'viewer': '👀'
            };
            userAvatar.textContent = avatarEmojis[this.adminProfile.role] || '👤';
          }
        }
      }
      
      hasPermission(resource, action) {
        if (!this.adminProfile || !this.adminProfile.permissions) {
          return false;
        }
        
        const resourcePermissions = this.adminProfile.permissions[resource];
        if (!resourcePermissions) {
          return false;
        }
        
        return resourcePermissions[action] === true;
      }
      
      async logActivity(actionType, resourceType = null, resourceId = null, details = {}) {
        try {
          await this.supabaseClient.rpc('log_admin_activity', {
            p_action_type: actionType,
            p_resource_type: resourceType,
            p_resource_id: resourceId,
            p_action_details: details
          });
        } catch (error) {
          console.error('활동 로그 기록 실패:', error);
        }
      }
      
      redirectToLogin() {
        console.log('로그인 페이지로 리다이렉트');
        window.location.href = 'admin-login.html';
      }
      
      async logout() {
        try {
          // 활동 로그 기록
          this.logActivity('logout', 'auth');
          
          // Supabase 로그아웃
          await this.supabaseClient.auth.signOut();
          
          // 로컬 저장소 정리
          localStorage.removeItem('admin_session');
          
          // 상태 초기화
          this.isAuthenticated = false;
          this.currentAdmin = null;
          this.adminProfile = null;
          
          // 로그인 페이지로 리다이렉트
          this.redirectToLogin();
          
        } catch (error) {
          console.error('로그아웃 중 오류:', error);
          // 오류가 있어도 로그인 페이지로 이동
          this.redirectToLogin();
        }
      }
    }
    
    // 전역 변수들
    let currentReservationId = null;
    let currentAction = null;
    let adminAuth = null;
    
    // 관리자 인증 미들웨어 초기화 및 메인 앱 로직
    document.addEventListener('DOMContentLoaded', async function () {
      // 관리자 인증 시스템 초기화
      adminAuth = new AdminAuthMiddleware();
      
      // 인증이 완료될 때까지 대기 (최대 5초)
      let attempts = 0;
      const maxAttempts = 50; // 5초 (100ms * 50)
      
      while (!adminAuth.isAuthenticated && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      
      if (!adminAuth.isAuthenticated) {
        console.error('인증 시간 초과');
        return;
      }
      
      // 인증 성공 후 메인 앱 로직 실행
      loadDashboardStats();
      loadRecentReservations();
      setupAdminEventListeners();
      // 초기 섹션 상태
      showSection('dashboard');
    });

    function setupAdminEventListeners() {
      const statusFilter = document.getElementById('statusFilter');
      const dateFilter = document.getElementById('dateFilter');
      const categoryFilter = document.getElementById('categoryFilter');
      const bookingStatusFilter = document.getElementById('bookingStatusFilter');
      const bookingDateFilter = document.getElementById('bookingDateFilter');
      const customerSearchFilter = document.getElementById('customerSearchFilter');
      const availabilityDateFilter = document.getElementById('availabilityDateFilter');
      const availabilityCategoryFilter = document.getElementById('availabilityCategoryFilter');
      const modificationStatusFilter = document.getElementById('modificationStatusFilter');
      const modificationTypeFilter = document.getElementById('modificationTypeFilter');
      const closeAdminMessage = document.getElementById('closeAdminMessage');

      if (statusFilter) statusFilter.addEventListener('change', loadReservations);
      if (dateFilter) dateFilter.addEventListener('change', loadReservations);
      if (categoryFilter) categoryFilter.addEventListener('change', loadReservations);
      if (bookingStatusFilter) bookingStatusFilter.addEventListener('change', loadBookings);
      if (bookingDateFilter) bookingDateFilter.addEventListener('change', loadBookings);
      if (customerSearchFilter) customerSearchFilter.addEventListener('input', debounce(loadBookings, 500));
      if (availabilityDateFilter) availabilityDateFilter.addEventListener('change', loadAvailability);
      if (availabilityCategoryFilter) availabilityCategoryFilter.addEventListener('change', loadAvailability);
      if (modificationStatusFilter) modificationStatusFilter.addEventListener('change', loadModificationRequests);
      if (modificationTypeFilter) modificationTypeFilter.addEventListener('change', loadModificationRequests);
      if (closeAdminMessage) closeAdminMessage.addEventListener('click', hideAdminMessage);

      window.addEventListener('click', function (event) {
        const modal = document.getElementById('reservationModal');
        const confirmModal = document.getElementById('confirmModal');
        const modificationModal = document.getElementById('modificationModal');
        if (event.target === modal) closeModal();
        if (event.target === confirmModal) closeConfirmModal();
        if (event.target === modificationModal) closeModificationModal();
      });
    }

    function showSection(sectionName) {
      document.querySelectorAll('.section').forEach((s) => (s.style.display = 'none'));
      document.querySelectorAll('.nav-btn').forEach((b) => b.classList.remove('active'));
      const target = document.getElementById(sectionName + '-section');
      if (target) target.style.display = 'block';
      const buttons = Array.from(document.querySelectorAll('.nav-btn'));
      const sectionMap = {
        'dashboard': '대시보드',
        'reservations': '예약 신청',
        'bookings': '예약 현황',
        'catalog': '시설 관리',
        'availability': '가용성 관리',
        'modifications': '변경 요청',
        'messages': '메시지 관리'
      };
      const btn = buttons.find((b) => b.textContent.includes(sectionMap[sectionName] || sectionName));
      if (btn) btn.classList.add('active');
      
      // Load section data
      if (sectionName === 'reservations') loadReservations();
      else if (sectionName === 'bookings') loadBookings();
      else if (sectionName === 'catalog') loadCatalog();
      else if (sectionName === 'availability') loadAvailability();
      else if (sectionName === 'modifications') loadModificationRequests();
      else if (sectionName === 'messages') loadMessageLogs();
    }

    async function loadDashboardStats() {
      try {
        const result = await getReservations();
        if (result.success && result.data) {
          const reservations = result.data;
          const today = new Date().toISOString().split('T')[0];
          const total = reservations.length;
          const todayCount = reservations.filter((r) => r.reservation_date === today).length;
          const pending = reservations.filter((r) => r.status === 'pending').length;
          
          // Get bookings for confirmed count
          const bookingsResult = await getBookings();
          let confirmed = 0;
          if (bookingsResult.success && bookingsResult.data) {
            confirmed = bookingsResult.data.filter((b) => b.status === 'confirmed').length;
          }
          
          document.getElementById('totalReservations').textContent = total;
          document.getElementById('todayReservations').textContent = todayCount;
          document.getElementById('pendingReservations').textContent = pending;
          document.getElementById('confirmedBookings').textContent = confirmed;
          toggleEmptyState('dashboard', total === 0);
        } else {
          document.getElementById('totalReservations').textContent = '0';
          document.getElementById('todayReservations').textContent = '0';
          document.getElementById('pendingReservations').textContent = '0';
          document.getElementById('confirmedBookings').textContent = '0';
          toggleEmptyState('dashboard', true);
        }
      } catch (err) {
        console.error('대시보드 통계 로드 오류:', err);
        document.getElementById('totalReservations').textContent = '0';
        document.getElementById('todayReservations').textContent = '0';
        document.getElementById('pendingReservations').textContent = '0';
        document.getElementById('confirmedBookings').textContent = '0';
        toggleEmptyState('dashboard', true);
      }
    }

    async function loadRecentReservations() {
      try {
        const result = await getAdminReservationsWithCustomer();
        if (result.success && result.data) {
          const recent = result.data.slice(0, 5);
          displayRecentReservations(recent);
        } else {
          displayRecentReservations([]);
        }
      } catch (err) {
        console.error('최근 예약 로드 오류:', err);
        displayRecentReservations([]);
      }
    }

    async function loadReservations() {
      const refreshBtn = document.getElementById('refreshText');
      if (refreshBtn) refreshBtn.innerHTML = '<span class="loading-spinner"></span>';
      try {
        const result = await getAdminReservationsWithCustomer();
        if (result.success && result.data) {
          let data = result.data;
          const status = document.getElementById('statusFilter')?.value;
          const date = document.getElementById('dateFilter')?.value;
          const category = document.getElementById('categoryFilter')?.value;
          
          if (status) data = data.filter((r) => r.status === status);
          if (date) data = data.filter((r) => r.reservation_date === date);
          if (category) data = data.filter((r) => r.facility_category === category);
          
          displayReservations(data);
          loadDashboardStats();
        } else {
          displayReservations([]);
        }
      } catch (err) {
        console.error('예약 목록 로드 오류:', err);
        showAdminMessage('예약 목록을 불러오는 중 오류가 발생했습니다.', 'error');
        displayReservations([]);
      } finally {
        if (refreshBtn) refreshBtn.textContent = '새로고침';
      }
    }

    async function handleProductSubmit(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      const submitBtn = form.querySelector('button[type="submit"]');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnLoader = submitBtn.querySelector('.btn-loader');

      if (!validateProductForm(form)) return;

      submitBtn.disabled = true;
      btnText.style.display = 'none';
      btnLoader.style.display = 'inline-flex';
      try {
        const productCode = (formData.get('product_code') || '').trim();
        const dup = await getProductByCode(productCode);
        if (dup.success && dup.data) throw new Error('이미 존재하는 상품코드입니다.');

        const startTime = formData.get('start_time');
        const endTime = formData.get('end_time');
        if (startTime >= endTime) throw new Error('종료 시간은 시작 시간보다 늦어야 합니다.');

        const productData = {
          product_name: (formData.get('product_name') || '').trim(),
          display_name: (formData.get('display_name') || '').trim(),
          product_code: productCode,
          product_date: formData.get('product_date'),
          start_time: startTime,
          end_time: endTime,
          price: parseInt(formData.get('product_price'), 10) || 0,
          description: (formData.get('product_description') || '').trim() || null,
          status: 'active',
          is_booked: false,
        };
        const result = await createProduct(productData);
        if (result.success) {
          showAdminMessage('상품이 성공적으로 등록되었습니다.', 'success');
          form.reset();
          loadProducts();
        } else {
          throw new Error(result.error || '상품 등록 중 오류가 발생했습니다.');
        }
      } catch (err) {
        console.error('상품 등록 오류:', err);
        showAdminMessage(err.message || '상품 등록 중 오류가 발생했습니다.', 'error');
      } finally {
        submitBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoader.style.display = 'none';
      }
    }

    function validateProductForm(form) {
      let isValid = true;
      const requiredFields = form.querySelectorAll('input[required]');
      requiredFields.forEach((f) => {
        const v = (f.value || '').trim();
        if (!v) {
          f.classList.add('error');
          isValid = false;
        } else {
          f.classList.remove('error');
        }
      });
      const priceField = form.querySelector('#product_price');
      const price = parseInt(priceField.value, 10) || 0;
      if (price < 0) {
        priceField.classList.add('error');
        isValid = false;
      }
      const codeField = form.querySelector('#product_code');
      const codePattern = /^[A-Za-z0-9-]+$/;
      if (!codePattern.test((codeField.value || '').trim())) {
        codeField.classList.add('error');
        isValid = false;
      }
      return isValid;
    }

    async function loadProducts() {
      const refreshBtn = document.getElementById('productRefreshText');
      if (refreshBtn) refreshBtn.innerHTML = '<span class="loading-spinner"></span>';
      try {
        const result = await getProducts();
        if (result.success && result.data) {
          displayProducts(result.data);
        } else {
          throw new Error(result.error || '상품 목록을 불러오지 못했습니다.');
        }
      } catch (err) {
        console.error('상품 목록 로드 오류:', err);
        showAdminMessage('상품 목록을 불러오는 중 오류가 발생했습니다.', 'error');
        displayProducts([]);
      } finally {
        if (refreshBtn) refreshBtn.textContent = '새로고침';
      }
    }

    function displayProducts(products) {
      const tbody = document.getElementById('productsTable');
      if (!tbody) return;
      if (!products || products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">상품이 없습니다.</td></tr>';
        return;
      }
      tbody.innerHTML = products
        .map((p) => `
          <tr>
            <td>${p.product_code}</td>
            <td>${p.display_name || p.product_name}</td>
            <td>${p.product_date}</td>
            <td>${(p.start_time || '')} - ${(p.end_time || '')}</td>
            <td>₩${Number(p.price || 0).toLocaleString()}</td>
            <td>${p.is_booked ? '예약됨' : (p.status || 'active')}</td>
          </tr>`)
        .join('');
    }

    function confirmReservation(reservationId) {
      currentReservationId = reservationId;
      currentAction = 'confirm';
      document.getElementById('confirmMessage').innerHTML = `
        <p>해당 예약을 <strong>확정</strong>하시겠습니까?</p>
        <p style="color:#666; font-size:.9rem; margin-top:10px;">확정 시 고객에게 알림이 발송됩니다.</p>`;
      
      // 관리자 입력 필드 표시/숨기기
      document.getElementById('adminNotesField').style.display = 'block';
      document.getElementById('cancellationReasonField').style.display = 'none';
      
      // 입력 필드 초기화
      document.getElementById('adminNotes').value = '';
      document.getElementById('cancellationReason').value = '';
      
      document.getElementById('confirmButton').onclick = executeConfirm;
      document.getElementById('confirmModal').style.display = 'block';
    }

    function cancelReservation(reservationId) {
      currentReservationId = reservationId;
      currentAction = 'cancel';
      document.getElementById('confirmMessage').innerHTML = `
        <p>해당 예약을 <strong>취소</strong>하시겠습니까?</p>
        <p style="color:#666; font-size:.9rem; margin-top:10px;">취소된 예약은 복구할 수 없습니다.</p>`;
      
      // 관리자 입력 필드 표시/숨기기
      document.getElementById('adminNotesField').style.display = 'block';
      document.getElementById('cancellationReasonField').style.display = 'block';
      
      // 입력 필드 초기화
      document.getElementById('adminNotes').value = '';
      document.getElementById('cancellationReason').value = '';
      
      document.getElementById('confirmButton').onclick = executeConfirm;
      document.getElementById('confirmModal').style.display = 'block';
    }

    function deleteReservationConfirm(reservationId) {
      currentReservationId = reservationId;
      currentAction = 'delete';
      document.getElementById('confirmMessage').innerHTML = `
        <p style="color:#dc3545;"><strong>주의:</strong> 해당 예약을 영구 <strong>삭제</strong>하시겠습니까?</p>
        <p style="color:#666; font-size:.9rem; margin-top:10px;">삭제된 예약은 복구할 수 없습니다.</p>`;
      
      // 관리자 입력 필드 표시/숨기기 (삭제는 취소와 동일하게 처리)
      document.getElementById('adminNotesField').style.display = 'block';
      document.getElementById('cancellationReasonField').style.display = 'block';
      
      // 입력 필드 초기화
      document.getElementById('adminNotes').value = '';
      document.getElementById('cancellationReason').value = '';
      
      document.getElementById('confirmButton').onclick = executeConfirm;
      document.getElementById('confirmModal').style.display = 'block';
    }

    async function executeConfirm() {
      try {
        let result;
        let message;
        
        // 관리자 메모 가져오기
        const adminNotes = document.getElementById('adminNotes')?.value || null;
        const cancellationReason = document.getElementById('cancellationReason')?.value || null;
        
        switch (currentAction) {
          case 'confirm':
            result = await adminConfirmReservation(currentReservationId, adminNotes);
            message = '예약이 확정되었습니다.';
            break;
          case 'cancel':
            result = await adminCancelReservation(currentReservationId, cancellationReason, adminNotes);
            message = '예약이 취소되었습니다.';
            break;
          case 'delete':
            const deletionReason = cancellationReason || '관리자에 의한 삭제';
            result = await adminDeleteReservation(currentReservationId, deletionReason);
            message = '예약이 삭제되었습니다.';
            break;
        }
        if (result && result.success) {
          showAdminMessage(message, 'success');
          loadReservations();
          loadDashboardStats();
        } else {
          throw new Error(result?.error || '작업 처리 중 오류가 발생했습니다.');
        }
      } catch (err) {
        console.error('작업 처리 오류:', err);
        showAdminMessage('작업 처리 중 오류가 발생했습니다.', 'error');
      } finally {
        closeConfirmModal();
      }
    }

    function closeModal() {
      const m = document.getElementById('reservationModal');
      if (m) m.style.display = 'none';
    }
    function closeConfirmModal() {
      const cm = document.getElementById('confirmModal');
      if (cm) cm.style.display = 'none';
      currentReservationId = null;
      currentAction = null;
    }

    // 예약현황(booking)
    async function loadBookings() {
      const refresh = document.getElementById('bookingRefreshText');
      if (refresh) refresh.innerHTML = '<span class="loading-spinner"></span>';
      try {
        const result = await getBookings();
        if (result.success && result.data) {
          let data = result.data;
          const status = document.getElementById('bookingStatusFilter').value;
          const date = document.getElementById('bookingDateFilter').value;
          const keyword = (document.getElementById('customerSearchFilter').value || '').trim();
          if (status) data = data.filter((b) => b.status === status);
          if (date) data = data.filter((b) => b.booking_date === date);
          if (keyword) data = data.filter((b) => (b.customer_name || '').includes(keyword));
          displayBookings(data);
        } else {
          displayBookings([]);
        }
      } catch (err) {
        console.error('예약현황 로드 오류:', err);
        showAdminMessage('예약현황을 불러오는 중 오류가 발생했습니다.', 'error');
        displayBookings([]);
      } finally {
        if (refresh) refresh.textContent = '새로고침';
      }
    }

    function displayBookings(bookings) {
      const tbody = document.getElementById('bookingsTable');
      if (!tbody) return;
      if (!bookings || bookings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center">예약현황이 없습니다.</td></tr>';
        toggleEmptyState('bookings', true);
        return;
      }
      toggleEmptyState('bookings', false);
      tbody.innerHTML = bookings
        .map(
          (b) => `
        <tr>
          <td>${b.id.substring(0, 8)}...</td>
          <td>${b.customer_name}</td>
          <td>${b.customer_phone}</td>
          <td>${b.booking_date}</td>
          <td>${b.booking_time}</td>
          <td>${b.venue_name || b.resource_name || b.product_name || '-'}</td>
          <td>${b.guest_count || 1}</td>
          <td>₩${Number(b.total_amount || 0).toLocaleString()}</td>
          <td><span class="status-badge ${b.status}">${getBookingStatusText(b.status)}</span></td>
          <td>${formatDateTime(b.created_at)}</td>
          <td>
            <div class="action-buttons">
              ${b.status === 'pending' ? `<button class="action-btn confirm" onclick="confirmBooking('${b.id}')">확정</button>` : ''}
              ${b.status !== 'cancelled' ? `<button class="action-btn cancel" onclick="cancelBooking('${b.id}')">취소</button>` : ''}
              <button class="action-btn delete" onclick="deleteBookingConfirm('${b.id}')">삭제</button>
            </div>
          </td>
        </tr>`
        )
        .join('');
    }

    function getBookingStatusText(status) {
      const map = { pending: '대기', confirmed: '확정', cancelled: '취소', completed: '완료' };
      return map[status] || status;
    }

    function confirmBooking(bookingId) {
      currentReservationId = bookingId;
      currentAction = 'confirmBooking';
      document.getElementById('confirmMessage').innerHTML = `
        <p>해당 예약을 <strong>확정</strong>하시겠습니까?</p>`;
      document.getElementById('confirmButton').onclick = executeBookingAction;
      document.getElementById('confirmModal').style.display = 'block';
    }
    function cancelBooking(bookingId) {
      currentReservationId = bookingId;
      currentAction = 'cancelBooking';
      document.getElementById('confirmMessage').innerHTML = `
        <p>해당 예약을 <strong>취소</strong>하시겠습니까?</p>`;
      document.getElementById('confirmButton').onclick = executeBookingAction;
      document.getElementById('confirmModal').style.display = 'block';
    }
    function deleteBookingConfirm(bookingId) {
      currentReservationId = bookingId;
      currentAction = 'deleteBooking';
      document.getElementById('confirmMessage').innerHTML = `
        <p style="color:#dc3545;"><strong>주의:</strong> 해당 예약현황을 영구 <strong>삭제</strong>하시겠습니까?</p>`;
      document.getElementById('confirmButton').onclick = executeBookingAction;
      document.getElementById('confirmModal').style.display = 'block';
    }
    async function executeBookingAction() {
      try {
        let result;
        let message;
        switch (currentAction) {
          case 'confirmBooking':
            result = await updateBooking(currentReservationId, { status: 'confirmed' });
            message = '예약이 확정되었습니다.';
            break;
          case 'cancelBooking':
            result = await updateBooking(currentReservationId, { status: 'cancelled' });
            message = '예약이 취소되었습니다.';
            break;
          case 'deleteBooking':
            result = await deleteBooking(currentReservationId);
            message = '예약현황이 삭제되었습니다.';
            break;
        }
        if (result && result.success) {
          showAdminMessage(message, 'success');
          loadBookings();
        } else {
          throw new Error(result?.error || '작업 처리 중 오류가 발생했습니다.');
        }
      } catch (err) {
        console.error('예약현황 작업 오류:', err);
        showAdminMessage('작업 처리 중 오류가 발생했습니다.', 'error');
      } finally {
        closeConfirmModal();
      }
    }

    // 상품 목록 전용 로드 함수
    async function loadProductList() {
      const refreshBtn = document.getElementById('productListRefreshText');
      if (refreshBtn) refreshBtn.innerHTML = '<span class="loading-spinner"></span>';
      try {
        const result = await getProducts();
        if (result.success && result.data) {
          let data = result.data;
          
          // 필터 적용
          const status = document.getElementById('productStatusFilter').value;
          const date = document.getElementById('productDateFilter').value;
          const keyword = (document.getElementById('productSearchFilter').value || '').trim();
          
          if (status) data = data.filter((p) => p.status === status);
          if (date) data = data.filter((p) => p.product_date === date);
          if (keyword) {
            data = data.filter((p) => 
              (p.product_name || '').toLowerCase().includes(keyword.toLowerCase()) ||
              (p.display_name || '').toLowerCase().includes(keyword.toLowerCase()) ||
              (p.product_code || '').toLowerCase().includes(keyword.toLowerCase())
            );
          }
          
          displayProductList(data);
        } else {
          displayProductList([]);
        }
      } catch (err) {
        console.error('상품 목록 로드 오류:', err);
        showAdminMessage('상품 목록을 불러오는 중 오류가 발생했습니다.', 'error');
        displayProductList([]);
      } finally {
        if (refreshBtn) refreshBtn.textContent = '새로고침';
      }
    }

    function displayProductList(products) {
      const tbody = document.getElementById('productListTable');
      const emptyState = document.getElementById('productListEmptyState');
      if (!tbody) return;
      
      if (!products || products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center">상품이 없습니다.</td></tr>';
        if (emptyState) emptyState.style.display = 'block';
        return;
      }
      
      if (emptyState) emptyState.style.display = 'none';
      tbody.innerHTML = products
        .map((p) => `
          <tr>
            <td><code>${p.product_code}</code></td>
            <td title="관리용 내부 상품명">${p.product_name}</td>
            <td title="고객에게 표시되는 상품명" style="font-weight:600;">${p.display_name || p.product_name}</td>
            <td>${p.product_date}</td>
            <td>${(p.start_time || '')} ~ ${(p.end_time || '')}</td>
            <td style="text-align:right; font-weight:600;">₩${Number(p.price || 0).toLocaleString()}</td>
            <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${p.description || ''}">${p.description || '-'}</td>
            <td><span class="status-badge ${p.status || 'active'}">${getProductStatusText(p.status)}</span></td>
            <td><span class="booking-status ${p.is_booked ? 'booked' : 'available'}">${p.is_booked ? '예약됨' : '예약가능'}</span></td>
            <td>${formatDateTime(p.created_at)}</td>
            <td>
              <div class="action-buttons">
                ${!p.is_booked ? `<button class="action-btn edit" onclick="editProduct('${p.id}')">수정</button>` : ''}
                ${p.status === 'active' ? `<button class="action-btn inactive" onclick="toggleProductStatus('${p.id}', 'inactive')">비활성</button>` : `<button class="action-btn active" onclick="toggleProductStatus('${p.id}', 'active')">활성화</button>`}
                ${!p.is_booked ? `<button class="action-btn delete" onclick="deleteProductConfirm('${p.id}')">삭제</button>` : ''}
              </div>
            </td>
          </tr>`)
        .join('');
    }

    function getProductStatusText(status) {
      const map = { active: '활성', inactive: '비활성', deleted: '삭제됨' };
      return map[status] || '활성';
    }

    function editProduct(productId) {
      showAdminMessage('상품 수정 기능은 준비 중입니다.', 'info');
    }

    function toggleProductStatus(productId, newStatus) {
      currentReservationId = productId;
      currentAction = 'toggleProductStatus';
      const statusText = newStatus === 'active' ? '활성화' : '비활성화';
      document.getElementById('confirmMessage').innerHTML = `
        <p>해당 상품을 <strong>${statusText}</strong>하시겠습니까?</p>`;
      document.getElementById('confirmButton').onclick = () => executeProductAction(newStatus);
      document.getElementById('confirmModal').style.display = 'block';
    }

    function deleteProductConfirm(productId) {
      currentReservationId = productId;
      currentAction = 'deleteProduct';
      document.getElementById('confirmMessage').innerHTML = `
        <p style="color:#dc3545;"><strong>주의:</strong> 해당 상품을 영구 <strong>삭제</strong>하시겠습니까?</p>
        <p style="color:#666; font-size:.9rem; margin-top:10px;">삭제된 상품은 복구할 수 없습니다.</p>`;
      document.getElementById('confirmButton').onclick = executeProductAction;
      document.getElementById('confirmModal').style.display = 'block';
    }

    async function executeProductAction(newStatus) {
      try {
        let result;
        let message;
        switch (currentAction) {
          case 'toggleProductStatus':
            result = await updateProduct(currentReservationId, { status: newStatus });
            message = newStatus === 'active' ? '상품이 활성화되었습니다.' : '상품이 비활성화되었습니다.';
            break;
          case 'deleteProduct':
            result = await deleteProduct(currentReservationId);
            message = '상품이 삭제되었습니다.';
            break;
        }
        if (result && result.success) {
          showAdminMessage(message, 'success');
          loadProductList();
          loadProducts(); // 상품 등록 페이지도 새로고침
        } else {
          throw new Error(result?.error || '작업 처리 중 오류가 발생했습니다.');
        }
      } catch (err) {
        console.error('상품 작업 오류:', err);
        showAdminMessage('작업 처리 중 오류가 발생했습니다.', 'error');
      } finally {
        closeConfirmModal();
      }
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Display functions
    function displayRecentReservations(reservations) {
      const tbody = document.getElementById('recentReservationsTable');
      if (!tbody) return;
      if (!reservations || reservations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">최근 예약이 없습니다.</td></tr>';
        return;
      }
      tbody.innerHTML = reservations
        .map((r) => `
          <tr>
            <td>${r.reservation_number || r.id?.substring(0, 8) + '...' || '-'}</td>
            <td>${r.reservation_date}</td>
            <td>${r.facility_name || r.venue_name || r.product_name || '-'}</td>
            <td>${r.time_slot || '-'}</td>
            <td>${r.customer_name || r.name}</td>
            <td>${r.customer_phone || r.phone}</td>
            <td>${r.guest_count || 1}</td>
            <td>${getAccountTypeDisplay(r.has_customer_account, r.account_type)}</td>
            <td><span class="status-badge ${r.status}">${getStatusText(r.status)}</span></td>
          </tr>`)
        .join('');
    }

    function displayReservations(reservations) {
      const tbody = document.getElementById('reservationsTable');
      if (!tbody) return;
      toggleEmptyState('reservations', !reservations || reservations.length === 0);
      if (!reservations || reservations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center">예약이 없습니다.</td></tr>';
        return;
      }
      tbody.innerHTML = reservations
        .map((r) => `
          <tr>
            <td title="ID: ${r.reservation_id}">${r.reservation_number || r.id?.substring(0, 8) + '...' || '-'}</td>
            <td>${r.reservation_date}</td>
            <td>${r.facility_name || r.venue_name || r.product_name || '-'}</td>
            <td>${r.time_slot || '-'}</td>
            <td>${r.customer_name || r.name}</td>
            <td>${r.customer_phone || r.phone}</td>
            <td>${r.customer_email || r.email || '-'}</td>
            <td>${r.guest_count || 1}</td>
            <td>${getAccountTypeDisplay(r.has_customer_account, r.account_type, r.total_reservations_count)}</td>
            <td><span class="status-badge ${r.status}">${getStatusText(r.status)}</span></td>
            <td>
              <div class="action-buttons">
                ${r.status === 'pending' ? `<button class="action-btn confirm" onclick="confirmReservation('${r.reservation_id || r.id}')">승인</button>` : ''}
                ${r.status !== 'cancelled' ? `<button class="action-btn cancel" onclick="cancelReservation('${r.reservation_id || r.id}')">취소</button>` : ''}
                <button class="action-btn delete" onclick="deleteReservationConfirm('${r.reservation_id || r.id}')">삭제</button>
              </div>
            </td>
          </tr>`)
        .join('');
    }

    function getStatusText(status) {
      const map = { pending: '대기', confirmed: '승인', cancelled: '취소', completed: '완료' };
      return map[status] || status;
    }

    function toggleEmptyState(section, isEmpty) {
      const emptyState = document.getElementById(`${section}EmptyState`);
      const table = document.querySelector(`#${section}-section .table-container`);
      if (emptyState && table) {
        emptyState.style.display = isEmpty ? 'block' : 'none';
        table.style.display = isEmpty ? 'none' : 'block';
      }
    }

    // OSO Catalog Management Functions
    async function loadCatalog() {
      const refreshBtn = document.getElementById('catalogRefreshText');
      if (refreshBtn) refreshBtn.innerHTML = '<span class="loading-spinner"></span>';
      try {
        const result = await getResourceCatalog();
        if (result.success && result.data) {
          displayCatalogStats(result.data);
          displayCatalog(result.data);
        } else {
          throw new Error(result.error || '시설 목록을 불러오지 못했습니다.');
        }
      } catch (err) {
        console.error('시설 목록 로드 오류:', err);
        showAdminMessage('시설 목록을 불러오는 중 오류가 발생했습니다.', 'error');
        displayCatalog([]);
      } finally {
        if (refreshBtn) refreshBtn.textContent = '새로고침';
      }
    }

    function displayCatalogStats(resources) {
      const stats = resources.reduce((acc, r) => {
        acc[r.category_code] = (acc[r.category_code] || 0) + 1;
        return acc;
      }, {});
      
      document.getElementById('prCount').textContent = stats.PR || 0;
      document.getElementById('stCount').textContent = stats.ST || 0;
      document.getElementById('tnCount').textContent = stats.TN || 0;
      document.getElementById('vpCount').textContent = stats.VP || 0;
      document.getElementById('ytCount').textContent = stats.YT || 0;
    }

    function displayCatalog(resources) {
      const tbody = document.getElementById('catalogTable');
      if (!tbody) return;
      if (!resources || resources.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">시설이 없습니다.</td></tr>';
        return;
      }
      
      tbody.innerHTML = resources
        .map((r) => `
          <tr>
            <td><code>${r.internal_code}</code></td>
            <td><span class="category-badge ${r.category_code.toLowerCase()}">${getCategoryName(r.category_code)}</span></td>
            <td>${r.display_name}</td>
            <td>${r.max_guests}명</td>
            <td>₩${Number(r.price || 0).toLocaleString()}</td>
            <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis;" title="${r.description || ''}">${r.description || '-'}</td>
            <td><span class="status-badge ${r.active ? 'active' : 'inactive'}">${r.active ? '활성' : '비활성'}</span></td>
            <td>
              <div class="action-buttons">
                <button class="action-btn edit" onclick="editResource('${r.internal_code}')">수정</button>
                <button class="action-btn ${r.active ? 'inactive' : 'active'}" onclick="toggleResourceStatus('${r.internal_code}', ${!r.active})">${r.active ? '비활성' : '활성화'}</button>
              </div>
            </td>
          </tr>`)
        .join('');
    }

    function getCategoryName(code) {
      const map = {
        'PR': '프라이빗룸',
        'ST': '소파테이블', 
        'TN': '텐트동',
        'VP': 'VIP동',
        'YT': '야장테이블'
      };
      return map[code] || code;
    }

    // 계정 타입 표시 함수
    function getAccountTypeDisplay(hasAccount, accountType, totalReservations = 0) {
      if (!hasAccount) {
        return '<span class="account-badge no-account">계정없음</span>';
      }
      
      if (accountType === 'login_account') {
        return `<span class="account-badge login-account" title="총 ${totalReservations}회 예약">로그인계정</span>`;
      } else if (accountType === 'simple_profile') {
        return `<span class="account-badge simple-profile" title="총 ${totalReservations}회 예약">간단프로필</span>`;
      }
      
      return '<span class="account-badge unknown">알수없음</span>';
    }

    function editResource(resourceCode) {
      showAdminMessage('시설 수정 기능은 준비 중입니다.', 'info');
    }

    function toggleResourceStatus(resourceCode, newActive) {
      showAdminMessage('시설 상태 변경 기능은 준비 중입니다.', 'info');
    }

    // OSO Availability Management Functions
    async function loadAvailability() {
      const refreshBtn = document.getElementById('availabilityRefreshText');
      const dateFilter = document.getElementById('availabilityDateFilter');
      
      if (refreshBtn) refreshBtn.innerHTML = '<span class="loading-spinner"></span>';
      
      try {
        const selectedDate = dateFilter?.value;
        if (!selectedDate) {
          document.getElementById('availabilityGridContent').innerHTML = 
            '<div class="text-center" style="padding:20px; color:#666;">날짜를 선택하여 가용성을 확인하세요</div>';
          return;
        }

        const result = await getAvailableSlots();
        if (result.success && result.data) {
          displayAvailabilityGrid(result.data, selectedDate);
          updateAvailabilityStats(result.data);
        } else {
          throw new Error(result.error || '가용성 정보를 불러오지 못했습니다.');
        }
      } catch (err) {
        console.error('가용성 로드 오류:', err);
        showAdminMessage('가용성 정보를 불러오는 중 오류가 발생했습니다.', 'error');
      } finally {
        if (refreshBtn) refreshBtn.textContent = '새로고침';
      }
    }

    function displayAvailabilityGrid(slots, selectedDate) {
      const categoryFilter = document.getElementById('availabilityCategoryFilter').value;
      let filteredSlots = slots;
      
      if (categoryFilter) {
        filteredSlots = slots.filter(slot => slot.category_code === categoryFilter);
      }
      
      // Group by resource
      const resourceGroups = filteredSlots.reduce((acc, slot) => {
        if (!acc[slot.resource_code]) {
          acc[slot.resource_code] = {
            name: slot.display_name,
            category: slot.category_code,
            slots: {}
          };
        }
        acc[slot.resource_code].slots[slot.time_slot] = slot;
        return acc;
      }, {});
      
      const gridContent = Object.entries(resourceGroups)
        .map(([resourceCode, resource]) => {
          const timeSlots = ['lunch', 'afternoon', 'dinner'];
          return `
            <div class="availability-row" style="display:flex; gap:10px; margin-bottom:8px; align-items:center;">
              <div class="resource-name" style="width:150px; font-weight:500;">
                <span class="category-badge ${resource.category.toLowerCase()}" style="margin-right:5px;">${getCategoryName(resource.category)}</span>
                ${resource.name}
              </div>
              ${timeSlots.map(timeSlot => {
                const slot = resource.slots[timeSlot];
                const isAvailable = slot && slot.active && !slot.is_booked;
                return `
                  <div class="time-slot-status ${isAvailable ? 'available' : 'unavailable'}" 
                       style="flex:1; padding:8px; text-align:center; border-radius:4px; border:1px solid #ddd; 
                              background:${isAvailable ? '#e8f5e8' : '#f8f9fa'}; color:${isAvailable ? '#155724' : '#6c757d'};">
                    ${isAvailable ? '예약가능' : (slot?.is_booked ? '예약됨' : '비활성')}
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }).join('');
      
      document.getElementById('availabilityGridContent').innerHTML = 
        gridContent || '<div class="text-center" style="padding:20px; color:#666;">해당 조건에 맞는 시설이 없습니다.</div>';
    }

    function updateAvailabilityStats(slots) {
      const total = slots.length;
      const available = slots.filter(s => s.active && !s.is_booked).length;
      const booked = slots.filter(s => s.is_booked).length;
      const inactive = slots.filter(s => !s.active).length;
      
      document.getElementById('totalSlots').textContent = total;
      document.getElementById('availableSlots').textContent = available;
      document.getElementById('bookedSlots').textContent = booked;
      document.getElementById('inactiveSlots').textContent = inactive;
    }

    // Utility functions
    function showAdminMessage(message, type = 'info') {
      const container = document.getElementById('adminMessageContainer');
      const content = document.getElementById('adminMessageContent');
      if (container && content) {
        content.textContent = message;
        container.className = `message-container show ${type}`;
        container.style.display = 'block';
        setTimeout(() => hideAdminMessage(), 5000);
      }
    }

    function hideAdminMessage() {
      const container = document.getElementById('adminMessageContainer');
      if (container) {
        container.style.display = 'none';
        container.className = 'message-container';
      }
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', {hour12: false});
    }

    // Phase 3.1: 실시간 알림 시스템 초기화
    class NotificationUI {
      constructor() {
        this.notificationSystem = null;
        this.isInitialized = false;
        this.unreadCount = 0;
      }

      async initialize() {
        if (this.isInitialized) return;
        
        try {
          // Supabase 설정 확인
          if (!window.supabase || !window.RealtimeNotificationSystem) {
            console.warn('Supabase 또는 RealtimeNotificationSystem이 로드되지 않았습니다.');
            return;
          }

          // 실시간 알림 시스템 초기화
          this.notificationSystem = new RealtimeNotificationSystem();
          await this.notificationSystem.initialize();

          // UI 이벤트 리스너 설정
          this.setupEventListeners();
          
          // 기존 알림 로드
          await this.loadExistingNotifications();
          
          this.isInitialized = true;
          console.log('NotificationUI initialized successfully');
        } catch (error) {
          console.error('NotificationUI 초기화 실패:', error);
        }
      }

      setupEventListeners() {
        // 알림 드롭다운 토글
        const notificationBell = document.getElementById('notificationBell');
        const notificationDropdown = document.getElementById('notificationDropdown');
        
        if (notificationBell && notificationDropdown) {
          notificationBell.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleNotificationDropdown();
          });
        }

        // 모든 알림 읽음 처리
        const markAllReadBtn = document.getElementById('markAllReadBtn');
        if (markAllReadBtn) {
          markAllReadBtn.addEventListener('click', () => {
            this.markAllNotificationsAsRead();
          });
        }

        // 문서 클릭 시 드롭다운 닫기
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.notification-dropdown') && !e.target.closest('#notificationBell')) {
            this.hideNotificationDropdown();
          }
        });

        // 실시간 알림 이벤트 리스너
        if (this.notificationSystem) {
          this.notificationSystem.on('notification', (notification) => {
            this.handleNewNotification(notification);
          });
        }
      }

      toggleNotificationDropdown() {
        const dropdown = document.getElementById('notificationDropdown');
        if (dropdown) {
          const isVisible = dropdown.style.display === 'block';
          dropdown.style.display = isVisible ? 'none' : 'block';
          
          if (!isVisible) {
            this.loadExistingNotifications();
          }
        }
      }

      hideNotificationDropdown() {
        const dropdown = document.getElementById('notificationDropdown');
        if (dropdown) {
          dropdown.style.display = 'none';
        }
      }

      async loadExistingNotifications() {
        if (!this.notificationSystem) return;

        try {
          const notifications = await this.notificationSystem.getAdminNotifications(20);
          this.renderNotifications(notifications);
          this.updateNotificationBadge(notifications.filter(n => !n.is_read).length);
        } catch (error) {
          console.error('기존 알림 로드 실패:', error);
        }
      }

      renderNotifications(notifications) {
        const list = document.getElementById('notificationList');
        if (!list) return;

        if (notifications.length === 0) {
          list.innerHTML = '<div class="notification-empty">새로운 알림이 없습니다</div>';
          return;
        }

        list.innerHTML = notifications.map(notification => `
          <div class="notification-item ${notification.is_read ? 'read' : 'unread'}" 
               data-id="${notification.id}">
            <div class="notification-header">
              <span class="notification-title">${notification.title}</span>
              <span class="notification-time">${this.formatTimeAgo(notification.created_at)}</span>
            </div>
            <div class="notification-message">${notification.message}</div>
            ${notification.reservation_number ? 
              `<div class="notification-meta">예약번호: ${notification.reservation_number}</div>` : ''}
          </div>
        `).join('');

        // 개별 알림 클릭 이벤트
        list.querySelectorAll('.notification-item').forEach(item => {
          item.addEventListener('click', () => {
            const notificationId = item.dataset.id;
            this.markNotificationAsRead(notificationId);
            
            // 예약번호가 있는 경우 해당 예약으로 이동
            const reservationNumber = item.querySelector('.notification-meta')?.textContent?.replace('예약번호: ', '');
            if (reservationNumber) {
              this.navigateToReservation(reservationNumber);
            }
          });
        });
      }

      async markNotificationAsRead(notificationId) {
        if (!this.notificationSystem) return;

        try {
          await this.notificationSystem.markNotificationAsRead(notificationId);
          
          // UI 업데이트
          const item = document.querySelector(`[data-id="${notificationId}"]`);
          if (item) {
            item.classList.remove('unread');
            item.classList.add('read');
          }
          
          // 배지 업데이트
          this.unreadCount = Math.max(0, this.unreadCount - 1);
          this.updateNotificationBadge(this.unreadCount);
        } catch (error) {
          console.error('알림 읽음 처리 실패:', error);
        }
      }

      async markAllNotificationsAsRead() {
        const unreadItems = document.querySelectorAll('.notification-item.unread');
        const promises = Array.from(unreadItems).map(item => 
          this.markNotificationAsRead(item.dataset.id)
        );
        
        await Promise.all(promises);
        this.updateNotificationBadge(0);
      }

      handleNewNotification(notification) {
        // 토스트 알림 표시
        if (this.notificationSystem) {
          this.notificationSystem.showToast(notification.title, notification.message, {
            type: notification.priority === 'high' ? 'success' : 'info',
            duration: 5000
          });
        }

        // 배지 카운트 업데이트
        this.unreadCount++;
        this.updateNotificationBadge(this.unreadCount);

        // 드롭다운이 열려있다면 알림 목록 새로고침
        const dropdown = document.getElementById('notificationDropdown');
        if (dropdown && dropdown.style.display === 'block') {
          this.loadExistingNotifications();
        }
      }

      updateNotificationBadge(count) {
        const badge = document.getElementById('notificationBadge');
        if (badge) {
          if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = 'flex';
          } else {
            badge.style.display = 'none';
          }
        }
      }

      navigateToReservation(reservationNumber) {
        // 예약 검색 기능이 있다면 해당 예약으로 이동
        // 현재는 간단히 알림만 표시
        showAdminMessage(`예약번호 ${reservationNumber}을(를) 확인하세요.`, 'info');
        this.hideNotificationDropdown();
      }

      formatTimeAgo(dateStr) {
        const now = new Date();
        const date = new Date(dateStr);
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffMins < 1) return '방금 전';
        if (diffMins < 60) return `${diffMins}분 전`;
        if (diffHours < 24) return `${diffHours}시간 전`;
        if (diffDays < 7) return `${diffDays}일 전`;
        
        return date.toLocaleDateString('ko-KR');
      }
    }

    // 전역 알림 UI 인스턴스
    let globalNotificationUI = null;

    // Phase 3.2: 메시지 관리 시스템
    let messageStatsData = {};

    // 메시지 로그 로드
    async function loadMessageLogs() {
      const statusFilter = document.getElementById('messageStatusFilter')?.value || null;
      const typeFilter = document.getElementById('messageTypeFilter')?.value || null;
      
      try {
        const logs = await getMessageLogs(100, statusFilter, typeFilter);
        const stats = await getMessageStats();
        
        renderMessageLogs(logs);
        updateMessageStats(stats);
        messageStatsData = stats;
        
      } catch (error) {
        console.error('메시지 로그 로드 실패:', error);
        showAdminMessage('메시지 로그 로드 중 오류가 발생했습니다.', 'error');
      }
    }

    // 메시지 로그 테이블 렌더링
    function renderMessageLogs(logs) {
      const tbody = document.getElementById('messageLogsTable');
      if (!tbody) return;

      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:16px;">메시지 로그가 없습니다</td></tr>';
        return;
      }

      tbody.innerHTML = logs.map(log => `
        <tr>
          <td style="padding:8px; border:1px solid #dee2e6;">
            ${formatDateTime(log.created_at)}
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;">
            ${log.reservation_number || '-'}
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;">
            <span class="message-type-badge ${log.message_type}">
              ${log.message_type.toUpperCase()}
            </span>
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;">
            ${log.recipient_phone || log.recipient_email || '-'}
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;">
            ${log.template_code || '-'}
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;" title="${log.subject || ''}">
            ${truncateText(log.subject || '-', 30)}
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;">
            <span class="status-badge ${log.status}">
              ${getStatusText(log.status)}
            </span>
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;">
            ${log.retry_count || 0}
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;">
            ${log.status === 'failed' ? 
              `<button class="action-btn" onclick="retryMessage('${log.id}')">재발송</button>` : 
              '-'
            }
            <button class="action-btn" onclick="viewMessageDetails('${log.id}')">상세</button>
          </td>
        </tr>
      `).join('');
    }

    // 메시지 통계 업데이트
    function updateMessageStats(stats) {
      document.getElementById('totalMessages').textContent = stats.total || 0;
      document.getElementById('smsMessages').textContent = stats.sms || 0;
      document.getElementById('emailMessages').textContent = stats.email || 0;
      document.getElementById('sentMessages').textContent = stats.sent || 0;
      document.getElementById('failedMessages').textContent = stats.failed || 0;
      document.getElementById('pendingMessages').textContent = stats.pending || 0;
    }

    // 메시지 템플릿 로드
    async function loadMessageTemplates() {
      try {
        const templates = await getMessageTemplates();
        renderMessageTemplates(templates);
      } catch (error) {
        console.error('템플릿 로드 실패:', error);
        showAdminMessage('템플릿 로드 중 오류가 발생했습니다.', 'error');
      }
    }

    // 메시지 템플릿 렌더링
    function renderMessageTemplates(templates) {
      const container = document.getElementById('templateList');
      if (!container) return;

      if (templates.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:16px;">등록된 템플릿이 없습니다</p>';
        return;
      }

      container.innerHTML = templates.map(template => `
        <div class="template-card" style="background:#f8f9fa; border-radius:8px; padding:16px; margin-bottom:12px;">
          <div class="template-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h4 style="margin:0;">${template.template_name}</h4>
            <div>
              <span class="message-type-badge ${template.message_type}">${template.message_type.toUpperCase()}</span>
              <button class="action-btn" onclick="editTemplate('${template.template_code}')">편집</button>
            </div>
          </div>
          <div class="template-content">
            <p><strong>코드:</strong> ${template.template_code}</p>
            ${template.subject ? `<p><strong>제목:</strong> ${template.subject}</p>` : ''}
            <p><strong>내용:</strong></p>
            <div style="background:#fff; padding:12px; border-radius:4px; white-space:pre-wrap; max-height:100px; overflow-y:auto;">
              ${template.content}
            </div>
          </div>
        </div>
      `).join('');
    }

    // 일일 리마인더 발송
    async function sendDailyReminders() {
      try {
        const count = await sendDailyReminders();
        showAdminMessage(`${count}건의 리마인더를 발송했습니다.`, 'success');
        await loadMessageLogs(); // 로그 새로고침
      } catch (error) {
        console.error('리마인더 발송 실패:', error);
        showAdminMessage('리마인더 발송 중 오류가 발생했습니다.', 'error');
      }
    }

    // 실패한 메시지 재발송
    async function retryFailedMessages() {
      try {
        const count = await retryFailedMessages();
        showAdminMessage(`${count}건의 메시지를 재발송했습니다.`, 'success');
        await loadMessageLogs(); // 로그 새로고침
      } catch (error) {
        console.error('메시지 재발송 실패:', error);
        showAdminMessage('메시지 재발송 중 오류가 발생했습니다.', 'error');
      }
    }

    // 개별 메시지 재발송
    async function retryMessage(logId) {
      try {
        // 재발송 로직 구현 (필요시)
        showAdminMessage('메시지를 재발송했습니다.', 'success');
        await loadMessageLogs(); // 로그 새로고침
      } catch (error) {
        console.error('메시지 재발송 실패:', error);
        showAdminMessage('메시지 재발송 중 오류가 발생했습니다.', 'error');
      }
    }

    // 메시지 상세 보기
    function viewMessageDetails(logId) {
      // 상세 보기 모달 구현 (필요시)
      showAdminMessage('메시지 상세 기능은 향후 구현됩니다.', 'info');
    }

    // 템플릿 편집
    function editTemplate(templateCode) {
      // 템플릿 편집 모달 구현 (필요시)
      showAdminMessage('템플릿 편집 기능은 향후 구현됩니다.', 'info');
    }

    // 상태 텍스트 변환
    function getStatusText(status) {
      const statusMap = {
        pending: '발송 대기',
        sent: '발송 완료',
        delivered: '전달 완료',
        failed: '발송 실패'
      };
      return statusMap[status] || status;
    }

    // 텍스트 자르기 유틸리티
    function truncateText(text, maxLength) {
      if (!text) return '';
      return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    // 필터 이벤트 리스너 설정
    document.addEventListener('DOMContentLoaded', function() {
      const statusFilter = document.getElementById('messageStatusFilter');
      const typeFilter = document.getElementById('messageTypeFilter');
      
      if (statusFilter) {
        statusFilter.addEventListener('change', loadMessageLogs);
      }
      if (typeFilter) {
        typeFilter.addEventListener('change', loadMessageLogs);
      }
    });

    // ====================
    // 변경 요청 관리 기능
    // ====================

    let currentModificationRequest = null;

    // 변경 요청 목록 로드
    async function loadModificationRequests() {
      try {
        const statusFilter = document.getElementById('modificationStatusFilter')?.value || '';
        const typeFilter = document.getElementById('modificationTypeFilter')?.value || '';
        
        const result = await getModificationRequests({
          status: statusFilter,
          modification_type: typeFilter
        });

        if (result.success && result.data) {
          displayModificationRequests(result.data);
          updateModificationStats(result.data);
        } else {
          console.error('변경 요청 로드 실패:', result.error);
          showEmptyModificationState();
        }
      } catch (error) {
        console.error('변경 요청 로드 중 오류:', error);
        showEmptyModificationState();
      }
    }

    // 변경 요청 목록 표시
    function displayModificationRequests(requests) {
      const tbody = document.getElementById('modificationsTable');
      const emptyState = document.getElementById('modificationsEmptyState');
      
      if (!requests || requests.length === 0) {
        showEmptyModificationState();
        return;
      }

      emptyState.style.display = 'none';
      
      tbody.innerHTML = requests.map(request => {
        const statusBadge = getModificationStatusBadge(request.status);
        const typeBadge = getModificationTypeBadge(request.modification_type);
        
        return `
          <tr>
            <td style="padding:8px; border:1px solid #dee2e6;">
              ${formatDateTime(request.created_at)}
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              <strong>${request.reservation_number}</strong>
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              ${request.customer_name}
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              ${request.customer_phone}
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              ${typeBadge}
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              <div class="original-info">
                ${formatOriginalInfo(request)}
              </div>
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              <div class="requested-info">
                ${formatRequestedInfo(request)}
              </div>
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              ${statusBadge}
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              <button class="action-btn small" onclick="showModificationDetails('${request.id}')">
                상세보기
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // 변경 요청 통계 업데이트
    function updateModificationStats(requests) {
      const total = requests.length;
      const pending = requests.filter(r => r.status === 'pending').length;
      const approved = requests.filter(r => r.status === 'approved').length;
      const rejected = requests.filter(r => r.status === 'rejected').length;
      const completed = requests.filter(r => r.status === 'completed').length;

      document.getElementById('totalModifications').textContent = total;
      document.getElementById('pendingModifications').textContent = pending;
      document.getElementById('approvedModifications').textContent = approved;
      document.getElementById('rejectedModifications').textContent = rejected;
      document.getElementById('completedModifications').textContent = completed;
    }

    // 빈 상태 표시
    function showEmptyModificationState() {
      const tbody = document.getElementById('modificationsTable');
      const emptyState = document.getElementById('modificationsEmptyState');
      
      tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:16px;">변경 요청이 없습니다.</td></tr>';
      emptyState.style.display = 'block';
    }

    // 변경 요청 상세 모달 표시
    async function showModificationDetails(modificationId) {
      try {
        const result = await getModificationRequestById(modificationId);
        
        if (result.success && result.data) {
          currentModificationRequest = result.data;
          displayModificationModal(result.data);
        } else {
          showAdminMessage('변경 요청 정보를 불러올 수 없습니다.', 'error');
        }
      } catch (error) {
        console.error('변경 요청 상세 조회 중 오류:', error);
        showAdminMessage('변경 요청 정보를 불러오는 중 오류가 발생했습니다.', 'error');
      }
    }

    // 변경 요청 모달 표시
    function displayModificationModal(request) {
      const modalBody = document.getElementById('modificationModalBody');
      const approveBtn = document.getElementById('approveModificationBtn');
      const rejectBtn = document.getElementById('rejectModificationBtn');

      // 상태에 따라 버튼 표시/숨김
      if (request.status !== 'pending') {
        approveBtn.style.display = 'none';
        rejectBtn.style.display = 'none';
      } else {
        approveBtn.style.display = 'inline-block';
        rejectBtn.style.display = 'inline-block';
      }

      modalBody.innerHTML = `
        <div class="modification-details">
          <div class="detail-section">
            <h4>기본 정보</h4>
            <div class="detail-grid">
              <div class="detail-item">
                <label>예약번호:</label>
                <span>${request.reservation_number}</span>
              </div>
              <div class="detail-item">
                <label>고객명:</label>
                <span>${request.customer_name}</span>
              </div>
              <div class="detail-item">
                <label>연락처:</label>
                <span>${request.customer_phone}</span>
              </div>
              <div class="detail-item">
                <label>요청 시간:</label>
                <span>${formatDateTime(request.created_at)}</span>
              </div>
            </div>
          </div>

          <div class="detail-section">
            <h4>변경 요청 내용</h4>
            <div class="modification-comparison">
              <div class="before-after">
                <div class="before">
                  <h5>기존 정보</h5>
                  ${formatDetailedOriginalInfo(request)}
                </div>
                <div class="after">
                  <h5>변경 요청</h5>
                  ${formatDetailedRequestedInfo(request)}
                </div>
              </div>
            </div>
          </div>

          ${request.reason ? `
            <div class="detail-section">
              <h4>변경 사유</h4>
              <p class="reason-text">${request.reason}</p>
            </div>
          ` : ''}

          ${request.modification_type === 'cancellation' ? `
            <div class="detail-section">
              <h4>환불 정보</h4>
              <div class="refund-details">
                <div class="refund-item">
                  <label>원래 금액:</label>
                  <span>${formatPrice(request.original_data?.total_price || 0)}원</span>
                </div>
                <div class="refund-item">
                  <label>환불율:</label>
                  <span>${request.refund_rate || 0}%</span>
                </div>
                <div class="refund-item">
                  <label>예상 환불 금액:</label>
                  <span class="refund-amount">${formatPrice(request.refund_amount || 0)}원</span>
                </div>
              </div>
            </div>
          ` : ''}

          <div class="detail-section">
            <h4>처리 상태</h4>
            <div class="status-info">
              <span class="status-badge ${request.status}">${getStatusText(request.status)}</span>
              ${request.processed_at ? `<span class="processed-time">처리 시간: ${formatDateTime(request.processed_at)}</span>` : ''}
            </div>
          </div>
        </div>
      `;

      document.getElementById('modificationModal').style.display = 'block';
    }

    // 변경 요청 처리 (승인/거부)
    async function processModification(action) {
      if (!currentModificationRequest) return;

      const actionText = action === 'approved' ? '승인' : '거부';
      
      if (!confirm(`이 변경 요청을 ${actionText}하시겠습니까?`)) {
        return;
      }

      try {
        const result = await processModificationRequest(currentModificationRequest.id, action);

        if (result.success) {
          showAdminMessage(`변경 요청이 ${actionText}되었습니다.`, 'success');
          closeModificationModal();
          loadModificationRequests(); // 목록 새로고침
        } else {
          showAdminMessage(`변경 요청 ${actionText} 중 오류가 발생했습니다: ${result.error}`, 'error');
        }
      } catch (error) {
        console.error(`변경 요청 ${actionText} 중 오류:`, error);
        showAdminMessage(`변경 요청 ${actionText} 중 오류가 발생했습니다.`, 'error');
      }
    }

    // 변경 요청 모달 닫기
    function closeModificationModal() {
      document.getElementById('modificationModal').style.display = 'none';
      currentModificationRequest = null;
    }

    // 유틸리티 함수들
    function getModificationStatusBadge(status) {
      const statusMap = {
        'pending': { text: '대기 중', class: 'warning' },
        'approved': { text: '승인됨', class: 'success' },
        'rejected': { text: '거부됨', class: 'danger' },
        'completed': { text: '처리 완료', class: 'info' }
      };
      
      const statusInfo = statusMap[status] || { text: status, class: 'secondary' };
      return `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
    }

    function getModificationTypeBadge(type) {
      const typeMap = {
        'date': { text: '날짜 변경', class: 'info' },
        'guests': { text: '인원 변경', class: 'warning' },
        'cancellation': { text: '예약 취소', class: 'danger' }
      };
      
      const typeInfo = typeMap[type] || { text: type, class: 'secondary' };
      return `<span class="type-badge ${typeInfo.class}">${typeInfo.text}</span>`;
    }

    function formatOriginalInfo(request) {
      if (request.modification_type === 'date') {
        return `${formatDate(request.original_data?.reservation_date)} ${request.original_data?.time_slot}`;
      } else if (request.modification_type === 'guests') {
        return `${request.original_data?.guest_count}명`;
      } else if (request.modification_type === 'cancellation') {
        return `${formatPrice(request.original_data?.total_price || 0)}원`;
      }
      return '-';
    }

    function formatRequestedInfo(request) {
      if (request.modification_type === 'date') {
        return `${formatDate(request.new_data?.reservation_date)} ${request.new_data?.time_slot}`;
      } else if (request.modification_type === 'guests') {
        return `${request.new_data?.guest_count}명`;
      } else if (request.modification_type === 'cancellation') {
        return `환불: ${formatPrice(request.refund_amount || 0)}원`;
      }
      return '-';
    }

    function formatDetailedOriginalInfo(request) {
      if (request.modification_type === 'date') {
        return `
          <div class="info-item">
            <label>예약일:</label>
            <span>${formatDate(request.original_data?.reservation_date)}</span>
          </div>
          <div class="info-item">
            <label>시간:</label>
            <span>${request.original_data?.time_slot}</span>
          </div>
        `;
      } else if (request.modification_type === 'guests') {
        return `
          <div class="info-item">
            <label>인원:</label>
            <span>${request.original_data?.guest_count}명</span>
          </div>
          <div class="info-item">
            <label>총 금액:</label>
            <span>${formatPrice(request.original_data?.total_price || 0)}원</span>
          </div>
        `;
      } else if (request.modification_type === 'cancellation') {
        return `
          <div class="info-item">
            <label>예약일:</label>
            <span>${formatDate(request.original_data?.reservation_date)}</span>
          </div>
          <div class="info-item">
            <label>결제 금액:</label>
            <span>${formatPrice(request.original_data?.total_price || 0)}원</span>
          </div>
        `;
      }
      return '-';
    }

    function formatDetailedRequestedInfo(request) {
      if (request.modification_type === 'date') {
        return `
          <div class="info-item">
            <label>새 예약일:</label>
            <span>${formatDate(request.new_data?.reservation_date)}</span>
          </div>
          <div class="info-item">
            <label>새 시간:</label>
            <span>${request.new_data?.time_slot}</span>
          </div>
        `;
      } else if (request.modification_type === 'guests') {
        const priceDiff = (request.new_data?.total_price || 0) - (request.original_data?.total_price || 0);
        return `
          <div class="info-item">
            <label>새 인원:</label>
            <span>${request.new_data?.guest_count}명</span>
          </div>
          <div class="info-item">
            <label>새 금액:</label>
            <span>${formatPrice(request.new_data?.total_price || 0)}원</span>
          </div>
          <div class="info-item">
            <label>차액:</label>
            <span class="${priceDiff >= 0 ? 'positive' : 'negative'}">${priceDiff >= 0 ? '+' : ''}${formatPrice(priceDiff)}원</span>
          </div>
        `;
      } else if (request.modification_type === 'cancellation') {
        return `
          <div class="info-item">
            <label>취소 요청:</label>
            <span>전체 예약 취소</span>
          </div>
          <div class="info-item">
            <label>환불 금액:</label>
            <span class="refund-amount">${formatPrice(request.refund_amount || 0)}원</span>
          </div>
        `;
      }
      return '-';
    }

    // ============================
    // 관리자 UI 함수들 (Phase 2.3)
    // ============================
    
    // 사용자 메뉴 토글
    function toggleUserMenu() {
      const dropdown = document.getElementById('userMenuDropdown');
      const isVisible = dropdown.style.display === 'block';
      
      // 모든 드롭다운 닫기
      document.querySelectorAll('.user-menu-dropdown').forEach(d => {
        d.style.display = 'none';
      });
      
      // 현재 드롭다운 토글
      if (!isVisible) {
        dropdown.style.display = 'block';
      }
    }
    
    // 관리자 프로필 보기
    function showProfile() {
      if (!adminAuth || !adminAuth.adminProfile) {
        showAdminMessage('프로필 정보를 불러올 수 없습니다.', 'error');
        return;
      }
      
      const profile = adminAuth.adminProfile;
      const profileHtml = `
        <div class="profile-info">
          <h3>관리자 프로필</h3>
          <div class="profile-details">
            <div class="profile-item">
              <label>이메일:</label>
              <span>${profile.email}</span>
            </div>
            <div class="profile-item">
              <label>이름:</label>
              <span>${profile.full_name || '설정되지 않음'}</span>
            </div>
            <div class="profile-item">
              <label>역할:</label>
              <span class="role-badge ${profile.role}">${getRoleDisplayName(profile.role)}</span>
            </div>
            <div class="profile-item">
              <label>마지막 로그인:</label>
              <span>${profile.last_login_at ? formatDateTime(profile.last_login_at) : '정보 없음'}</span>
            </div>
            <div class="profile-item">
              <label>계정 생성일:</label>
              <span>${formatDateTime(profile.created_at)}</span>
            </div>
          </div>
          <div class="profile-permissions">
            <h4>권한 정보</h4>
            <div class="permissions-grid">
              ${Object.entries(profile.permissions || {}).map(([resource, perms]) => `
                <div class="permission-item">
                  <div class="permission-resource">${getResourceDisplayName(resource)}</div>
                  <div class="permission-actions">
                    ${perms.read ? '<span class="perm-badge read">조회</span>' : ''}
                    ${perms.write ? '<span class="perm-badge write">수정</span>' : ''}
                    ${perms.delete ? '<span class="perm-badge delete">삭제</span>' : ''}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      
      // 모달로 표시
      showProfileModal(profileHtml);
      closeUserMenu();
    }
    
    // 활동 로그 보기  
    async function showActivityLog() {
      try {
        if (!adminAuth || !adminAuth.isAuthenticated) {
          showAdminMessage('인증이 필요합니다.', 'error');
          return;
        }
        
        // 최근 활동 로그 조회
        const { data, error } = await adminAuth.supabaseClient
          .from('admin_activity_logs')
          .select('*')
          .eq('admin_id', adminAuth.currentAdmin.id)
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) {
          throw error;
        }
        
        const logHtml = `
          <div class="activity-log">
            <h3>내 활동 로그</h3>
            <div class="log-list">
              ${data && data.length > 0 ? data.map(log => `
                <div class="log-item ${log.success ? 'success' : 'error'}">
                  <div class="log-header">
                    <span class="log-action">${getActionDisplayName(log.action_type)}</span>
                    <span class="log-time">${formatDateTime(log.created_at)}</span>
                  </div>
                  ${log.resource_type ? `<div class="log-resource">${getResourceDisplayName(log.resource_type)}</div>` : ''}
                  ${log.error_message ? `<div class="log-error">${log.error_message}</div>` : ''}
                </div>
              `).join('') : '<div class="no-logs">활동 기록이 없습니다.</div>'}
            </div>
          </div>
        `;
        
        showProfileModal(logHtml);
        closeUserMenu();
        
      } catch (error) {
        console.error('활동 로그 조회 실패:', error);
        showAdminMessage('활동 로그를 불러올 수 없습니다.', 'error');
      }
    }
    
    // 로그아웃 처리
    async function handleLogout() {
      if (!confirm('정말 로그아웃하시겠습니까?')) {
        return;
      }
      
      try {
        if (adminAuth) {
          await adminAuth.logout();
        } else {
          // 인증 시스템이 없을 경우 직접 처리
          window.location.href = 'admin-login.html';
        }
      } catch (error) {
        console.error('로그아웃 실패:', error);
        // 오류가 있어도 로그인 페이지로 이동
        window.location.href = 'admin-login.html';
      }
    }
    
    // 사용자 메뉴 닫기
    function closeUserMenu() {
      const dropdown = document.getElementById('userMenuDropdown');
      if (dropdown) {
        dropdown.style.display = 'none';
      }
    }
    
    // 프로필 모달 표시
    function showProfileModal(content) {
      // 기존 모달이 있다면 제거
      const existingModal = document.getElementById('profileModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // 새 모달 생성
      const modal = document.createElement('div');
      modal.id = 'profileModal';
      modal.className = 'modal';
      modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <button class="modal-close" onclick="closeProfileModal()" aria-label="close">&times;</button>
          </div>
          <div class="modal-body">
            ${content}
          </div>
          <div class="modal-footer">
            <button class="action-btn cancel" onclick="closeProfileModal()">닫기</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // 모달 외부 클릭 시 닫기
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeProfileModal();
        }
      });
    }
    
    // 프로필 모달 닫기
    function closeProfileModal() {
      const modal = document.getElementById('profileModal');
      if (modal) {
        modal.remove();
      }
    }
    
    // 유틸리티 함수들
    function getRoleDisplayName(role) {
      const roleNames = {
        'super_admin': '최고관리자',
        'admin': '관리자',
        'viewer': '조회자'
      };
      return roleNames[role] || role;
    }
    
    function getResourceDisplayName(resource) {
      const resourceNames = {
        'reservations': '예약 신청',
        'bookings': '예약 현황',
        'catalog': '시설 관리',
        'availability': '가용성 관리',
        'modifications': '변경 요청',
        'messages': '메시지 관리',
        'users': '사용자 관리',
        'auth': '인증',
        'admin_dashboard': '관리자 대시보드'
      };
      return resourceNames[resource] || resource;
    }
    
    function getActionDisplayName(action) {
      const actionNames = {
        'login': '로그인',
        'logout': '로그아웃',
        'page_access': '페이지 접근',
        'create': '생성',
        'update': '수정',
        'delete': '삭제',
        'view': '조회'
      };
      return actionNames[action] || action;
    }
    
    // 외부 클릭 시 메뉴 닫기
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.admin-user-info')) {
        closeUserMenu();
      }
    });

    // DOM이 로드된 후 시스템 초기화
    document.addEventListener('DOMContentLoaded', async function() {
      // 기존 초기화 코드 실행
      await loadProducts();
      loadReservations();
      
      // 알림 시스템 초기화 (약간의 지연 후)
      setTimeout(async () => {
        try {
          globalNotificationUI = new NotificationUI();
          await globalNotificationUI.initialize();
        } catch (error) {
          console.error('알림 시스템 초기화 중 오류:', error);
        }
      }, 1000);
    });
  </script>
</body>
</html>
