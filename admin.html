<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- orig: <title>ê´€ë¦¬ì ?ï¿½ì´ì§€ - ?ï¿½ì†Œë§ˆï¿½???/title> -->
  <title>ê´€ë¦¬ì í˜ì´ì§€ - ì˜¤ì†Œë§ˆì¼€íŒ…</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="env.js"></script>
</head>
<body style="background:#f5f6fa;">
  <!-- ê´€ë¦¬ì í—¤ë” -->
  <header class="admin-header" style="padding:20px 24px; background:#fff; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #e9ecef;">
    <!-- orig: <h1>?ï¿½ì•½ ê´€ï¿½??ï¿½ìŠ¤??/h1> -->
    <h1 style="font-size:1.4rem; font-weight:600;">ì˜ˆì•½ ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ</h1>
    <nav class="admin-nav" style="display:flex; gap:8px;">
      <a href="index.html" class="nav-btn">ê³ ê° í˜ì´ì§€</a>
      <button class="nav-btn active" onclick="showSection('dashboard')">ëŒ€ì‹œë³´ë“œ</button>
      <button class="nav-btn" onclick="showSection('reservations')">ì˜ˆì•½ ëª©ë¡</button>
      <button class="nav-btn" onclick="showSection('products')">ìƒí’ˆ ë“±ë¡</button>
      <button class="nav-btn" onclick="showSection('product-list')">ìƒí’ˆ ëª©ë¡</button>
      <button class="nav-btn" onclick="showSection('bookings')">ì˜ˆì•½ í˜„í™©</button>
    </nav>
  </header>

  <main class="admin-main" style="padding:20px; max-width:1100px; margin:0 auto;">
    <!-- ëŒ€ì‹œë³´ë“œ ì„¹ì…˜ -->
    <div id="dashboard-section" class="section active">
      <div class="stats-grid" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:12px;">
        <div class="stat-card" style="background:#fff; border-radius:10px; padding:16px; text-align:center;">
          <h3 id="totalReservations" style="font-size:2rem;">0</h3>
          <p>ì „ì²´ ì˜ˆì•½</p>
        </div>
        <div class="stat-card" style="background:#fff; border-radius:10px; padding:16px; text-align:center;">
          <h3 id="todayReservations" style="font-size:2rem;">0</h3>
          <p>ì˜¤ëŠ˜ ì˜ˆì•½</p>
        </div>
        <div class="stat-card" style="background:#fff; border-radius:10px; padding:16px; text-align:center;">
          <h3 id="pendingReservations" style="font-size:2rem;">0</h3>
          <p>ëŒ€ê¸°</p>
        </div>
        <div class="stat-card" style="background:#fff; border-radius:10px; padding:16px; text-align:center;">
          <h3 id="confirmedReservations" style="font-size:2rem;">0</h3>
          <p>í™•ì •</p>
        </div>
      </div>

      <!-- ìµœê·¼ ì˜ˆì•½ -->
      <div class="reservations-section" style="margin-top:20px; background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; align-items:center; justify-content:space-between;">
          <h2>ìµœê·¼ ì˜ˆì•½</h2>
        </div>
        <!-- ë¹ˆìƒíƒœ ë©”ì‹œì§€ (ëŒ€ì‹œë³´ë“œ) -->
        <div id="dashboardEmptyState" class="empty-state" style="display:none; padding:30px; text-align:center; color:#666;">
          <div class="empty-state-icon" style="font-size:2rem;">ğŸ—“ï¸</div>
          <h3>ì•„ì§ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ì²« ë²ˆì§¸ ì˜ˆì•½ì„ ë°›ì•„ë³´ì„¸ìš”!</p>
          <a href="index.html" class="empty-state-btn">ì˜ˆì•½ í˜ì´ì§€ë¡œ ì´ë™</a>
        </div>
        <div class="table-container">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>ë‚ ì§œ</th>
                <th>ì‹œê°„</th>
                <th>ì´ë¦„</th>
                <th>ì—°ë½ì²˜</th>
                <th>ì„œë¹„ìŠ¤</th>
                <th>ìƒíƒœ</th>
              </tr>
            </thead>
            <tbody id="recentReservationsTable">
              <tr><td colspan="6" class="text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ì˜ˆì•½ ëª©ë¡ ì„¹ì…˜ -->
    <div id="reservations-section" class="section" style="display:none;">
      <div class="reservations-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>ì˜ˆì•½ ëª©ë¡ ê´€ë¦¬</h2>
          <div class="filter-controls" style="display:flex; gap:8px;">
            <select id="statusFilter">
              <option value="">ì „ì²´ ìƒíƒœ</option>
              <option value="pending">ëŒ€ê¸°</option>
              <option value="confirmed">í™•ì •</option>
              <option value="cancelled">ì·¨ì†Œ</option>
            </select>
            <input type="date" id="dateFilter" placeholder="ë‚ ì§œ ì„ íƒ" />
            <button class="refresh-btn" onclick="loadReservations()"><span id="refreshText">ìƒˆë¡œê³ ì¹¨</span></button>
          </div>
        </div>

        <!-- ë¹ˆìƒíƒœ ë©”ì‹œì§€ (ì˜ˆì•½ ëª©ë¡) -->
        <div id="reservationsEmptyState" class="empty-state" style="display:none; padding:30px; text-align:center; color:#666;">
          <div class="empty-state-icon" style="font-size:2rem;">ğŸ—“ï¸</div>
          <h3>ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ì•„ì§ ë“±ë¡ëœ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.<br />ê³ ê°ì˜ ì˜ˆì•½ì„ ê¸°ë‹¤ë ¤ë³´ì„¸ìš”!</p>
          <a href="index.html" class="empty-state-btn">ì˜ˆì•½ í˜ì´ì§€ë¡œ ì´ë™</a>
        </div>

        <div class="table-container">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>ID</th>
                <th>ë‚ ì§œ</th>
                <th>ì‹œê°„</th>
                <th>ì´ë¦„</th>
                <th>ì—°ë½ì²˜</th>
                <th>ì´ë©”ì¼</th>
                <th>ì„œë¹„ìŠ¤</th>
                <th>ìƒíƒœ</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="reservationsTable">
              <tr><td colspan="9" class="text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ìƒí’ˆ ë“±ë¡ ì„¹ì…˜ -->
    <div id="products-section" class="section" style="display:none;">
      <div class="products-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>ìƒí’ˆ ë“±ë¡</h2>
            <button class="refresh-btn" onclick="loadProducts()"><span id="productRefreshText">ìƒˆë¡œê³ ì¹¨</span></button>
        </div>

        <form id="productForm" style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:12px;">
          <div>
            <label>ìƒí’ˆëª…</label>
            <input id="product_name" name="product_name" required />
          </div>
          <div>
            <label>í‘œì‹œëª…</label>
            <input id="display_name" name="display_name" required />
          </div>
          <div>
            <label>ìƒí’ˆì½”ë“œ</label>
            <input id="product_code" name="product_code" required />
          </div>
          <div>
            <label>ìƒí’ˆ ë‚ ì§œ</label>
            <input type="date" id="product_date" name="product_date" required />
          </div>
          <div>
            <label>ì‹œì‘ ì‹œê°„</label>
            <input type="time" id="start_time" name="start_time" required />
          </div>
          <div>
            <label>ì¢…ë£Œ ì‹œê°„</label>
            <input type="time" id="end_time" name="end_time" required />
          </div>
          <div>
            <label>ê°€ê²©</label>
            <input type="number" id="product_price" name="product_price" min="0" step="1000" required />
          </div>
          <div>
            <label>ì„¤ëª…</label>
            <input id="product_description" name="product_description" />
          </div>
          <div style="grid-column: 1 / -1;">
            <button type="submit" class="submit-btn">
              <span class="btn-text">ìƒí’ˆ ë“±ë¡</span>
              <span class="btn-loader" style="display:none;">ì²˜ë¦¬ ì¤‘...</span>
            </button>
          </div>
        </form>

        <div class="table-container" style="margin-top:16px;">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>ì½”ë“œ</th>
                <th>ìƒí’ˆëª…</th>
                <th>ë‚ ì§œ</th>
                <th>ì‹œê°„</th>
                <th>ê°€ê²©</th>
                <th>ìƒíƒœ</th>
              </tr>
            </thead>
            <tbody id="productsTable">
              <tr><td colspan="6" class="text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ìƒí’ˆ ëª©ë¡ ì„¹ì…˜ -->
    <div id="product-list-section" class="section" style="display:none;">
      <div class="product-list-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>ë“±ë¡ëœ ìƒí’ˆ ëª©ë¡</h2>
          <div class="filter-controls" style="display:flex; gap:8px;">
            <select id="productStatusFilter">
              <option value="">ì „ì²´ ìƒíƒœ</option>
              <option value="active">í™œì„±</option>
              <option value="inactive">ë¹„í™œì„±</option>
            </select>
            <input type="date" id="productDateFilter" placeholder="ë‚ ì§œ ì„ íƒ" />
            <input type="text" id="productSearchFilter" placeholder="ìƒí’ˆëª… ê²€ìƒ‰" />
            <button class="refresh-btn" onclick="loadProductList()"><span id="productListRefreshText">ìƒˆë¡œê³ ì¹¨</span></button>
          </div>
        </div>

        <!-- ë¹ˆìƒíƒœ ë©”ì‹œì§€ (ìƒí’ˆ ëª©ë¡) -->
        <div id="productListEmptyState" class="empty-state" style="display:none; padding:30px; text-align:center; color:#666;">
          <div class="empty-state-icon" style="font-size:2rem;">ğŸ“¦</div>
          <h3>ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ì•„ì§ ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br />ìƒí’ˆ ë“±ë¡ í˜ì´ì§€ì—ì„œ ìƒˆ ìƒí’ˆì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
          <button class="empty-state-btn" onclick="showSection('products')">ìƒí’ˆ ë“±ë¡í•˜ê¸°</button>
        </div>

        <div class="table-container">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>ìƒí’ˆì½”ë“œ</th>
                <th>ê´€ë¦¬ìš© ìƒí’ˆëª…</th>
                <th>ê³ ê°ìš© í‘œì‹œëª…</th>
                <th>ì˜ˆì•½ì¼</th>
                <th>ì‹œê°„</th>
                <th>ê°€ê²©</th>
                <th>ì„¤ëª…</th>
                <th>ìƒíƒœ</th>
                <th>ì˜ˆì•½ì—¬ë¶€</th>
                <th>ë“±ë¡ì¼</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="productListTable">
              <tr><td colspan="11" class="text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ì˜ˆì•½í˜„í™© ì„¹ì…˜ -->
    <div id="bookings-section" class="section" style="display:none;">
      <div class="bookings-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>ì˜ˆì•½ í˜„í™©</h2>
          <div class="filter-controls" style="display:flex; gap:8px;">
            <select id="bookingStatusFilter">
              <option value="">ì „ì²´ ìƒíƒœ</option>
              <option value="pending">ëŒ€ê¸°</option>
              <option value="confirmed">í™•ì •</option>
              <option value="cancelled">ì·¨ì†Œ</option>
              <option value="completed">ì™„ë£Œ</option>
            </select>
            <input type="date" id="bookingDateFilter" />
            <input type="text" id="customerSearchFilter" placeholder="ê³ ê°ëª… ê²€ìƒ‰" />
            <button class="refresh-btn" onclick="loadBookings()"><span id="bookingRefreshText">ìƒˆë¡œê³ ì¹¨</span></button>
          </div>
        </div>

        <!-- ë¹ˆìƒíƒœ ë©”ì‹œì§€ (ì˜ˆì•½í˜„í™©) -->
        <div id="bookingsEmptyState" class="empty-state" style="display:none; padding:30px; text-align:center; color:#666;">
          <div class="empty-state-icon" style="font-size:2rem;">ğŸ—“ï¸</div>
          <h3>ì˜ˆì•½í˜„í™©ì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ì•„ì§ ë“±ë¡ëœ ì˜ˆì•½í˜„í™©ì´ ì—†ìŠµë‹ˆë‹¤.<br />ê³ ê°ì˜ ì˜ˆì•½ì„ ê¸°ë‹¤ë ¤ë³´ì„¸ìš”!</p>
        </div>

        <div class="table-container">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>ì˜ˆì•½ID</th>
                <th>ê³ ê°ëª…</th>
                <th>ì—°ë½ì²˜</th>
                <th>ì˜ˆì•½ì¼</th>
                <th>ì˜ˆì•½ì‹œê°„</th>
                <th>ìƒí’ˆëª…</th>
                <th>ì¸ì›ìˆ˜</th>
                <th>ì´ê¸ˆì•¡</th>
                <th>ìƒíƒœ</th>
                <th>ì˜ˆì•½ì¼ì‹œ</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="bookingsTable">
              <tr><td colspan="11" class="text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>

  <!-- ì˜ˆì•½ ìƒì„¸ ëª¨ë‹¬ -->
  <div id="reservationModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);">
    <div class="modal-content" style="background:#fff; max-width:680px; margin:60px auto; border-radius:10px; padding:16px;">
      <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center;">
        <h3>ì˜ˆì•½ ìƒì„¸ ì •ë³´</h3>
        <button class="modal-close" onclick="closeModal()" aria-label="close">&times;</button>
      </div>
      <div id="modalBody"></div>
      <div style="margin-top: 20px; text-align: right;">
        <button class="action-btn cancel" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ìƒíƒœ ë³€ê²½ í™•ì¸ ëª¨ë‹¬ -->
  <div id="confirmModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);">
    <div class="modal-content" style="background:#fff; max-width:520px; margin:80px auto; border-radius:10px; padding:16px;">
      <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center;">
        <h3>ìƒíƒœ ë³€ê²½ í™•ì¸</h3>
        <button class="modal-close" onclick="closeConfirmModal()" aria-label="close">&times;</button>
      </div>
      <div id="confirmMessage"></div>
      <div style="margin-top: 20px; text-align: right;">
        <button class="action-btn cancel" onclick="closeConfirmModal()">ì·¨ì†Œ</button>
        <button class="action-btn confirm" id="confirmButton">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
  <div id="adminMessageContainer" class="message-container" style="display:none;">
    <div id="adminMessageContent" class="message"></div>
    <button id="closeAdminMessage" class="close-btn">Ã—</button>
  </div>

  <!-- Scripts -->
  <script src="supabase-config.js"></script>
  <script src="script.js"></script>
  <script src="admin-functions.js"></script>
  <script>
    let currentReservationId = null;
    let currentAction = null;

    document.addEventListener('DOMContentLoaded', function () {
      loadDashboardStats();
      loadRecentReservations();
      setupAdminEventListeners();
      // ì´ˆê¸° ì„¹ì…˜ ìƒíƒœ
      showSection('dashboard');
    });

    function setupAdminEventListeners() {
      const statusFilter = document.getElementById('statusFilter');
      const dateFilter = document.getElementById('dateFilter');
      const productForm = document.getElementById('productForm');
      const bookingStatusFilter = document.getElementById('bookingStatusFilter');
      const bookingDateFilter = document.getElementById('bookingDateFilter');
      const customerSearchFilter = document.getElementById('customerSearchFilter');
      const productStatusFilter = document.getElementById('productStatusFilter');
      const productDateFilter = document.getElementById('productDateFilter');
      const productSearchFilter = document.getElementById('productSearchFilter');
      const closeAdminMessage = document.getElementById('closeAdminMessage');

      if (statusFilter) statusFilter.addEventListener('change', loadReservations);
      if (dateFilter) dateFilter.addEventListener('change', loadReservations);
      if (productForm) productForm.addEventListener('submit', handleProductSubmit);
      if (bookingStatusFilter) bookingStatusFilter.addEventListener('change', loadBookings);
      if (bookingDateFilter) bookingDateFilter.addEventListener('change', loadBookings);
      if (customerSearchFilter) customerSearchFilter.addEventListener('input', debounce(loadBookings, 500));
      if (productStatusFilter) productStatusFilter.addEventListener('change', loadProductList);
      if (productDateFilter) productDateFilter.addEventListener('change', loadProductList);
      if (productSearchFilter) productSearchFilter.addEventListener('input', debounce(loadProductList, 500));
      if (closeAdminMessage) closeAdminMessage.addEventListener('click', hideAdminMessage);

      window.addEventListener('click', function (event) {
        const modal = document.getElementById('reservationModal');
        const confirmModal = document.getElementById('confirmModal');
        if (event.target === modal) closeModal();
        if (event.target === confirmModal) closeConfirmModal();
      });
    }

    function showSection(sectionName) {
      document.querySelectorAll('.section').forEach((s) => (s.style.display = 'none'));
      document.querySelectorAll('.nav-btn').forEach((b) => b.classList.remove('active'));
      const target = document.getElementById(sectionName + '-section');
      if (target) target.style.display = 'block';
      const buttons = Array.from(document.querySelectorAll('.nav-btn'));
      const btn = buttons.find((b) => b.textContent.includes(sectionName === 'dashboard' ? 'ëŒ€ì‹œë³´ë“œ' : sectionName === 'reservations' ? 'ì˜ˆì•½ ëª©ë¡' : sectionName === 'products' ? 'ìƒí’ˆ ë“±ë¡' : sectionName === 'product-list' ? 'ìƒí’ˆ ëª©ë¡' : 'ì˜ˆì•½í˜„í™©'));
      if (btn) btn.classList.add('active');
      if (sectionName === 'reservations') loadReservations();
      else if (sectionName === 'bookings') loadBookings();
      else if (sectionName === 'products') loadProducts();
      else if (sectionName === 'product-list') loadProductList();
    }

    async function loadDashboardStats() {
      try {
        const result = await getReservations();
        if (result.success && result.data) {
          const reservations = result.data;
          const today = new Date().toISOString().split('T')[0];
          const total = reservations.length;
          const todayCount = reservations.filter((r) => r.reservation_date === today).length;
          const pending = reservations.filter((r) => r.status === 'pending').length;
          const confirmed = reservations.filter((r) => r.status === 'confirmed').length;
          document.getElementById('totalReservations').textContent = total;
          document.getElementById('todayReservations').textContent = todayCount;
          document.getElementById('pendingReservations').textContent = pending;
          document.getElementById('confirmedReservations').textContent = confirmed;
          toggleEmptyState('dashboard', total === 0);
        } else {
          document.getElementById('totalReservations').textContent = '0';
          document.getElementById('todayReservations').textContent = '0';
          document.getElementById('pendingReservations').textContent = '0';
          document.getElementById('confirmedReservations').textContent = '0';
          toggleEmptyState('dashboard', true);
        }
      } catch (err) {
        console.error('ëŒ€ì‹œë³´ë“œ í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', err);
        document.getElementById('totalReservations').textContent = '0';
        document.getElementById('todayReservations').textContent = '0';
        document.getElementById('pendingReservations').textContent = '0';
        document.getElementById('confirmedReservations').textContent = '0';
        toggleEmptyState('dashboard', true);
      }
    }

    async function loadRecentReservations() {
      try {
        const result = await getReservations();
        if (result.success && result.data) {
          const recent = result.data.slice(0, 5);
          displayRecentReservations(recent);
        } else {
          displayRecentReservations([]);
        }
      } catch (err) {
        console.error('ìµœê·¼ ì˜ˆì•½ ë¡œë“œ ì˜¤ë¥˜:', err);
        displayRecentReservations([]);
      }
    }

    async function loadReservations() {
      const refreshBtn = document.getElementById('refreshText');
      if (refreshBtn) refreshBtn.innerHTML = '<span class="loading-spinner"></span>';
      try {
        const result = await getReservations();
        if (result.success && result.data) {
          let data = result.data;
          const status = document.getElementById('statusFilter').value;
          const date = document.getElementById('dateFilter').value;
          if (status) data = data.filter((r) => r.status === status);
          if (date) data = data.filter((r) => r.reservation_date === date);
          displayReservations(data);
          loadDashboardStats();
        } else {
          displayReservations([]);
        }
      } catch (err) {
        console.error('ì˜ˆì•½ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
        showAdminMessage('ì˜ˆì•½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        displayReservations([]);
      } finally {
        if (refreshBtn) refreshBtn.textContent = 'ìƒˆë¡œê³ ì¹¨';
      }
    }

    async function handleProductSubmit(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      const submitBtn = form.querySelector('button[type="submit"]');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnLoader = submitBtn.querySelector('.btn-loader');

      if (!validateProductForm(form)) return;

      submitBtn.disabled = true;
      btnText.style.display = 'none';
      btnLoader.style.display = 'inline-flex';
      try {
        const productCode = (formData.get('product_code') || '').trim();
        const dup = await getProductByCode(productCode);
        if (dup.success && dup.data) throw new Error('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìƒí’ˆì½”ë“œì…ë‹ˆë‹¤.');

        const startTime = formData.get('start_time');
        const endTime = formData.get('end_time');
        if (startTime >= endTime) throw new Error('ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.');

        const productData = {
          product_name: (formData.get('product_name') || '').trim(),
          display_name: (formData.get('display_name') || '').trim(),
          product_code: productCode,
          product_date: formData.get('product_date'),
          start_time: startTime,
          end_time: endTime,
          price: parseInt(formData.get('product_price'), 10) || 0,
          description: (formData.get('product_description') || '').trim() || null,
          status: 'active',
          is_booked: false,
        };
        const result = await createProduct(productData);
        if (result.success) {
          showAdminMessage('ìƒí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          form.reset();
          loadProducts();
        } else {
          throw new Error(result.error || 'ìƒí’ˆ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('ìƒí’ˆ ë“±ë¡ ì˜¤ë¥˜:', err);
        showAdminMessage(err.message || 'ìƒí’ˆ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        submitBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoader.style.display = 'none';
      }
    }

    function validateProductForm(form) {
      let isValid = true;
      const requiredFields = form.querySelectorAll('input[required]');
      requiredFields.forEach((f) => {
        const v = (f.value || '').trim();
        if (!v) {
          f.classList.add('error');
          isValid = false;
        } else {
          f.classList.remove('error');
        }
      });
      const priceField = form.querySelector('#product_price');
      const price = parseInt(priceField.value, 10) || 0;
      if (price < 0) {
        priceField.classList.add('error');
        isValid = false;
      }
      const codeField = form.querySelector('#product_code');
      const codePattern = /^[A-Za-z0-9-]+$/;
      if (!codePattern.test((codeField.value || '').trim())) {
        codeField.classList.add('error');
        isValid = false;
      }
      return isValid;
    }

    async function loadProducts() {
      const refreshBtn = document.getElementById('productRefreshText');
      if (refreshBtn) refreshBtn.innerHTML = '<span class="loading-spinner"></span>';
      try {
        const result = await getProducts();
        if (result.success && result.data) {
          displayProducts(result.data);
        } else {
          throw new Error(result.error || 'ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('ìƒí’ˆ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
        showAdminMessage('ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        displayProducts([]);
      } finally {
        if (refreshBtn) refreshBtn.textContent = 'ìƒˆë¡œê³ ì¹¨';
      }
    }

    function displayProducts(products) {
      const tbody = document.getElementById('productsTable');
      if (!tbody) return;
      if (!products || products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      tbody.innerHTML = products
        .map((p) => `
          <tr>
            <td>${p.product_code}</td>
            <td>${p.display_name || p.product_name}</td>
            <td>${p.product_date}</td>
            <td>${(p.start_time || '')} - ${(p.end_time || '')}</td>
            <td>â‚©${Number(p.price || 0).toLocaleString()}</td>
            <td>${p.is_booked ? 'ì˜ˆì•½ë¨' : (p.status || 'active')}</td>
          </tr>`)
        .join('');
    }

    function confirmReservation(reservationId) {
      currentReservationId = reservationId;
      currentAction = 'confirm';
      document.getElementById('confirmMessage').innerHTML = `
        <p>í•´ë‹¹ ì˜ˆì•½ì„ <strong>í™•ì •</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <p style="color:#666; font-size:.9rem; margin-top:10px;">í™•ì • ì‹œ ê³ ê°ì—ê²Œ ì•Œë¦¼ì´ ë°œì†¡ë©ë‹ˆë‹¤.</p>`;
      document.getElementById('confirmButton').onclick = executeConfirm;
      document.getElementById('confirmModal').style.display = 'block';
    }

    function cancelReservation(reservationId) {
      currentReservationId = reservationId;
      currentAction = 'cancel';
      document.getElementById('confirmMessage').innerHTML = `
        <p>í•´ë‹¹ ì˜ˆì•½ì„ <strong>ì·¨ì†Œ</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <p style="color:#666; font-size:.9rem; margin-top:10px;">ì·¨ì†Œëœ ì˜ˆì•½ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
      document.getElementById('confirmButton').onclick = executeConfirm;
      document.getElementById('confirmModal').style.display = 'block';
    }

    function deleteReservationConfirm(reservationId) {
      currentReservationId = reservationId;
      currentAction = 'delete';
      document.getElementById('confirmMessage').innerHTML = `
        <p style="color:#dc3545;"><strong>ì£¼ì˜:</strong> í•´ë‹¹ ì˜ˆì•½ì„ ì˜êµ¬ <strong>ì‚­ì œ</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <p style="color:#666; font-size:.9rem; margin-top:10px;">ì‚­ì œëœ ì˜ˆì•½ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
      document.getElementById('confirmButton').onclick = executeConfirm;
      document.getElementById('confirmModal').style.display = 'block';
    }

    async function executeConfirm() {
      try {
        let result;
        let message;
        switch (currentAction) {
          case 'confirm':
            result = await updateReservation(currentReservationId, { status: 'confirmed' });
            message = 'ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
          case 'cancel':
            result = await updateReservation(currentReservationId, { status: 'cancelled' });
            message = 'ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
          case 'delete':
            result = await deleteReservation(currentReservationId);
            message = 'ì˜ˆì•½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
        }
        if (result && result.success) {
          showAdminMessage(message, 'success');
          loadReservations();
          loadDashboardStats();
        } else {
          throw new Error(result?.error || 'ì‘ì—… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('ì‘ì—… ì²˜ë¦¬ ì˜¤ë¥˜:', err);
        showAdminMessage('ì‘ì—… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        closeConfirmModal();
      }
    }

    function closeModal() {
      const m = document.getElementById('reservationModal');
      if (m) m.style.display = 'none';
    }
    function closeConfirmModal() {
      const cm = document.getElementById('confirmModal');
      if (cm) cm.style.display = 'none';
      currentReservationId = null;
      currentAction = null;
    }

    // ì˜ˆì•½í˜„í™©(booking)
    async function loadBookings() {
      const refresh = document.getElementById('bookingRefreshText');
      if (refresh) refresh.innerHTML = '<span class="loading-spinner"></span>';
      try {
        const result = await getBookings();
        if (result.success && result.data) {
          let data = result.data;
          const status = document.getElementById('bookingStatusFilter').value;
          const date = document.getElementById('bookingDateFilter').value;
          const keyword = (document.getElementById('customerSearchFilter').value || '').trim();
          if (status) data = data.filter((b) => b.status === status);
          if (date) data = data.filter((b) => b.booking_date === date);
          if (keyword) data = data.filter((b) => (b.customer_name || '').includes(keyword));
          displayBookings(data);
        } else {
          displayBookings([]);
        }
      } catch (err) {
        console.error('ì˜ˆì•½í˜„í™© ë¡œë“œ ì˜¤ë¥˜:', err);
        showAdminMessage('ì˜ˆì•½í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        displayBookings([]);
      } finally {
        if (refresh) refresh.textContent = 'ìƒˆë¡œê³ ì¹¨';
      }
    }

    function displayBookings(bookings) {
      const tbody = document.getElementById('bookingsTable');
      if (!tbody) return;
      if (!bookings || bookings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center">ì˜ˆì•½í˜„í™©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        toggleEmptyState('bookings', true);
        return;
      }
      toggleEmptyState('bookings', false);
      tbody.innerHTML = bookings
        .map(
          (b) => `
        <tr>
          <td>${b.id.substring(0, 8)}...</td>
          <td>${b.customer_name}</td>
          <td>${b.customer_phone}</td>
          <td>${b.booking_date}</td>
          <td>${b.booking_time}</td>
          <td>${b.product_name}</td>
          <td>${b.guest_count || 1}</td>
          <td>â‚©${Number(b.total_amount || 0).toLocaleString()}</td>
          <td><span class="status-badge ${b.status}">${getBookingStatusText(b.status)}</span></td>
          <td>${formatDateTime(b.created_at)}</td>
          <td>
            <div class="action-buttons">
              ${b.status === 'pending' ? `<button class="action-btn confirm" onclick="confirmBooking('${b.id}')">í™•ì •</button>` : ''}
              ${b.status !== 'cancelled' ? `<button class="action-btn cancel" onclick="cancelBooking('${b.id}')">ì·¨ì†Œ</button>` : ''}
              <button class="action-btn delete" onclick="deleteBookingConfirm('${b.id}')">ì‚­ì œ</button>
            </div>
          </td>
        </tr>`
        )
        .join('');
    }

    function getBookingStatusText(status) {
      const map = { pending: 'ëŒ€ê¸°', confirmed: 'í™•ì •', cancelled: 'ì·¨ì†Œ', completed: 'ì™„ë£Œ' };
      return map[status] || status;
    }

    function confirmBooking(bookingId) {
      currentReservationId = bookingId;
      currentAction = 'confirmBooking';
      document.getElementById('confirmMessage').innerHTML = `
        <p>í•´ë‹¹ ì˜ˆì•½ì„ <strong>í™•ì •</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>`;
      document.getElementById('confirmButton').onclick = executeBookingAction;
      document.getElementById('confirmModal').style.display = 'block';
    }
    function cancelBooking(bookingId) {
      currentReservationId = bookingId;
      currentAction = 'cancelBooking';
      document.getElementById('confirmMessage').innerHTML = `
        <p>í•´ë‹¹ ì˜ˆì•½ì„ <strong>ì·¨ì†Œ</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>`;
      document.getElementById('confirmButton').onclick = executeBookingAction;
      document.getElementById('confirmModal').style.display = 'block';
    }
    function deleteBookingConfirm(bookingId) {
      currentReservationId = bookingId;
      currentAction = 'deleteBooking';
      document.getElementById('confirmMessage').innerHTML = `
        <p style="color:#dc3545;"><strong>ì£¼ì˜:</strong> í•´ë‹¹ ì˜ˆì•½í˜„í™©ì„ ì˜êµ¬ <strong>ì‚­ì œ</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>`;
      document.getElementById('confirmButton').onclick = executeBookingAction;
      document.getElementById('confirmModal').style.display = 'block';
    }
    async function executeBookingAction() {
      try {
        let result;
        let message;
        switch (currentAction) {
          case 'confirmBooking':
            result = await updateBooking(currentReservationId, { status: 'confirmed' });
            message = 'ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
          case 'cancelBooking':
            result = await updateBooking(currentReservationId, { status: 'cancelled' });
            message = 'ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
          case 'deleteBooking':
            result = await deleteBooking(currentReservationId);
            message = 'ì˜ˆì•½í˜„í™©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
        }
        if (result && result.success) {
          showAdminMessage(message, 'success');
          loadBookings();
        } else {
          throw new Error(result?.error || 'ì‘ì—… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('ì˜ˆì•½í˜„í™© ì‘ì—… ì˜¤ë¥˜:', err);
        showAdminMessage('ì‘ì—… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        closeConfirmModal();
      }
    }

    // ìƒí’ˆ ëª©ë¡ ì „ìš© ë¡œë“œ í•¨ìˆ˜
    async function loadProductList() {
      const refreshBtn = document.getElementById('productListRefreshText');
      if (refreshBtn) refreshBtn.innerHTML = '<span class="loading-spinner"></span>';
      try {
        const result = await getProducts();
        if (result.success && result.data) {
          let data = result.data;
          
          // í•„í„° ì ìš©
          const status = document.getElementById('productStatusFilter').value;
          const date = document.getElementById('productDateFilter').value;
          const keyword = (document.getElementById('productSearchFilter').value || '').trim();
          
          if (status) data = data.filter((p) => p.status === status);
          if (date) data = data.filter((p) => p.product_date === date);
          if (keyword) {
            data = data.filter((p) => 
              (p.product_name || '').toLowerCase().includes(keyword.toLowerCase()) ||
              (p.display_name || '').toLowerCase().includes(keyword.toLowerCase()) ||
              (p.product_code || '').toLowerCase().includes(keyword.toLowerCase())
            );
          }
          
          displayProductList(data);
        } else {
          displayProductList([]);
        }
      } catch (err) {
        console.error('ìƒí’ˆ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
        showAdminMessage('ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        displayProductList([]);
      } finally {
        if (refreshBtn) refreshBtn.textContent = 'ìƒˆë¡œê³ ì¹¨';
      }
    }

    function displayProductList(products) {
      const tbody = document.getElementById('productListTable');
      const emptyState = document.getElementById('productListEmptyState');
      if (!tbody) return;
      
      if (!products || products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center">ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        if (emptyState) emptyState.style.display = 'block';
        return;
      }
      
      if (emptyState) emptyState.style.display = 'none';
      tbody.innerHTML = products
        .map((p) => `
          <tr>
            <td><code>${p.product_code}</code></td>
            <td title="ê´€ë¦¬ìš© ë‚´ë¶€ ìƒí’ˆëª…">${p.product_name}</td>
            <td title="ê³ ê°ì—ê²Œ í‘œì‹œë˜ëŠ” ìƒí’ˆëª…" style="font-weight:600;">${p.display_name || p.product_name}</td>
            <td>${p.product_date}</td>
            <td>${(p.start_time || '')} ~ ${(p.end_time || '')}</td>
            <td style="text-align:right; font-weight:600;">â‚©${Number(p.price || 0).toLocaleString()}</td>
            <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${p.description || ''}">${p.description || '-'}</td>
            <td><span class="status-badge ${p.status || 'active'}">${getProductStatusText(p.status)}</span></td>
            <td><span class="booking-status ${p.is_booked ? 'booked' : 'available'}">${p.is_booked ? 'ì˜ˆì•½ë¨' : 'ì˜ˆì•½ê°€ëŠ¥'}</span></td>
            <td>${formatDateTime(p.created_at)}</td>
            <td>
              <div class="action-buttons">
                ${!p.is_booked ? `<button class="action-btn edit" onclick="editProduct('${p.id}')">ìˆ˜ì •</button>` : ''}
                ${p.status === 'active' ? `<button class="action-btn inactive" onclick="toggleProductStatus('${p.id}', 'inactive')">ë¹„í™œì„±</button>` : `<button class="action-btn active" onclick="toggleProductStatus('${p.id}', 'active')">í™œì„±í™”</button>`}
                ${!p.is_booked ? `<button class="action-btn delete" onclick="deleteProductConfirm('${p.id}')">ì‚­ì œ</button>` : ''}
              </div>
            </td>
          </tr>`)
        .join('');
    }

    function getProductStatusText(status) {
      const map = { active: 'í™œì„±', inactive: 'ë¹„í™œì„±', deleted: 'ì‚­ì œë¨' };
      return map[status] || 'í™œì„±';
    }

    function editProduct(productId) {
      showAdminMessage('ìƒí’ˆ ìˆ˜ì • ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.', 'info');
    }

    function toggleProductStatus(productId, newStatus) {
      currentReservationId = productId;
      currentAction = 'toggleProductStatus';
      const statusText = newStatus === 'active' ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”';
      document.getElementById('confirmMessage').innerHTML = `
        <p>í•´ë‹¹ ìƒí’ˆì„ <strong>${statusText}</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>`;
      document.getElementById('confirmButton').onclick = () => executeProductAction(newStatus);
      document.getElementById('confirmModal').style.display = 'block';
    }

    function deleteProductConfirm(productId) {
      currentReservationId = productId;
      currentAction = 'deleteProduct';
      document.getElementById('confirmMessage').innerHTML = `
        <p style="color:#dc3545;"><strong>ì£¼ì˜:</strong> í•´ë‹¹ ìƒí’ˆì„ ì˜êµ¬ <strong>ì‚­ì œ</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <p style="color:#666; font-size:.9rem; margin-top:10px;">ì‚­ì œëœ ìƒí’ˆì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
      document.getElementById('confirmButton').onclick = executeProductAction;
      document.getElementById('confirmModal').style.display = 'block';
    }

    async function executeProductAction(newStatus) {
      try {
        let result;
        let message;
        switch (currentAction) {
          case 'toggleProductStatus':
            result = await updateProduct(currentReservationId, { status: newStatus });
            message = newStatus === 'active' ? 'ìƒí’ˆì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìƒí’ˆì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
          case 'deleteProduct':
            result = await deleteProduct(currentReservationId);
            message = 'ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
        }
        if (result && result.success) {
          showAdminMessage(message, 'success');
          loadProductList();
          loadProducts(); // ìƒí’ˆ ë“±ë¡ í˜ì´ì§€ë„ ìƒˆë¡œê³ ì¹¨
        } else {
          throw new Error(result?.error || 'ì‘ì—… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('ìƒí’ˆ ì‘ì—… ì˜¤ë¥˜:', err);
        showAdminMessage('ì‘ì—… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        closeConfirmModal();
      }
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }
  </script>
</body>
</html>
