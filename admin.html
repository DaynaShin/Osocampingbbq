<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- orig: <title>ê´€ë¦¬ì ?ï¿½ì´ì§€ - ?ï¿½ì†Œë§ˆï¿½???/title> -->
  <title>ê´€ë¦¬ì í˜ì´ì§€ - OSO Camping BBQ</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="env.js"></script>
</head>
<body style="background:#f5f6fa;">
  <!-- ê´€ë¦¬ì í—¤ë” -->
  <header class="admin-header" style="padding:20px 24px; background:#fff; display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid #e9ecef;">
    <!-- orig: <h1>?ï¿½ì•½ ê´€ï¿½??ï¿½ìŠ¤??/h1> -->
    <h1 style="font-size:1.4rem; font-weight:600;">OSO Camping BBQ ê´€ë¦¬ì</h1>
    <div style="display:flex; align-items:center; gap:20px;">
      <!-- ê´€ë¦¬ì ì •ë³´ ë° ë¡œê·¸ì•„ì›ƒ -->
      <div class="admin-user-info" id="adminUserInfo" style="display:none;">
        <div class="user-avatar" id="userAvatar">ğŸ‘¤</div>
        <div class="user-details">
          <div class="user-name" id="userName">ê´€ë¦¬ì</div>
          <div class="user-role" id="userRole">admin</div>
        </div>
        <div class="user-menu" id="userMenu">
          <button class="user-menu-btn" onclick="toggleUserMenu()">â–¼</button>
          <div class="user-menu-dropdown" id="userMenuDropdown" style="display:none;">
            <div class="menu-item" onclick="showProfile()">
              <span>ğŸ‘¤</span> ë‚´ ì •ë³´
            </div>
            <div class="menu-item" onclick="showActivityLog()">
              <span>ğŸ“‹</span> í™œë™ ë¡œê·¸
            </div>
            <div class="menu-divider"></div>
            <div class="menu-item logout" onclick="handleLogout()">
              <span>ğŸšª</span> ë¡œê·¸ì•„ì›ƒ
            </div>
          </div>
        </div>
      </div>
      
      <!-- ì‹¤ì‹œê°„ ì•Œë¦¼ ë²¨ -->
      <div class="notification-bell" id="notificationBell">
        <svg viewBox="0 0 24 24">
          <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
        </svg>
        <div class="notification-badge" id="notificationBadge" style="display: none;">0</div>
        
        <!-- ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ -->
        <div class="notification-dropdown" id="notificationDropdown">
          <div class="notification-header">
            <h3>ì•Œë¦¼</h3>
            <button class="mark-all-read-btn" id="markAllReadBtn">ëª¨ë‘ ì½ìŒ</button>
          </div>
          <div class="notification-list" id="notificationList">
            <!-- ì•Œë¦¼ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
          </div>
        </div>
      </div>
      
      <nav class="admin-nav" style="display:flex; gap:8px;">
        <a href="index.html" class="nav-btn">ê³ ê° í˜ì´ì§€</a>
        <button class="nav-btn active" onclick="showSection('dashboard')">ëŒ€ì‹œë³´ë“œ</button>
        <button class="nav-btn" onclick="showSection('reservations')">ì˜ˆì•½ ì‹ ì²­</button>
        <button class="nav-btn" onclick="showSection('bookings')">ì˜ˆì•½ í˜„í™©</button>
        <button class="nav-btn" onclick="showSection('catalog')">ì‹œì„¤ ê´€ë¦¬</button>
        <button class="nav-btn" onclick="showSection('availability')">ê°€ìš©ì„± ê´€ë¦¬</button>
        <button class="nav-btn" onclick="showSection('modifications')">ë³€ê²½ ìš”ì²­</button>
        <button class="nav-btn" onclick="showSection('messages')">ë©”ì‹œì§€ ê´€ë¦¬</button>
      </nav>
    </div>
  </header>

  <main class="admin-main" style="padding:20px; max-width:1100px; margin:0 auto;">
    <!-- ëŒ€ì‹œë³´ë“œ ì„¹ì…˜ -->
    <div id="dashboard-section" class="section active">
      <div class="stats-grid" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:12px;">
        <div class="stat-card" style="background:#fff; border-radius:10px; padding:16px; text-align:center;">
          <h3 id="totalReservations" style="font-size:2rem; color:#4facfe;">0</h3>
          <p>ì „ì²´ ì˜ˆì•½ ì‹ ì²­</p>
        </div>
        <div class="stat-card" style="background:#fff; border-radius:10px; padding:16px; text-align:center;">
          <h3 id="todayReservations" style="font-size:2rem; color:#28a745;">0</h3>
          <p>ì˜¤ëŠ˜ ì˜ˆì•½</p>
        </div>
        <div class="stat-card" style="background:#fff; border-radius:10px; padding:16px; text-align:center;">
          <h3 id="pendingReservations" style="font-size:2rem; color:#ffc107;">0</h3>
          <p>ëŒ€ê¸° ì¤‘</p>
        </div>
        <div class="stat-card" style="background:#fff; border-radius:10px; padding:16px; text-align:center;">
          <h3 id="confirmedBookings" style="font-size:2rem; color:#17a2b8;">0</h3>
          <p>í™•ì • ì˜ˆì•½</p>
        </div>
        <div class="stat-card" style="background:#fff; border-radius:10px; padding:16px; text-align:center;">
          <h3 id="availableSlots" style="font-size:2rem; color:#6f42c1;">78</h3>
          <p>ì´ ìŠ¬ë¡¯ ìˆ˜</p>
        </div>
      </div>

      <!-- ìµœê·¼ ì˜ˆì•½ -->
      <div class="reservations-section" style="margin-top:20px; background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; align-items:center; justify-content:space-between;">
          <h2>ìµœê·¼ ì˜ˆì•½</h2>
        </div>
        <!-- ë¹ˆìƒíƒœ ë©”ì‹œì§€ (ëŒ€ì‹œë³´ë“œ) -->
        <div id="dashboardEmptyState" class="empty-state" style="display:none; padding:30px; text-align:center; color:#666;">
          <div class="empty-state-icon" style="font-size:2rem;">ğŸ—“ï¸</div>
          <h3>ì•„ì§ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ì²« ë²ˆì§¸ ì˜ˆì•½ì„ ë°›ì•„ë³´ì„¸ìš”!</p>
          <a href="index.html" class="empty-state-btn">ì˜ˆì•½ í˜ì´ì§€ë¡œ ì´ë™</a>
        </div>
        <div class="table-container">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>ì˜ˆì•½ë²ˆí˜¸</th>
                <th>ë‚ ì§œ</th>
                <th>ì¥ì†Œ</th>
                <th>ì‹œê°„</th>
                <th>ì´ë¦„</th>
                <th>ì—°ë½ì²˜</th>
                <th>ì¸ì›</th>
                <th>ê³„ì •ì—°ê²°</th>
                <th>ìƒíƒœ</th>
              </tr>
            </thead>
            <tbody id="recentReservationsTable">
              <tr><td colspan="9" class="text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ì˜ˆì•½ ëª©ë¡ ì„¹ì…˜ -->
    <div id="reservations-section" class="section" style="display:none;">
      <div class="reservations-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>ì˜ˆì•½ ì‹ ì²­ ê´€ë¦¬</h2>
          <div class="filter-controls" style="display:flex; gap:8px;">
            <select id="statusFilter">
              <option value="">ì „ì²´ ìƒíƒœ</option>
              <option value="pending">ì‹ ì²­ ëŒ€ê¸°</option>
              <option value="confirmed">ìŠ¹ì¸ ì™„ë£Œ</option>
              <option value="cancelled">ì‹ ì²­ ì·¨ì†Œ</option>
            </select>
            <select id="categoryFilter">
              <option value="">ì „ì²´ ì¥ì†Œ</option>
              <option value="PR">í”„ë¼ì´ë¹—ë£¸</option>
              <option value="ST">ì†ŒíŒŒí…Œì´ë¸”</option>
              <option value="TN">í…íŠ¸ë™</option>
              <option value="VP">VIPë™</option>
              <option value="YT">ì•¼ì¥í…Œì´ë¸”</option>
            </select>
            <input type="date" id="dateFilter" placeholder="ë‚ ì§œ ì„ íƒ" />
            <button class="refresh-btn" onclick="loadReservations()"><span id="refreshText">ìƒˆë¡œê³ ì¹¨</span></button>
          </div>
        </div>

        <!-- ë¹ˆìƒíƒœ ë©”ì‹œì§€ (ì˜ˆì•½ ëª©ë¡) -->
        <div id="reservationsEmptyState" class="empty-state" style="display:none; padding:30px; text-align:center; color:#666;">
          <div class="empty-state-icon" style="font-size:2rem;">ğŸ—“ï¸</div>
          <h3>ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ì•„ì§ ë“±ë¡ëœ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.<br />ê³ ê°ì˜ ì˜ˆì•½ì„ ê¸°ë‹¤ë ¤ë³´ì„¸ìš”!</p>
          <a href="index.html" class="empty-state-btn">ì˜ˆì•½ í˜ì´ì§€ë¡œ ì´ë™</a>
        </div>

        <div class="table-container">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>ì˜ˆì•½ë²ˆí˜¸</th>
                <th>ë‚ ì§œ</th>
                <th>ì¥ì†Œ</th>
                <th>ì‹œê°„</th>
                <th>ì´ë¦„</th>
                <th>ì—°ë½ì²˜</th>
                <th>ì´ë©”ì¼</th>
                <th>ì¸ì›</th>
                <th>ê³„ì •ì—°ê²°</th>
                <th>ìƒíƒœ</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="reservationsTable">
              <tr><td colspan="11" class="text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ìƒí’ˆ ë“±ë¡ ì„¹ì…˜ -->
    <div id="products-section" class="section" style="display:none;">
      <div class="products-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>ìƒí’ˆ ë“±ë¡</h2>
            <button class="refresh-btn" onclick="loadProducts()"><span id="productRefreshText">ìƒˆë¡œê³ ì¹¨</span></button>
        </div>

        <form id="productForm" style="display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:12px;">
          <div>
            <label>ìƒí’ˆëª…</label>
            <input id="product_name" name="product_name" required />
          </div>
          <div>
            <label>í‘œì‹œëª…</label>
            <input id="display_name" name="display_name" required />
          </div>
          <div>
            <label>ìƒí’ˆì½”ë“œ</label>
            <input id="product_code" name="product_code" required />
          </div>
          <div>
            <label>ìƒí’ˆ ë‚ ì§œ</label>
            <input type="date" id="product_date" name="product_date" required />
          </div>
          <div>
            <label>ì‹œì‘ ì‹œê°„</label>
            <input type="time" id="start_time" name="start_time" required />
          </div>
          <div>
            <label>ì¢…ë£Œ ì‹œê°„</label>
            <input type="time" id="end_time" name="end_time" required />
          </div>
          <div>
            <label>ê°€ê²©</label>
            <input type="number" id="product_price" name="product_price" min="0" step="1000" required />
          </div>
          <div>
            <label>ì„¤ëª…</label>
            <input id="product_description" name="product_description" />
          </div>
          <div style="grid-column: 1 / -1;">
            <button type="submit" class="submit-btn">
              <span class="btn-text">ìƒí’ˆ ë“±ë¡</span>
              <span class="btn-loader" style="display:none;">ì²˜ë¦¬ ì¤‘...</span>
            </button>
          </div>
        </form>

        <div class="table-container" style="margin-top:16px;">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>ì½”ë“œ</th>
                <th>ìƒí’ˆëª…</th>
                <th>ë‚ ì§œ</th>
                <th>ì‹œê°„</th>
                <th>ê°€ê²©</th>
                <th>ìƒíƒœ</th>
              </tr>
            </thead>
            <tbody id="productsTable">
              <tr><td colspan="6" class="text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ìƒí’ˆ ëª©ë¡ ì„¹ì…˜ -->
    <div id="product-list-section" class="section" style="display:none;">
      <div class="product-list-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>ë“±ë¡ëœ ìƒí’ˆ ëª©ë¡</h2>
          <div class="filter-controls" style="display:flex; gap:8px;">
            <select id="productStatusFilter">
              <option value="">ì „ì²´ ìƒíƒœ</option>
              <option value="active">í™œì„±</option>
              <option value="inactive">ë¹„í™œì„±</option>
            </select>
            <input type="date" id="productDateFilter" placeholder="ë‚ ì§œ ì„ íƒ" />
            <input type="text" id="productSearchFilter" placeholder="ìƒí’ˆëª… ê²€ìƒ‰" />
            <button class="refresh-btn" onclick="loadProductList()"><span id="productListRefreshText">ìƒˆë¡œê³ ì¹¨</span></button>
          </div>
        </div>

        <!-- ë¹ˆìƒíƒœ ë©”ì‹œì§€ (ìƒí’ˆ ëª©ë¡) -->
        <div id="productListEmptyState" class="empty-state" style="display:none; padding:30px; text-align:center; color:#666;">
          <div class="empty-state-icon" style="font-size:2rem;">ğŸ“¦</div>
          <h3>ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ì•„ì§ ë“±ë¡ëœ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.<br />ìƒí’ˆ ë“±ë¡ í˜ì´ì§€ì—ì„œ ìƒˆ ìƒí’ˆì„ ì¶”ê°€í•´ë³´ì„¸ìš”!</p>
          <button class="empty-state-btn" onclick="showSection('products')">ìƒí’ˆ ë“±ë¡í•˜ê¸°</button>
        </div>

        <div class="table-container">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>ìƒí’ˆì½”ë“œ</th>
                <th>ê´€ë¦¬ìš© ìƒí’ˆëª…</th>
                <th>ê³ ê°ìš© í‘œì‹œëª…</th>
                <th>ì˜ˆì•½ì¼</th>
                <th>ì‹œê°„</th>
                <th>ê°€ê²©</th>
                <th>ì„¤ëª…</th>
                <th>ìƒíƒœ</th>
                <th>ì˜ˆì•½ì—¬ë¶€</th>
                <th>ë“±ë¡ì¼</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="productListTable">
              <tr><td colspan="11" class="text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ì˜ˆì•½í˜„í™© ì„¹ì…˜ -->
    <div id="bookings-section" class="section" style="display:none;">
      <div class="bookings-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>ì˜ˆì•½ í˜„í™©</h2>
          <div class="filter-controls" style="display:flex; gap:8px;">
            <select id="bookingStatusFilter">
              <option value="">ì „ì²´ ìƒíƒœ</option>
              <option value="pending">ëŒ€ê¸°</option>
              <option value="confirmed">í™•ì •</option>
              <option value="cancelled">ì·¨ì†Œ</option>
              <option value="completed">ì™„ë£Œ</option>
            </select>
            <input type="date" id="bookingDateFilter" />
            <input type="text" id="customerSearchFilter" placeholder="ê³ ê°ëª… ê²€ìƒ‰" />
            <button class="refresh-btn" onclick="loadBookings()"><span id="bookingRefreshText">ìƒˆë¡œê³ ì¹¨</span></button>
          </div>
        </div>

        <!-- ë¹ˆìƒíƒœ ë©”ì‹œì§€ (ì˜ˆì•½í˜„í™©) -->
        <div id="bookingsEmptyState" class="empty-state" style="display:none; padding:30px; text-align:center; color:#666;">
          <div class="empty-state-icon" style="font-size:2rem;">ğŸ—“ï¸</div>
          <h3>ì˜ˆì•½í˜„í™©ì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ì•„ì§ ë“±ë¡ëœ ì˜ˆì•½í˜„í™©ì´ ì—†ìŠµë‹ˆë‹¤.<br />ê³ ê°ì˜ ì˜ˆì•½ì„ ê¸°ë‹¤ë ¤ë³´ì„¸ìš”!</p>
        </div>

        <div class="table-container">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>ì˜ˆì•½ë²ˆí˜¸</th>
                <th>ê³ ê°ëª…</th>
                <th>ì—°ë½ì²˜</th>
                <th>ì´ë©”ì¼</th>
                <th>ì˜ˆì•½ì¼</th>
                <th>ì˜ˆì•½ì‹œê°„</th>
                <th>ì¥ì†Œ</th>
                <th>ì¸ì›ìˆ˜</th>
                <th>ì´ê¸ˆì•¡</th>
                <th>ìƒíƒœ</th>
                <th>ê³„ì •ì—¬ë¶€</th>
                <th>ì˜ˆì•½ì¼ì‹œ</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="bookingsTable">
              <tr><td colspan="13" class="text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- OSO ì‹œì„¤ ê´€ë¦¬ ì„¹ì…˜ -->
    <div id="catalog-section" class="section" style="display:none;">
      <div class="catalog-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>ì‹œì„¤ ê´€ë¦¬</h2>
          <button class="refresh-btn" onclick="loadCatalog()"><span id="catalogRefreshText">ìƒˆë¡œê³ ì¹¨</span></button>
        </div>

        <!-- ì¹´í…Œê³ ë¦¬ë³„ ì‹œì„¤ í˜„í™© -->
        <div class="catalog-stats" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:12px; margin-bottom:20px;">
          <div class="stat-card" style="background:#e8f5e8; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#28a745; margin:0;">í”„ë¼ì´ë¹—ë£¸</h4>
            <p id="prCount" style="font-size:1.5rem; margin:5px 0 0 0;">0</p>
          </div>
          <div class="stat-card" style="background:#fff3cd; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#856404; margin:0;">ì†ŒíŒŒí…Œì´ë¸”</h4>
            <p id="stCount" style="font-size:1.5rem; margin:5px 0 0 0;">0</p>
          </div>
          <div class="stat-card" style="background:#d4edda; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#155724; margin:0;">í…íŠ¸ë™</h4>
            <p id="tnCount" style="font-size:1.5rem; margin:5px 0 0 0;">0</p>
          </div>
          <div class="stat-card" style="background:#cce5ff; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#0066cc; margin:0;">VIPë™</h4>
            <p id="vpCount" style="font-size:1.5rem; margin:5px 0 0 0;">0</p>
          </div>
          <div class="stat-card" style="background:#f8d7da; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#721c24; margin:0;">ì•¼ì¥í…Œì´ë¸”</h4>
            <p id="ytCount" style="font-size:1.5rem; margin:5px 0 0 0;">0</p>
          </div>
        </div>

        <!-- ì‹œì„¤ ëª©ë¡ -->
        <div class="table-container">
          <table class="reservations-table" style="width:100%; border-collapse:collapse;">
            <thead>
              <tr>
                <th>ì‹œì„¤ì½”ë“œ</th>
                <th>ì¹´í…Œê³ ë¦¬</th>
                <th>ì‹œì„¤ëª…</th>
                <th>ìµœëŒ€ì¸ì›</th>
                <th>ê¸°ë³¸ê°€ê²©</th>
                <th>ì„¤ëª…</th>
                <th>ìƒíƒœ</th>
                <th>ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="catalogTable">
              <tr><td colspan="8" class="text-center">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- OSO ê°€ìš©ì„± ê´€ë¦¬ ì„¹ì…˜ -->
    <div id="availability-section" class="section" style="display:none;">
      <div class="availability-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>ê°€ìš©ì„± ê´€ë¦¬</h2>
          <div class="filter-controls" style="display:flex; gap:8px;">
            <input type="date" id="availabilityDateFilter" />
            <select id="availabilityCategoryFilter">
              <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
              <option value="PR">í”„ë¼ì´ë¹—ë£¸</option>
              <option value="ST">ì†ŒíŒŒí…Œì´ë¸”</option>
              <option value="TN">í…íŠ¸ë™</option>
              <option value="VP">VIPë™</option>
              <option value="YT">ì•¼ì¥í…Œì´ë¸”</option>
            </select>
            <button class="refresh-btn" onclick="loadAvailability()"><span id="availabilityRefreshText">ìƒˆë¡œê³ ì¹¨</span></button>
          </div>
        </div>

        <!-- ì‹œê°„ë³„ ê°€ìš©ì„± ê·¸ë¦¬ë“œ -->
        <div class="availability-grid" style="margin-bottom:20px;">
          <div class="time-slots" style="display:flex; gap:10px; margin-bottom:15px;">
            <div class="time-slot-header">ì‹œì„¤</div>
            <div class="time-slot-header">ì ì‹¬ (11:30-14:30)</div>
            <div class="time-slot-header">ì˜¤í›„ (15:00-18:00)</div>
            <div class="time-slot-header">ì €ë… (18:30-21:30)</div>
          </div>
          <div id="availabilityGridContent">
            <div class="text-center" style="padding:20px; color:#666;">ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ ê°€ìš©ì„±ì„ í™•ì¸í•˜ì„¸ìš”</div>
          </div>
        </div>

        <!-- ì˜ˆì•½ í†µê³„ -->
        <div class="booking-stats" style="display:grid; grid-template-columns: repeat(4, 1fr); gap:12px;">
          <div class="stat-card" style="background:#fff; border:1px solid #e9ecef; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#4facfe; margin:0 0 5px 0;">ì´ ìŠ¬ë¡¯</h4>
            <p id="totalSlots" style="font-size:1.2rem; margin:0;">78</p>
          </div>
          <div class="stat-card" style="background:#fff; border:1px solid #e9ecef; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#28a745; margin:0 0 5px 0;">ì˜ˆì•½ê°€ëŠ¥</h4>
            <p id="availableSlots" style="font-size:1.2rem; margin:0;">-</p>
          </div>
          <div class="stat-card" style="background:#fff; border:1px solid #e9ecef; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#ffc107; margin:0 0 5px 0;">ì˜ˆì•½ë¨</h4>
            <p id="bookedSlots" style="font-size:1.2rem; margin:0;">-</p>
          </div>
          <div class="stat-card" style="background:#fff; border:1px solid #e9ecef; border-radius:8px; padding:12px; text-align:center;">
            <h4 style="color:#dc3545; margin:0 0 5px 0;">ë¹„í™œì„±</h4>
            <p id="inactiveSlots" style="font-size:1.2rem; margin:0;">-</p>
          </div>
        </div>
      </div>
    </div>
    <!-- ë©”ì‹œì§€ ê´€ë¦¬ ì„¹ì…˜ -->
    <div id="messages-section" class="section" style="display:none;">
      <div class="messages-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>ë©”ì‹œì§€ ê´€ë¦¬</h2>
          <div class="message-controls" style="display:flex; gap:8px;">
            <select id="messageStatusFilter">
              <option value="">ì „ì²´ ìƒíƒœ</option>
              <option value="pending">ë°œì†¡ ëŒ€ê¸°</option>
              <option value="sent">ë°œì†¡ ì™„ë£Œ</option>
              <option value="delivered">ì „ë‹¬ ì™„ë£Œ</option>
              <option value="failed">ë°œì†¡ ì‹¤íŒ¨</option>
            </select>
            <select id="messageTypeFilter">
              <option value="">ì „ì²´ íƒ€ì…</option>
              <option value="sms">SMS</option>
              <option value="email">ì´ë©”ì¼</option>
            </select>
            <button class="refresh-btn" onclick="loadMessageLogs()">ìƒˆë¡œê³ ì¹¨</button>
            <button class="action-btn confirm" onclick="sendDailyReminders()">ë¦¬ë§ˆì¸ë” ë°œì†¡</button>
            <button class="action-btn" onclick="retryFailedMessages()">ì‹¤íŒ¨ ë©”ì‹œì§€ ì¬ë°œì†¡</button>
          </div>
        </div>

        <!-- ë©”ì‹œì§€ í†µê³„ -->
        <div class="message-stats" style="display:grid; grid-template-columns: repeat(6, 1fr); gap:12px; margin:16px 0;">
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="totalMessages" style="font-size:1.5rem; color:#4facfe; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">ì „ì²´ ë©”ì‹œì§€</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="smsMessages" style="font-size:1.5rem; color:#28a745; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">SMS</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="emailMessages" style="font-size:1.5rem; color:#17a2b8; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">ì´ë©”ì¼</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="sentMessages" style="font-size:1.5rem; color:#28a745; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">ë°œì†¡ ì™„ë£Œ</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="failedMessages" style="font-size:1.5rem; color:#dc3545; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">ë°œì†¡ ì‹¤íŒ¨</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="pendingMessages" style="font-size:1.5rem; color:#ffc107; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">ë°œì†¡ ëŒ€ê¸°</p>
          </div>
        </div>

        <!-- ë©”ì‹œì§€ ë°œì†¡ ë¡œê·¸ í…Œì´ë¸” -->
        <div class="table-container" style="overflow-x:auto; margin-top:16px;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background:#f8f9fa;">
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ë°œì†¡ ì‹œê°„</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ì˜ˆì•½ë²ˆí˜¸</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">íƒ€ì…</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ìˆ˜ì‹ ì</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">í…œí”Œë¦¿</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ì œëª©</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ìƒíƒœ</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ì¬ì‹œë„</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="messageLogsTable">
              <tr><td colspan="9" style="text-align:center; padding:16px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ë©”ì‹œì§€ í…œí”Œë¦¿ ê´€ë¦¬ -->
      <div class="templates-section" style="background:#fff; border-radius:10px; padding:16px; margin-top:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>ë©”ì‹œì§€ í…œí”Œë¦¿ ê´€ë¦¬</h2>
          <button class="refresh-btn" onclick="loadMessageTemplates()">ìƒˆë¡œê³ ì¹¨</button>
        </div>

        <div class="template-list" id="templateList" style="margin-top:16px;">
          <!-- í…œí”Œë¦¿ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
        </div>
      </div>
    </div>

    <!-- ë³€ê²½ ìš”ì²­ ê´€ë¦¬ ì„¹ì…˜ -->
    <div id="modifications-section" class="section" style="display:none;">
      <div class="modifications-section" style="background:#fff; border-radius:10px; padding:16px;">
        <div class="section-header" style="display:flex; justify-content:space-between; align-items:center;">
          <h2>ì˜ˆì•½ ë³€ê²½ ìš”ì²­ ê´€ë¦¬</h2>
          <div class="modification-controls" style="display:flex; gap:8px;">
            <select id="modificationStatusFilter">
              <option value="">ì „ì²´ ìƒíƒœ</option>
              <option value="pending">ëŒ€ê¸° ì¤‘</option>
              <option value="approved">ìŠ¹ì¸ë¨</option>
              <option value="rejected">ê±°ë¶€ë¨</option>
              <option value="completed">ì²˜ë¦¬ ì™„ë£Œ</option>
            </select>
            <select id="modificationTypeFilter">
              <option value="">ì „ì²´ íƒ€ì…</option>
              <option value="date">ë‚ ì§œ ë³€ê²½</option>
              <option value="guests">ì¸ì› ë³€ê²½</option>
              <option value="cancellation">ì˜ˆì•½ ì·¨ì†Œ</option>
            </select>
            <button class="refresh-btn" onclick="loadModificationRequests()">ìƒˆë¡œê³ ì¹¨</button>
          </div>
        </div>

        <!-- ë³€ê²½ ìš”ì²­ í†µê³„ -->
        <div class="modification-stats" style="display:grid; grid-template-columns: repeat(5, 1fr); gap:12px; margin:16px 0;">
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="totalModifications" style="font-size:1.5rem; color:#4facfe; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">ì „ì²´ ìš”ì²­</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="pendingModifications" style="font-size:1.5rem; color:#ffc107; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">ëŒ€ê¸° ì¤‘</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="approvedModifications" style="font-size:1.5rem; color:#28a745; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">ìŠ¹ì¸ë¨</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="rejectedModifications" style="font-size:1.5rem; color:#dc3545; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">ê±°ë¶€ë¨</p>
          </div>
          <div class="stat-card" style="background:#f8f9fa; border-radius:8px; padding:12px; text-align:center;">
            <h4 id="completedModifications" style="font-size:1.5rem; color:#17a2b8; margin:0;">0</h4>
            <p style="margin:4px 0 0; font-size:0.9rem;">ì²˜ë¦¬ ì™„ë£Œ</p>
          </div>
        </div>

        <!-- ë³€ê²½ ìš”ì²­ í…Œì´ë¸” -->
        <div class="table-container" style="overflow-x:auto; margin-top:16px;">
          <table style="width:100%; border-collapse:collapse;">
            <thead>
              <tr style="background:#f8f9fa;">
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ìš”ì²­ ì‹œê°„</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ì˜ˆì•½ë²ˆí˜¸</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ê³ ê°ëª…</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ì—°ë½ì²˜</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ë³€ê²½ íƒ€ì…</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ê¸°ì¡´ ì •ë³´</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ë³€ê²½ ìš”ì²­</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ìƒíƒœ</th>
                <th style="padding:8px; border:1px solid #dee2e6; text-align:left;">ì•¡ì…˜</th>
              </tr>
            </thead>
            <tbody id="modificationsTable">
              <tr><td colspan="9" style="text-align:center; padding:16px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- ë¹ˆ ìƒíƒœ ë©”ì‹œì§€ -->
        <div id="modificationsEmptyState" class="empty-state" style="display:none; padding:30px; text-align:center; color:#666;">
          <div class="empty-state-icon" style="font-size:2rem;">ğŸ“</div>
          <h3>ë³€ê²½ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤</h3>
          <p>ê³ ê°ì˜ ì˜ˆì•½ ë³€ê²½ ìš”ì²­ì´ ë“¤ì–´ì˜¤ë©´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>

  </main>

  <!-- ë³€ê²½ ìš”ì²­ ìƒì„¸ ëª¨ë‹¬ -->
  <div id="modificationModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);">
    <div class="modal-content" style="background:#fff; max-width:800px; margin:40px auto; border-radius:10px; padding:20px;">
      <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <h3>ë³€ê²½ ìš”ì²­ ìƒì„¸</h3>
        <button class="modal-close" onclick="closeModificationModal()" aria-label="close">&times;</button>
      </div>
      <div id="modificationModalBody">
        <!-- ë‚´ìš©ì´ JavaScriptë¡œ ë™ì  ìƒì„±ë©ë‹ˆë‹¤ -->
      </div>
      <div style="margin-top: 20px; text-align: right; display: flex; gap: 8px; justify-content: flex-end;">
        <button class="action-btn cancel" onclick="closeModificationModal()">ë‹«ê¸°</button>
        <button class="action-btn" id="approveModificationBtn" onclick="processModification('approved')">ìŠ¹ì¸</button>
        <button class="action-btn reject" id="rejectModificationBtn" onclick="processModification('rejected')">ê±°ë¶€</button>
      </div>
    </div>
  </div>

  <!-- ì˜ˆì•½ ìƒì„¸ ëª¨ë‹¬ -->
  <div id="reservationModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4);">
    <div class="modal-content" style="background:#fff; max-width:680px; margin:60px auto; border-radius:10px; padding:16px;">
      <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center;">
        <h3>ì˜ˆì•½ ìƒì„¸ ì •ë³´</h3>
        <button class="modal-close" onclick="closeModal()" aria-label="close">&times;</button>
      </div>
      <div id="modalBody"></div>
      <div style="margin-top: 20px; text-align: right;">
        <button class="action-btn cancel" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ìƒíƒœ ë³€ê²½ í™•ì¸ ëª¨ë‹¬ -->
  <div id="confirmModal" class="modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.4); z-index: 1000;">
    <div class="modal-content" style="background:#fff; max-width:600px; margin:80px auto; border-radius:10px; padding:20px;">
      <div class="modal-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
        <h3>ìƒíƒœ ë³€ê²½ í™•ì¸</h3>
        <button class="modal-close" onclick="closeConfirmModal()" aria-label="close" style="background:none; border:none; font-size:24px; cursor:pointer;">&times;</button>
      </div>
      
      <div id="confirmMessage" style="margin-bottom:20px; padding:12px; background:#f8f9fa; border-radius:6px;"></div>
      
      <!-- ê´€ë¦¬ì ì…ë ¥ í•„ë“œë“¤ -->
      <div id="adminInputs" style="margin-bottom:20px;">
        <div id="cancellationReasonGroup" style="margin-bottom:16px; display:none;">
          <label for="cancellationReason" style="display:block; margin-bottom:4px; font-weight:500;">ì·¨ì†Œ/ì‚­ì œ ì‚¬ìœ :</label>
          <textarea id="cancellationReason" placeholder="ì·¨ì†Œ ë˜ëŠ” ì‚­ì œ ì‚¬ìœ ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                   style="width:100%; min-height:60px; padding:8px; border:1px solid #ddd; border-radius:4px; resize:vertical;"></textarea>
        </div>
        
        <div style="margin-bottom:16px;">
          <label for="adminNotes" style="display:block; margin-bottom:4px; font-weight:500;">ê´€ë¦¬ì ë©”ëª¨ (ì„ íƒì‚¬í•­):</label>
          <textarea id="adminNotes" placeholder="ì¶”ê°€ ë©”ëª¨ë‚˜ íŠ¹ì´ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”..." 
                   style="width:100%; min-height:60px; padding:8px; border:1px solid #ddd; border-radius:4px; resize:vertical;"></textarea>
        </div>
      </div>
      
      <div style="text-align: right; border-top:1px solid #eee; padding-top:16px;">
        <button class="action-btn cancel" onclick="closeConfirmModal()" style="margin-right:8px;">ì·¨ì†Œ</button>
        <button class="action-btn confirm" id="confirmButton">í™•ì¸</button>
      </div>
    </div>
  </div>

  <!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
  <div id="adminMessageContainer" class="message-container" style="display:none;">
    <div id="adminMessageContent" class="message"></div>
    <button id="closeAdminMessage" class="close-btn">Ã—</button>
  </div>

  <!-- Scripts -->
  <script src="supabase-config-v2.js"></script>
  <script>
    // ============================
    // ê´€ë¦¬ì ì¸ì¦ ì‹œìŠ¤í…œ (Phase 2.3)
    // ============================
    
    class AdminAuthMiddleware {
      constructor() {
        this.supabaseClient = null;
        this.currentAdmin = null;
        this.sessionToken = null;
        this.isAuthenticated = false;
        this.init();
      }
      
      async init() {
        try {
          // Supabase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”
          if (typeof window.__ENV !== 'undefined') {
            this.supabaseClient = supabase.createClient(
              window.__ENV.SUPABASE_URL,
              window.__ENV.SUPABASE_ANON_KEY
            );
          } else {
            console.error('í™˜ê²½ ì„¤ì •ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            this.redirectToLogin();
            return;
          }
          
          // ì¸ì¦ ìƒíƒœ í™•ì¸
          await this.checkAuthStatus();
          
        } catch (error) {
          console.error('ê´€ë¦¬ì ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
          this.redirectToLogin();
        }
      }
      
      async checkAuthStatus() {
        try {
          // Supabase Auth ì„¸ì…˜ í™•ì¸
          const { data: { session }, error } = await this.supabaseClient.auth.getSession();
          
          if (error) {
            console.error('ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨:', error);
            this.redirectToLogin();
            return;
          }
          
          if (!session || !session.user) {
            console.log('ì¸ì¦ë˜ì§€ ì•Šì€ ì ‘ê·¼ ì‹œë„');
            this.redirectToLogin();
            return;
          }
          
          // ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
          const isValidAdmin = await this.verifyAdminPermissions(session.user);
          
          if (!isValidAdmin) {
            console.log('ê´€ë¦¬ì ê¶Œí•œ ì—†ìŒ');
            await this.supabaseClient.auth.signOut();
            this.redirectToLogin();
            return;
          }
          
          // ì¸ì¦ ì„±ê³µ
          this.isAuthenticated = true;
          this.currentAdmin = session.user;
          
          // ê´€ë¦¬ì í”„ë¡œí•„ ë¡œë“œ
          await this.loadAdminProfile();
          
          // UI ì—…ë°ì´íŠ¸
          this.updateAuthUI();
          
          // í™œë™ ë¡œê·¸ ê¸°ë¡
          this.logActivity('page_access', 'admin_dashboard');
          
          console.log('ê´€ë¦¬ì ì¸ì¦ ì„±ê³µ:', this.currentAdmin.email);
          
        } catch (error) {
          console.error('ì¸ì¦ ìƒíƒœ í™•ì¸ ì¤‘ ì˜¤ë¥˜:', error);
          this.redirectToLogin();
        }
      }
      
      async verifyAdminPermissions(user) {
        try {
          const { data, error } = await this.supabaseClient
            .from('admin_profiles')
            .select('id, email, full_name, role, is_active, permissions')
            .eq('id', user.id)
            .eq('is_active', true)
            .single();
          
          if (error || !data) {
            console.error('ê´€ë¦¬ì í”„ë¡œí•„ ì¡°íšŒ ì‹¤íŒ¨:', error);
            return false;
          }
          
          this.adminProfile = data;
          return true;
          
        } catch (error) {
          console.error('ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ì‹¤íŒ¨:', error);
          return false;
        }
      }
      
      async loadAdminProfile() {
        try {
          const { data, error } = await this.supabaseClient.rpc('get_admin_profile');
          
          if (error) {
            console.error('ê´€ë¦¬ì í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨:', error);
            return;
          }
          
          if (data && data.length > 0) {
            this.adminProfile = data[0];
          }
          
        } catch (error) {
          console.error('ê´€ë¦¬ì í”„ë¡œí•„ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
        }
      }
      
      updateAuthUI() {
        const adminUserInfo = document.getElementById('adminUserInfo');
        const userName = document.getElementById('userName');
        const userRole = document.getElementById('userRole');
        const userAvatar = document.getElementById('userAvatar');
        
        if (adminUserInfo && this.adminProfile) {
          adminUserInfo.style.display = 'flex';
          
          if (userName) {
            userName.textContent = this.adminProfile.full_name || this.adminProfile.email || 'ê´€ë¦¬ì';
          }
          
          if (userRole) {
            const roleNames = {
              'super_admin': 'ìµœê³ ê´€ë¦¬ì',
              'admin': 'ê´€ë¦¬ì',
              'viewer': 'ì¡°íšŒì'
            };
            userRole.textContent = roleNames[this.adminProfile.role] || this.adminProfile.role;
          }
          
          if (userAvatar) {
            const avatarEmojis = {
              'super_admin': 'ğŸ‘‘',
              'admin': 'ğŸ‘¤',
              'viewer': 'ğŸ‘€'
            };
            userAvatar.textContent = avatarEmojis[this.adminProfile.role] || 'ğŸ‘¤';
          }
        }
      }
      
      hasPermission(resource, action) {
        if (!this.adminProfile || !this.adminProfile.permissions) {
          return false;
        }
        
        const resourcePermissions = this.adminProfile.permissions[resource];
        if (!resourcePermissions) {
          return false;
        }
        
        return resourcePermissions[action] === true;
      }
      
      async logActivity(actionType, resourceType = null, resourceId = null, details = {}) {
        try {
          await this.supabaseClient.rpc('log_admin_activity', {
            p_action_type: actionType,
            p_resource_type: resourceType,
            p_resource_id: resourceId,
            p_action_details: details
          });
        } catch (error) {
          console.error('í™œë™ ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:', error);
        }
      }
      
      redirectToLogin() {
        console.log('ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
        window.location.href = 'admin-login.html';
      }
      
      async logout() {
        try {
          // í™œë™ ë¡œê·¸ ê¸°ë¡
          this.logActivity('logout', 'auth');
          
          // Supabase ë¡œê·¸ì•„ì›ƒ
          await this.supabaseClient.auth.signOut();
          
          // ë¡œì»¬ ì €ì¥ì†Œ ì •ë¦¬
          localStorage.removeItem('admin_session');
          
          // ìƒíƒœ ì´ˆê¸°í™”
          this.isAuthenticated = false;
          this.currentAdmin = null;
          this.adminProfile = null;
          
          // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
          this.redirectToLogin();
          
        } catch (error) {
          console.error('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜:', error);
          // ì˜¤ë¥˜ê°€ ìˆì–´ë„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
          this.redirectToLogin();
        }
      }
    }
    
    // ì „ì—­ ë³€ìˆ˜ë“¤
    let currentReservationId = null;
    let currentAction = null;
    let adminAuth = null;
    
    // ê´€ë¦¬ì ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ ì´ˆê¸°í™” ë° ë©”ì¸ ì•± ë¡œì§
    document.addEventListener('DOMContentLoaded', async function () {
      // ê´€ë¦¬ì ì¸ì¦ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
      adminAuth = new AdminAuthMiddleware();
      
      // ì¸ì¦ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 5ì´ˆ)
      let attempts = 0;
      const maxAttempts = 50; // 5ì´ˆ (100ms * 50)
      
      while (!adminAuth.isAuthenticated && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
      }
      
      if (!adminAuth.isAuthenticated) {
        console.error('ì¸ì¦ ì‹œê°„ ì´ˆê³¼');
        return;
      }
      
      // ì¸ì¦ ì„±ê³µ í›„ ë©”ì¸ ì•± ë¡œì§ ì‹¤í–‰
      loadDashboardStats();
      loadRecentReservations();
      setupAdminEventListeners();
      // ì´ˆê¸° ì„¹ì…˜ ìƒíƒœ
      showSection('dashboard');
    });

    function setupAdminEventListeners() {
      const statusFilter = document.getElementById('statusFilter');
      const dateFilter = document.getElementById('dateFilter');
      const categoryFilter = document.getElementById('categoryFilter');
      const bookingStatusFilter = document.getElementById('bookingStatusFilter');
      const bookingDateFilter = document.getElementById('bookingDateFilter');
      const customerSearchFilter = document.getElementById('customerSearchFilter');
      const availabilityDateFilter = document.getElementById('availabilityDateFilter');
      const availabilityCategoryFilter = document.getElementById('availabilityCategoryFilter');
      const modificationStatusFilter = document.getElementById('modificationStatusFilter');
      const modificationTypeFilter = document.getElementById('modificationTypeFilter');
      const closeAdminMessage = document.getElementById('closeAdminMessage');

      if (statusFilter) statusFilter.addEventListener('change', loadReservations);
      if (dateFilter) dateFilter.addEventListener('change', loadReservations);
      if (categoryFilter) categoryFilter.addEventListener('change', loadReservations);
      if (bookingStatusFilter) bookingStatusFilter.addEventListener('change', loadBookings);
      if (bookingDateFilter) bookingDateFilter.addEventListener('change', loadBookings);
      if (customerSearchFilter) customerSearchFilter.addEventListener('input', debounce(loadBookings, 500));
      if (availabilityDateFilter) availabilityDateFilter.addEventListener('change', loadAvailability);
      if (availabilityCategoryFilter) availabilityCategoryFilter.addEventListener('change', loadAvailability);
      if (modificationStatusFilter) modificationStatusFilter.addEventListener('change', loadModificationRequests);
      if (modificationTypeFilter) modificationTypeFilter.addEventListener('change', loadModificationRequests);
      if (closeAdminMessage) closeAdminMessage.addEventListener('click', hideAdminMessage);

      window.addEventListener('click', function (event) {
        const modal = document.getElementById('reservationModal');
        const confirmModal = document.getElementById('confirmModal');
        const modificationModal = document.getElementById('modificationModal');
        if (event.target === modal) closeModal();
        if (event.target === confirmModal) closeConfirmModal();
        if (event.target === modificationModal) closeModificationModal();
      });
    }

    function showSection(sectionName) {
      document.querySelectorAll('.section').forEach((s) => (s.style.display = 'none'));
      document.querySelectorAll('.nav-btn').forEach((b) => b.classList.remove('active'));
      const target = document.getElementById(sectionName + '-section');
      if (target) target.style.display = 'block';
      const buttons = Array.from(document.querySelectorAll('.nav-btn'));
      const sectionMap = {
        'dashboard': 'ëŒ€ì‹œë³´ë“œ',
        'reservations': 'ì˜ˆì•½ ì‹ ì²­',
        'bookings': 'ì˜ˆì•½ í˜„í™©',
        'catalog': 'ì‹œì„¤ ê´€ë¦¬',
        'availability': 'ê°€ìš©ì„± ê´€ë¦¬',
        'modifications': 'ë³€ê²½ ìš”ì²­',
        'messages': 'ë©”ì‹œì§€ ê´€ë¦¬'
      };
      const btn = buttons.find((b) => b.textContent.includes(sectionMap[sectionName] || sectionName));
      if (btn) btn.classList.add('active');
      
      // Load section data
      if (sectionName === 'reservations') loadReservations();
      else if (sectionName === 'bookings') loadBookings();
      else if (sectionName === 'catalog') loadCatalog();
      else if (sectionName === 'availability') loadAvailability();
      else if (sectionName === 'modifications') loadModificationRequests();
      else if (sectionName === 'messages') loadMessageLogs();
    }

    async function loadDashboardStats() {
      try {
        const result = await getReservations();
        if (result.success && result.data) {
          const reservations = result.data;
          const today = new Date().toISOString().split('T')[0];
          const total = reservations.length;
          const todayCount = reservations.filter((r) => r.reservation_date === today).length;
          const pending = reservations.filter((r) => r.status === 'pending').length;
          
          // Get bookings for confirmed count
          const bookingsResult = await getBookings();
          let confirmed = 0;
          if (bookingsResult.success && bookingsResult.data) {
            confirmed = bookingsResult.data.filter((b) => b.status === 'confirmed').length;
          }
          
          document.getElementById('totalReservations').textContent = total;
          document.getElementById('todayReservations').textContent = todayCount;
          document.getElementById('pendingReservations').textContent = pending;
          document.getElementById('confirmedBookings').textContent = confirmed;
          toggleEmptyState('dashboard', total === 0);
        } else {
          document.getElementById('totalReservations').textContent = '0';
          document.getElementById('todayReservations').textContent = '0';
          document.getElementById('pendingReservations').textContent = '0';
          document.getElementById('confirmedBookings').textContent = '0';
          toggleEmptyState('dashboard', true);
        }
      } catch (err) {
        console.error('ëŒ€ì‹œë³´ë“œ í†µê³„ ë¡œë“œ ì˜¤ë¥˜:', err);
        document.getElementById('totalReservations').textContent = '0';
        document.getElementById('todayReservations').textContent = '0';
        document.getElementById('pendingReservations').textContent = '0';
        document.getElementById('confirmedBookings').textContent = '0';
        toggleEmptyState('dashboard', true);
      }
    }

    async function loadRecentReservations() {
      try {
        const result = await getAdminReservationsWithCustomer();
        if (result.success && result.data) {
          const recent = result.data.slice(0, 5);
          displayRecentReservations(recent);
        } else {
          displayRecentReservations([]);
        }
      } catch (err) {
        console.error('ìµœê·¼ ì˜ˆì•½ ë¡œë“œ ì˜¤ë¥˜:', err);
        displayRecentReservations([]);
      }
    }

    async function loadReservations() {
      const refreshBtn = document.getElementById('refreshText');
      if (refreshBtn) refreshBtn.innerHTML = '<span class="loading-spinner"></span>';
      try {
        const result = await getAdminReservationsWithCustomer();
        if (result.success && result.data) {
          let data = result.data;
          const status = document.getElementById('statusFilter')?.value;
          const date = document.getElementById('dateFilter')?.value;
          const category = document.getElementById('categoryFilter')?.value;
          
          if (status) data = data.filter((r) => r.status === status);
          if (date) data = data.filter((r) => r.reservation_date === date);
          if (category) data = data.filter((r) => r.facility_category === category);
          
          displayReservations(data);
          loadDashboardStats();
        } else {
          displayReservations([]);
        }
      } catch (err) {
        console.error('ì˜ˆì•½ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
        showAdminMessage('ì˜ˆì•½ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        displayReservations([]);
      } finally {
        if (refreshBtn) refreshBtn.textContent = 'ìƒˆë¡œê³ ì¹¨';
      }
    }

    async function handleProductSubmit(event) {
      event.preventDefault();
      const form = event.target;
      const formData = new FormData(form);
      const submitBtn = form.querySelector('button[type="submit"]');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnLoader = submitBtn.querySelector('.btn-loader');

      if (!validateProductForm(form)) return;

      submitBtn.disabled = true;
      btnText.style.display = 'none';
      btnLoader.style.display = 'inline-flex';
      try {
        const productCode = (formData.get('product_code') || '').trim();
        const dup = await getProductByCode(productCode);
        if (dup.success && dup.data) throw new Error('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ìƒí’ˆì½”ë“œì…ë‹ˆë‹¤.');

        const startTime = formData.get('start_time');
        const endTime = formData.get('end_time');
        if (startTime >= endTime) throw new Error('ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ëŠ¦ì–´ì•¼ í•©ë‹ˆë‹¤.');

        const productData = {
          product_name: (formData.get('product_name') || '').trim(),
          display_name: (formData.get('display_name') || '').trim(),
          product_code: productCode,
          product_date: formData.get('product_date'),
          start_time: startTime,
          end_time: endTime,
          price: parseInt(formData.get('product_price'), 10) || 0,
          description: (formData.get('product_description') || '').trim() || null,
          status: 'active',
          is_booked: false,
        };
        const result = await createProduct(productData);
        if (result.success) {
          showAdminMessage('ìƒí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          form.reset();
          loadProducts();
        } else {
          throw new Error(result.error || 'ìƒí’ˆ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('ìƒí’ˆ ë“±ë¡ ì˜¤ë¥˜:', err);
        showAdminMessage(err.message || 'ìƒí’ˆ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        submitBtn.disabled = false;
        btnText.style.display = 'inline';
        btnLoader.style.display = 'none';
      }
    }

    function validateProductForm(form) {
      let isValid = true;
      const requiredFields = form.querySelectorAll('input[required]');
      requiredFields.forEach((f) => {
        const v = (f.value || '').trim();
        if (!v) {
          f.classList.add('error');
          isValid = false;
        } else {
          f.classList.remove('error');
        }
      });
      const priceField = form.querySelector('#product_price');
      const price = parseInt(priceField.value, 10) || 0;
      if (price < 0) {
        priceField.classList.add('error');
        isValid = false;
      }
      const codeField = form.querySelector('#product_code');
      const codePattern = /^[A-Za-z0-9-]+$/;
      if (!codePattern.test((codeField.value || '').trim())) {
        codeField.classList.add('error');
        isValid = false;
      }
      return isValid;
    }

    async function loadProducts() {
      const refreshBtn = document.getElementById('productRefreshText');
      if (refreshBtn) refreshBtn.innerHTML = '<span class="loading-spinner"></span>';
      try {
        const result = await getProducts();
        if (result.success && result.data) {
          displayProducts(result.data);
        } else {
          throw new Error(result.error || 'ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('ìƒí’ˆ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
        showAdminMessage('ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        displayProducts([]);
      } finally {
        if (refreshBtn) refreshBtn.textContent = 'ìƒˆë¡œê³ ì¹¨';
      }
    }

    function displayProducts(products) {
      const tbody = document.getElementById('productsTable');
      if (!tbody) return;
      if (!products || products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      tbody.innerHTML = products
        .map((p) => `
          <tr>
            <td>${p.product_code}</td>
            <td>${p.display_name || p.product_name}</td>
            <td>${p.product_date}</td>
            <td>${(p.start_time || '')} - ${(p.end_time || '')}</td>
            <td>â‚©${Number(p.price || 0).toLocaleString()}</td>
            <td>${p.is_booked ? 'ì˜ˆì•½ë¨' : (p.status || 'active')}</td>
          </tr>`)
        .join('');
    }

    function confirmReservation(reservationId) {
      currentReservationId = reservationId;
      currentAction = 'confirm';
      document.getElementById('confirmMessage').innerHTML = `
        <p>í•´ë‹¹ ì˜ˆì•½ì„ <strong>í™•ì •</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <p style="color:#666; font-size:.9rem; margin-top:10px;">í™•ì • ì‹œ ê³ ê°ì—ê²Œ ì•Œë¦¼ì´ ë°œì†¡ë©ë‹ˆë‹¤.</p>`;
      
      // ê´€ë¦¬ì ì…ë ¥ í•„ë“œ í‘œì‹œ/ìˆ¨ê¸°ê¸°
      document.getElementById('adminNotesField').style.display = 'block';
      document.getElementById('cancellationReasonField').style.display = 'none';
      
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      document.getElementById('adminNotes').value = '';
      document.getElementById('cancellationReason').value = '';
      
      document.getElementById('confirmButton').onclick = executeConfirm;
      document.getElementById('confirmModal').style.display = 'block';
    }

    function cancelReservation(reservationId) {
      currentReservationId = reservationId;
      currentAction = 'cancel';
      document.getElementById('confirmMessage').innerHTML = `
        <p>í•´ë‹¹ ì˜ˆì•½ì„ <strong>ì·¨ì†Œ</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <p style="color:#666; font-size:.9rem; margin-top:10px;">ì·¨ì†Œëœ ì˜ˆì•½ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
      
      // ê´€ë¦¬ì ì…ë ¥ í•„ë“œ í‘œì‹œ/ìˆ¨ê¸°ê¸°
      document.getElementById('adminNotesField').style.display = 'block';
      document.getElementById('cancellationReasonField').style.display = 'block';
      
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      document.getElementById('adminNotes').value = '';
      document.getElementById('cancellationReason').value = '';
      
      document.getElementById('confirmButton').onclick = executeConfirm;
      document.getElementById('confirmModal').style.display = 'block';
    }

    function deleteReservationConfirm(reservationId) {
      currentReservationId = reservationId;
      currentAction = 'delete';
      document.getElementById('confirmMessage').innerHTML = `
        <p style="color:#dc3545;"><strong>ì£¼ì˜:</strong> í•´ë‹¹ ì˜ˆì•½ì„ ì˜êµ¬ <strong>ì‚­ì œ</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <p style="color:#666; font-size:.9rem; margin-top:10px;">ì‚­ì œëœ ì˜ˆì•½ì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
      
      // ê´€ë¦¬ì ì…ë ¥ í•„ë“œ í‘œì‹œ/ìˆ¨ê¸°ê¸° (ì‚­ì œëŠ” ì·¨ì†Œì™€ ë™ì¼í•˜ê²Œ ì²˜ë¦¬)
      document.getElementById('adminNotesField').style.display = 'block';
      document.getElementById('cancellationReasonField').style.display = 'block';
      
      // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
      document.getElementById('adminNotes').value = '';
      document.getElementById('cancellationReason').value = '';
      
      document.getElementById('confirmButton').onclick = executeConfirm;
      document.getElementById('confirmModal').style.display = 'block';
    }

    async function executeConfirm() {
      try {
        let result;
        let message;
        
        // ê´€ë¦¬ì ë©”ëª¨ ê°€ì ¸ì˜¤ê¸°
        const adminNotes = document.getElementById('adminNotes')?.value || null;
        const cancellationReason = document.getElementById('cancellationReason')?.value || null;
        
        switch (currentAction) {
          case 'confirm':
            result = await adminConfirmReservation(currentReservationId, adminNotes);
            message = 'ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
          case 'cancel':
            result = await adminCancelReservation(currentReservationId, cancellationReason, adminNotes);
            message = 'ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
          case 'delete':
            const deletionReason = cancellationReason || 'ê´€ë¦¬ìì— ì˜í•œ ì‚­ì œ';
            result = await adminDeleteReservation(currentReservationId, deletionReason);
            message = 'ì˜ˆì•½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
        }
        if (result && result.success) {
          showAdminMessage(message, 'success');
          loadReservations();
          loadDashboardStats();
        } else {
          throw new Error(result?.error || 'ì‘ì—… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('ì‘ì—… ì²˜ë¦¬ ì˜¤ë¥˜:', err);
        showAdminMessage('ì‘ì—… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        closeConfirmModal();
      }
    }

    function closeModal() {
      const m = document.getElementById('reservationModal');
      if (m) m.style.display = 'none';
    }
    function closeConfirmModal() {
      const cm = document.getElementById('confirmModal');
      if (cm) cm.style.display = 'none';
      currentReservationId = null;
      currentAction = null;
    }

    // ì˜ˆì•½í˜„í™©(booking)
    async function loadBookings() {
      const refresh = document.getElementById('bookingRefreshText');
      if (refresh) refresh.innerHTML = '<span class="loading-spinner"></span>';
      try {
        const result = await getBookings();
        if (result.success && result.data) {
          let data = result.data;
          const status = document.getElementById('bookingStatusFilter').value;
          const date = document.getElementById('bookingDateFilter').value;
          const keyword = (document.getElementById('customerSearchFilter').value || '').trim();
          if (status) data = data.filter((b) => b.status === status);
          if (date) data = data.filter((b) => b.booking_date === date);
          if (keyword) data = data.filter((b) => (b.customer_name || '').includes(keyword));
          displayBookings(data);
        } else {
          displayBookings([]);
        }
      } catch (err) {
        console.error('ì˜ˆì•½í˜„í™© ë¡œë“œ ì˜¤ë¥˜:', err);
        showAdminMessage('ì˜ˆì•½í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        displayBookings([]);
      } finally {
        if (refresh) refresh.textContent = 'ìƒˆë¡œê³ ì¹¨';
      }
    }

    function displayBookings(bookings) {
      const tbody = document.getElementById('bookingsTable');
      if (!tbody) return;
      if (!bookings || bookings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center">ì˜ˆì•½í˜„í™©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        toggleEmptyState('bookings', true);
        return;
      }
      toggleEmptyState('bookings', false);
      tbody.innerHTML = bookings
        .map(
          (b) => `
        <tr>
          <td>${b.id.substring(0, 8)}...</td>
          <td>${b.customer_name}</td>
          <td>${b.customer_phone}</td>
          <td>${b.booking_date}</td>
          <td>${b.booking_time}</td>
          <td>${b.venue_name || b.resource_name || b.product_name || '-'}</td>
          <td>${b.guest_count || 1}</td>
          <td>â‚©${Number(b.total_amount || 0).toLocaleString()}</td>
          <td><span class="status-badge ${b.status}">${getBookingStatusText(b.status)}</span></td>
          <td>${formatDateTime(b.created_at)}</td>
          <td>
            <div class="action-buttons">
              ${b.status === 'pending' ? `<button class="action-btn confirm" onclick="confirmBooking('${b.id}')">í™•ì •</button>` : ''}
              ${b.status !== 'cancelled' ? `<button class="action-btn cancel" onclick="cancelBooking('${b.id}')">ì·¨ì†Œ</button>` : ''}
              <button class="action-btn delete" onclick="deleteBookingConfirm('${b.id}')">ì‚­ì œ</button>
            </div>
          </td>
        </tr>`
        )
        .join('');
    }

    function getBookingStatusText(status) {
      const map = { pending: 'ëŒ€ê¸°', confirmed: 'í™•ì •', cancelled: 'ì·¨ì†Œ', completed: 'ì™„ë£Œ' };
      return map[status] || status;
    }

    function confirmBooking(bookingId) {
      currentReservationId = bookingId;
      currentAction = 'confirmBooking';
      document.getElementById('confirmMessage').innerHTML = `
        <p>í•´ë‹¹ ì˜ˆì•½ì„ <strong>í™•ì •</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>`;
      document.getElementById('confirmButton').onclick = executeBookingAction;
      document.getElementById('confirmModal').style.display = 'block';
    }
    function cancelBooking(bookingId) {
      currentReservationId = bookingId;
      currentAction = 'cancelBooking';
      document.getElementById('confirmMessage').innerHTML = `
        <p>í•´ë‹¹ ì˜ˆì•½ì„ <strong>ì·¨ì†Œ</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>`;
      document.getElementById('confirmButton').onclick = executeBookingAction;
      document.getElementById('confirmModal').style.display = 'block';
    }
    function deleteBookingConfirm(bookingId) {
      currentReservationId = bookingId;
      currentAction = 'deleteBooking';
      document.getElementById('confirmMessage').innerHTML = `
        <p style="color:#dc3545;"><strong>ì£¼ì˜:</strong> í•´ë‹¹ ì˜ˆì•½í˜„í™©ì„ ì˜êµ¬ <strong>ì‚­ì œ</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>`;
      document.getElementById('confirmButton').onclick = executeBookingAction;
      document.getElementById('confirmModal').style.display = 'block';
    }
    async function executeBookingAction() {
      try {
        let result;
        let message;
        switch (currentAction) {
          case 'confirmBooking':
            result = await updateBooking(currentReservationId, { status: 'confirmed' });
            message = 'ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
          case 'cancelBooking':
            result = await updateBooking(currentReservationId, { status: 'cancelled' });
            message = 'ì˜ˆì•½ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
          case 'deleteBooking':
            result = await deleteBooking(currentReservationId);
            message = 'ì˜ˆì•½í˜„í™©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
        }
        if (result && result.success) {
          showAdminMessage(message, 'success');
          loadBookings();
        } else {
          throw new Error(result?.error || 'ì‘ì—… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('ì˜ˆì•½í˜„í™© ì‘ì—… ì˜¤ë¥˜:', err);
        showAdminMessage('ì‘ì—… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        closeConfirmModal();
      }
    }

    // ìƒí’ˆ ëª©ë¡ ì „ìš© ë¡œë“œ í•¨ìˆ˜
    async function loadProductList() {
      const refreshBtn = document.getElementById('productListRefreshText');
      if (refreshBtn) refreshBtn.innerHTML = '<span class="loading-spinner"></span>';
      try {
        const result = await getProducts();
        if (result.success && result.data) {
          let data = result.data;
          
          // í•„í„° ì ìš©
          const status = document.getElementById('productStatusFilter').value;
          const date = document.getElementById('productDateFilter').value;
          const keyword = (document.getElementById('productSearchFilter').value || '').trim();
          
          if (status) data = data.filter((p) => p.status === status);
          if (date) data = data.filter((p) => p.product_date === date);
          if (keyword) {
            data = data.filter((p) => 
              (p.product_name || '').toLowerCase().includes(keyword.toLowerCase()) ||
              (p.display_name || '').toLowerCase().includes(keyword.toLowerCase()) ||
              (p.product_code || '').toLowerCase().includes(keyword.toLowerCase())
            );
          }
          
          displayProductList(data);
        } else {
          displayProductList([]);
        }
      } catch (err) {
        console.error('ìƒí’ˆ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
        showAdminMessage('ìƒí’ˆ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        displayProductList([]);
      } finally {
        if (refreshBtn) refreshBtn.textContent = 'ìƒˆë¡œê³ ì¹¨';
      }
    }

    function displayProductList(products) {
      const tbody = document.getElementById('productListTable');
      const emptyState = document.getElementById('productListEmptyState');
      if (!tbody) return;
      
      if (!products || products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center">ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        if (emptyState) emptyState.style.display = 'block';
        return;
      }
      
      if (emptyState) emptyState.style.display = 'none';
      tbody.innerHTML = products
        .map((p) => `
          <tr>
            <td><code>${p.product_code}</code></td>
            <td title="ê´€ë¦¬ìš© ë‚´ë¶€ ìƒí’ˆëª…">${p.product_name}</td>
            <td title="ê³ ê°ì—ê²Œ í‘œì‹œë˜ëŠ” ìƒí’ˆëª…" style="font-weight:600;">${p.display_name || p.product_name}</td>
            <td>${p.product_date}</td>
            <td>${(p.start_time || '')} ~ ${(p.end_time || '')}</td>
            <td style="text-align:right; font-weight:600;">â‚©${Number(p.price || 0).toLocaleString()}</td>
            <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${p.description || ''}">${p.description || '-'}</td>
            <td><span class="status-badge ${p.status || 'active'}">${getProductStatusText(p.status)}</span></td>
            <td><span class="booking-status ${p.is_booked ? 'booked' : 'available'}">${p.is_booked ? 'ì˜ˆì•½ë¨' : 'ì˜ˆì•½ê°€ëŠ¥'}</span></td>
            <td>${formatDateTime(p.created_at)}</td>
            <td>
              <div class="action-buttons">
                ${!p.is_booked ? `<button class="action-btn edit" onclick="editProduct('${p.id}')">ìˆ˜ì •</button>` : ''}
                ${p.status === 'active' ? `<button class="action-btn inactive" onclick="toggleProductStatus('${p.id}', 'inactive')">ë¹„í™œì„±</button>` : `<button class="action-btn active" onclick="toggleProductStatus('${p.id}', 'active')">í™œì„±í™”</button>`}
                ${!p.is_booked ? `<button class="action-btn delete" onclick="deleteProductConfirm('${p.id}')">ì‚­ì œ</button>` : ''}
              </div>
            </td>
          </tr>`)
        .join('');
    }

    function getProductStatusText(status) {
      const map = { active: 'í™œì„±', inactive: 'ë¹„í™œì„±', deleted: 'ì‚­ì œë¨' };
      return map[status] || 'í™œì„±';
    }

    function editProduct(productId) {
      showAdminMessage('ìƒí’ˆ ìˆ˜ì • ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.', 'info');
    }

    function toggleProductStatus(productId, newStatus) {
      currentReservationId = productId;
      currentAction = 'toggleProductStatus';
      const statusText = newStatus === 'active' ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”';
      document.getElementById('confirmMessage').innerHTML = `
        <p>í•´ë‹¹ ìƒí’ˆì„ <strong>${statusText}</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>`;
      document.getElementById('confirmButton').onclick = () => executeProductAction(newStatus);
      document.getElementById('confirmModal').style.display = 'block';
    }

    function deleteProductConfirm(productId) {
      currentReservationId = productId;
      currentAction = 'deleteProduct';
      document.getElementById('confirmMessage').innerHTML = `
        <p style="color:#dc3545;"><strong>ì£¼ì˜:</strong> í•´ë‹¹ ìƒí’ˆì„ ì˜êµ¬ <strong>ì‚­ì œ</strong>í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
        <p style="color:#666; font-size:.9rem; margin-top:10px;">ì‚­ì œëœ ìƒí’ˆì€ ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>`;
      document.getElementById('confirmButton').onclick = executeProductAction;
      document.getElementById('confirmModal').style.display = 'block';
    }

    async function executeProductAction(newStatus) {
      try {
        let result;
        let message;
        switch (currentAction) {
          case 'toggleProductStatus':
            result = await updateProduct(currentReservationId, { status: newStatus });
            message = newStatus === 'active' ? 'ìƒí’ˆì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ìƒí’ˆì´ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
          case 'deleteProduct':
            result = await deleteProduct(currentReservationId);
            message = 'ìƒí’ˆì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
            break;
        }
        if (result && result.success) {
          showAdminMessage(message, 'success');
          loadProductList();
          loadProducts(); // ìƒí’ˆ ë“±ë¡ í˜ì´ì§€ë„ ìƒˆë¡œê³ ì¹¨
        } else {
          throw new Error(result?.error || 'ì‘ì—… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('ìƒí’ˆ ì‘ì—… ì˜¤ë¥˜:', err);
        showAdminMessage('ì‘ì—… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        closeConfirmModal();
      }
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Display functions
    function displayRecentReservations(reservations) {
      const tbody = document.getElementById('recentReservationsTable');
      if (!tbody) return;
      if (!reservations || reservations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center">ìµœê·¼ ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      tbody.innerHTML = reservations
        .map((r) => `
          <tr>
            <td>${r.reservation_number || r.id?.substring(0, 8) + '...' || '-'}</td>
            <td>${r.reservation_date}</td>
            <td>${r.facility_name || r.venue_name || r.product_name || '-'}</td>
            <td>${r.time_slot || '-'}</td>
            <td>${r.customer_name || r.name}</td>
            <td>${r.customer_phone || r.phone}</td>
            <td>${r.guest_count || 1}</td>
            <td>${getAccountTypeDisplay(r.has_customer_account, r.account_type)}</td>
            <td><span class="status-badge ${r.status}">${getStatusText(r.status)}</span></td>
          </tr>`)
        .join('');
    }

    function displayReservations(reservations) {
      const tbody = document.getElementById('reservationsTable');
      if (!tbody) return;
      toggleEmptyState('reservations', !reservations || reservations.length === 0);
      if (!reservations || reservations.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" class="text-center">ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      tbody.innerHTML = reservations
        .map((r) => `
          <tr>
            <td title="ID: ${r.reservation_id}">${r.reservation_number || r.id?.substring(0, 8) + '...' || '-'}</td>
            <td>${r.reservation_date}</td>
            <td>${r.facility_name || r.venue_name || r.product_name || '-'}</td>
            <td>${r.time_slot || '-'}</td>
            <td>${r.customer_name || r.name}</td>
            <td>${r.customer_phone || r.phone}</td>
            <td>${r.customer_email || r.email || '-'}</td>
            <td>${r.guest_count || 1}</td>
            <td>${getAccountTypeDisplay(r.has_customer_account, r.account_type, r.total_reservations_count)}</td>
            <td><span class="status-badge ${r.status}">${getStatusText(r.status)}</span></td>
            <td>
              <div class="action-buttons">
                ${r.status === 'pending' ? `<button class="action-btn confirm" onclick="confirmReservation('${r.reservation_id || r.id}')">ìŠ¹ì¸</button>` : ''}
                ${r.status !== 'cancelled' ? `<button class="action-btn cancel" onclick="cancelReservation('${r.reservation_id || r.id}')">ì·¨ì†Œ</button>` : ''}
                <button class="action-btn delete" onclick="deleteReservationConfirm('${r.reservation_id || r.id}')">ì‚­ì œ</button>
              </div>
            </td>
          </tr>`)
        .join('');
    }

    function getStatusText(status) {
      const map = { pending: 'ëŒ€ê¸°', confirmed: 'ìŠ¹ì¸', cancelled: 'ì·¨ì†Œ', completed: 'ì™„ë£Œ' };
      return map[status] || status;
    }

    function toggleEmptyState(section, isEmpty) {
      const emptyState = document.getElementById(`${section}EmptyState`);
      const table = document.querySelector(`#${section}-section .table-container`);
      if (emptyState && table) {
        emptyState.style.display = isEmpty ? 'block' : 'none';
        table.style.display = isEmpty ? 'none' : 'block';
      }
    }

    // OSO Catalog Management Functions
    async function loadCatalog() {
      const refreshBtn = document.getElementById('catalogRefreshText');
      if (refreshBtn) refreshBtn.innerHTML = '<span class="loading-spinner"></span>';
      try {
        const result = await getResourceCatalog();
        if (result.success && result.data) {
          displayCatalogStats(result.data);
          displayCatalog(result.data);
        } else {
          throw new Error(result.error || 'ì‹œì„¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('ì‹œì„¤ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', err);
        showAdminMessage('ì‹œì„¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        displayCatalog([]);
      } finally {
        if (refreshBtn) refreshBtn.textContent = 'ìƒˆë¡œê³ ì¹¨';
      }
    }

    function displayCatalogStats(resources) {
      const stats = resources.reduce((acc, r) => {
        acc[r.category_code] = (acc[r.category_code] || 0) + 1;
        return acc;
      }, {});
      
      document.getElementById('prCount').textContent = stats.PR || 0;
      document.getElementById('stCount').textContent = stats.ST || 0;
      document.getElementById('tnCount').textContent = stats.TN || 0;
      document.getElementById('vpCount').textContent = stats.VP || 0;
      document.getElementById('ytCount').textContent = stats.YT || 0;
    }

    function displayCatalog(resources) {
      const tbody = document.getElementById('catalogTable');
      if (!tbody) return;
      if (!resources || resources.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center">ì‹œì„¤ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
      }
      
      tbody.innerHTML = resources
        .map((r) => `
          <tr>
            <td><code>${r.internal_code}</code></td>
            <td><span class="category-badge ${r.category_code.toLowerCase()}">${getCategoryName(r.category_code)}</span></td>
            <td>${r.display_name}</td>
            <td>${r.max_guests}ëª…</td>
            <td>â‚©${Number(r.price || 0).toLocaleString()}</td>
            <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis;" title="${r.description || ''}">${r.description || '-'}</td>
            <td><span class="status-badge ${r.active ? 'active' : 'inactive'}">${r.active ? 'í™œì„±' : 'ë¹„í™œì„±'}</span></td>
            <td>
              <div class="action-buttons">
                <button class="action-btn edit" onclick="editResource('${r.internal_code}')">ìˆ˜ì •</button>
                <button class="action-btn ${r.active ? 'inactive' : 'active'}" onclick="toggleResourceStatus('${r.internal_code}', ${!r.active})">${r.active ? 'ë¹„í™œì„±' : 'í™œì„±í™”'}</button>
              </div>
            </td>
          </tr>`)
        .join('');
    }

    function getCategoryName(code) {
      const map = {
        'PR': 'í”„ë¼ì´ë¹—ë£¸',
        'ST': 'ì†ŒíŒŒí…Œì´ë¸”', 
        'TN': 'í…íŠ¸ë™',
        'VP': 'VIPë™',
        'YT': 'ì•¼ì¥í…Œì´ë¸”'
      };
      return map[code] || code;
    }

    // ê³„ì • íƒ€ì… í‘œì‹œ í•¨ìˆ˜
    function getAccountTypeDisplay(hasAccount, accountType, totalReservations = 0) {
      if (!hasAccount) {
        return '<span class="account-badge no-account">ê³„ì •ì—†ìŒ</span>';
      }
      
      if (accountType === 'login_account') {
        return `<span class="account-badge login-account" title="ì´ ${totalReservations}íšŒ ì˜ˆì•½">ë¡œê·¸ì¸ê³„ì •</span>`;
      } else if (accountType === 'simple_profile') {
        return `<span class="account-badge simple-profile" title="ì´ ${totalReservations}íšŒ ì˜ˆì•½">ê°„ë‹¨í”„ë¡œí•„</span>`;
      }
      
      return '<span class="account-badge unknown">ì•Œìˆ˜ì—†ìŒ</span>';
    }

    function editResource(resourceCode) {
      showAdminMessage('ì‹œì„¤ ìˆ˜ì • ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.', 'info');
    }

    function toggleResourceStatus(resourceCode, newActive) {
      showAdminMessage('ì‹œì„¤ ìƒíƒœ ë³€ê²½ ê¸°ëŠ¥ì€ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.', 'info');
    }

    // OSO Availability Management Functions
    async function loadAvailability() {
      const refreshBtn = document.getElementById('availabilityRefreshText');
      const dateFilter = document.getElementById('availabilityDateFilter');
      
      if (refreshBtn) refreshBtn.innerHTML = '<span class="loading-spinner"></span>';
      
      try {
        const selectedDate = dateFilter?.value;
        if (!selectedDate) {
          document.getElementById('availabilityGridContent').innerHTML = 
            '<div class="text-center" style="padding:20px; color:#666;">ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ ê°€ìš©ì„±ì„ í™•ì¸í•˜ì„¸ìš”</div>';
          return;
        }

        const result = await getAvailableSlots();
        if (result.success && result.data) {
          displayAvailabilityGrid(result.data, selectedDate);
          updateAvailabilityStats(result.data);
        } else {
          throw new Error(result.error || 'ê°€ìš©ì„± ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        }
      } catch (err) {
        console.error('ê°€ìš©ì„± ë¡œë“œ ì˜¤ë¥˜:', err);
        showAdminMessage('ê°€ìš©ì„± ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      } finally {
        if (refreshBtn) refreshBtn.textContent = 'ìƒˆë¡œê³ ì¹¨';
      }
    }

    function displayAvailabilityGrid(slots, selectedDate) {
      const categoryFilter = document.getElementById('availabilityCategoryFilter').value;
      let filteredSlots = slots;
      
      if (categoryFilter) {
        filteredSlots = slots.filter(slot => slot.category_code === categoryFilter);
      }
      
      // Group by resource
      const resourceGroups = filteredSlots.reduce((acc, slot) => {
        if (!acc[slot.resource_code]) {
          acc[slot.resource_code] = {
            name: slot.display_name,
            category: slot.category_code,
            slots: {}
          };
        }
        acc[slot.resource_code].slots[slot.time_slot] = slot;
        return acc;
      }, {});
      
      const gridContent = Object.entries(resourceGroups)
        .map(([resourceCode, resource]) => {
          const timeSlots = ['lunch', 'afternoon', 'dinner'];
          return `
            <div class="availability-row" style="display:flex; gap:10px; margin-bottom:8px; align-items:center;">
              <div class="resource-name" style="width:150px; font-weight:500;">
                <span class="category-badge ${resource.category.toLowerCase()}" style="margin-right:5px;">${getCategoryName(resource.category)}</span>
                ${resource.name}
              </div>
              ${timeSlots.map(timeSlot => {
                const slot = resource.slots[timeSlot];
                const isAvailable = slot && slot.active && !slot.is_booked;
                return `
                  <div class="time-slot-status ${isAvailable ? 'available' : 'unavailable'}" 
                       style="flex:1; padding:8px; text-align:center; border-radius:4px; border:1px solid #ddd; 
                              background:${isAvailable ? '#e8f5e8' : '#f8f9fa'}; color:${isAvailable ? '#155724' : '#6c757d'};">
                    ${isAvailable ? 'ì˜ˆì•½ê°€ëŠ¥' : (slot?.is_booked ? 'ì˜ˆì•½ë¨' : 'ë¹„í™œì„±')}
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }).join('');
      
      document.getElementById('availabilityGridContent').innerHTML = 
        gridContent || '<div class="text-center" style="padding:20px; color:#666;">í•´ë‹¹ ì¡°ê±´ì— ë§ëŠ” ì‹œì„¤ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
    }

    function updateAvailabilityStats(slots) {
      const total = slots.length;
      const available = slots.filter(s => s.active && !s.is_booked).length;
      const booked = slots.filter(s => s.is_booked).length;
      const inactive = slots.filter(s => !s.active).length;
      
      document.getElementById('totalSlots').textContent = total;
      document.getElementById('availableSlots').textContent = available;
      document.getElementById('bookedSlots').textContent = booked;
      document.getElementById('inactiveSlots').textContent = inactive;
    }

    // Utility functions
    function showAdminMessage(message, type = 'info') {
      const container = document.getElementById('adminMessageContainer');
      const content = document.getElementById('adminMessageContent');
      if (container && content) {
        content.textContent = message;
        container.className = `message-container show ${type}`;
        container.style.display = 'block';
        setTimeout(() => hideAdminMessage(), 5000);
      }
    }

    function hideAdminMessage() {
      const container = document.getElementById('adminMessageContainer');
      if (container) {
        container.style.display = 'none';
        container.className = 'message-container';
      }
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return '-';
      const date = new Date(dateStr);
      return date.toLocaleDateString('ko-KR') + ' ' + date.toLocaleTimeString('ko-KR', {hour12: false});
    }

    // Phase 3.1: ì‹¤ì‹œê°„ ì•Œë¦¼ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    class NotificationUI {
      constructor() {
        this.notificationSystem = null;
        this.isInitialized = false;
        this.unreadCount = 0;
      }

      async initialize() {
        if (this.isInitialized) return;
        
        try {
          // Supabase ì„¤ì • í™•ì¸
          if (!window.supabase || !window.RealtimeNotificationSystem) {
            console.warn('Supabase ë˜ëŠ” RealtimeNotificationSystemì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
          }

          // ì‹¤ì‹œê°„ ì•Œë¦¼ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
          this.notificationSystem = new RealtimeNotificationSystem();
          await this.notificationSystem.initialize();

          // UI ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
          this.setupEventListeners();
          
          // ê¸°ì¡´ ì•Œë¦¼ ë¡œë“œ
          await this.loadExistingNotifications();
          
          this.isInitialized = true;
          console.log('NotificationUI initialized successfully');
        } catch (error) {
          console.error('NotificationUI ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        }
      }

      setupEventListeners() {
        // ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ í† ê¸€
        const notificationBell = document.getElementById('notificationBell');
        const notificationDropdown = document.getElementById('notificationDropdown');
        
        if (notificationBell && notificationDropdown) {
          notificationBell.addEventListener('click', (e) => {
            e.stopPropagation();
            this.toggleNotificationDropdown();
          });
        }

        // ëª¨ë“  ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬
        const markAllReadBtn = document.getElementById('markAllReadBtn');
        if (markAllReadBtn) {
          markAllReadBtn.addEventListener('click', () => {
            this.markAllNotificationsAsRead();
          });
        }

        // ë¬¸ì„œ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
        document.addEventListener('click', (e) => {
          if (!e.target.closest('.notification-dropdown') && !e.target.closest('#notificationBell')) {
            this.hideNotificationDropdown();
          }
        });

        // ì‹¤ì‹œê°„ ì•Œë¦¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        if (this.notificationSystem) {
          this.notificationSystem.on('notification', (notification) => {
            this.handleNewNotification(notification);
          });
        }
      }

      toggleNotificationDropdown() {
        const dropdown = document.getElementById('notificationDropdown');
        if (dropdown) {
          const isVisible = dropdown.style.display === 'block';
          dropdown.style.display = isVisible ? 'none' : 'block';
          
          if (!isVisible) {
            this.loadExistingNotifications();
          }
        }
      }

      hideNotificationDropdown() {
        const dropdown = document.getElementById('notificationDropdown');
        if (dropdown) {
          dropdown.style.display = 'none';
        }
      }

      async loadExistingNotifications() {
        if (!this.notificationSystem) return;

        try {
          const notifications = await this.notificationSystem.getAdminNotifications(20);
          this.renderNotifications(notifications);
          this.updateNotificationBadge(notifications.filter(n => !n.is_read).length);
        } catch (error) {
          console.error('ê¸°ì¡´ ì•Œë¦¼ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
      }

      renderNotifications(notifications) {
        const list = document.getElementById('notificationList');
        if (!list) return;

        if (notifications.length === 0) {
          list.innerHTML = '<div class="notification-empty">ìƒˆë¡œìš´ ì•Œë¦¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
          return;
        }

        list.innerHTML = notifications.map(notification => `
          <div class="notification-item ${notification.is_read ? 'read' : 'unread'}" 
               data-id="${notification.id}">
            <div class="notification-header">
              <span class="notification-title">${notification.title}</span>
              <span class="notification-time">${this.formatTimeAgo(notification.created_at)}</span>
            </div>
            <div class="notification-message">${notification.message}</div>
            ${notification.reservation_number ? 
              `<div class="notification-meta">ì˜ˆì•½ë²ˆí˜¸: ${notification.reservation_number}</div>` : ''}
          </div>
        `).join('');

        // ê°œë³„ ì•Œë¦¼ í´ë¦­ ì´ë²¤íŠ¸
        list.querySelectorAll('.notification-item').forEach(item => {
          item.addEventListener('click', () => {
            const notificationId = item.dataset.id;
            this.markNotificationAsRead(notificationId);
            
            // ì˜ˆì•½ë²ˆí˜¸ê°€ ìˆëŠ” ê²½ìš° í•´ë‹¹ ì˜ˆì•½ìœ¼ë¡œ ì´ë™
            const reservationNumber = item.querySelector('.notification-meta')?.textContent?.replace('ì˜ˆì•½ë²ˆí˜¸: ', '');
            if (reservationNumber) {
              this.navigateToReservation(reservationNumber);
            }
          });
        });
      }

      async markNotificationAsRead(notificationId) {
        if (!this.notificationSystem) return;

        try {
          await this.notificationSystem.markNotificationAsRead(notificationId);
          
          // UI ì—…ë°ì´íŠ¸
          const item = document.querySelector(`[data-id="${notificationId}"]`);
          if (item) {
            item.classList.remove('unread');
            item.classList.add('read');
          }
          
          // ë°°ì§€ ì—…ë°ì´íŠ¸
          this.unreadCount = Math.max(0, this.unreadCount - 1);
          this.updateNotificationBadge(this.unreadCount);
        } catch (error) {
          console.error('ì•Œë¦¼ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        }
      }

      async markAllNotificationsAsRead() {
        const unreadItems = document.querySelectorAll('.notification-item.unread');
        const promises = Array.from(unreadItems).map(item => 
          this.markNotificationAsRead(item.dataset.id)
        );
        
        await Promise.all(promises);
        this.updateNotificationBadge(0);
      }

      handleNewNotification(notification) {
        // í† ìŠ¤íŠ¸ ì•Œë¦¼ í‘œì‹œ
        if (this.notificationSystem) {
          this.notificationSystem.showToast(notification.title, notification.message, {
            type: notification.priority === 'high' ? 'success' : 'info',
            duration: 5000
          });
        }

        // ë°°ì§€ ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
        this.unreadCount++;
        this.updateNotificationBadge(this.unreadCount);

        // ë“œë¡­ë‹¤ìš´ì´ ì—´ë ¤ìˆë‹¤ë©´ ì•Œë¦¼ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        const dropdown = document.getElementById('notificationDropdown');
        if (dropdown && dropdown.style.display === 'block') {
          this.loadExistingNotifications();
        }
      }

      updateNotificationBadge(count) {
        const badge = document.getElementById('notificationBadge');
        if (badge) {
          if (count > 0) {
            badge.textContent = count > 99 ? '99+' : count;
            badge.style.display = 'flex';
          } else {
            badge.style.display = 'none';
          }
        }
      }

      navigateToReservation(reservationNumber) {
        // ì˜ˆì•½ ê²€ìƒ‰ ê¸°ëŠ¥ì´ ìˆë‹¤ë©´ í•´ë‹¹ ì˜ˆì•½ìœ¼ë¡œ ì´ë™
        // í˜„ì¬ëŠ” ê°„ë‹¨íˆ ì•Œë¦¼ë§Œ í‘œì‹œ
        showAdminMessage(`ì˜ˆì•½ë²ˆí˜¸ ${reservationNumber}ì„(ë¥¼) í™•ì¸í•˜ì„¸ìš”.`, 'info');
        this.hideNotificationDropdown();
      }

      formatTimeAgo(dateStr) {
        const now = new Date();
        const date = new Date(dateStr);
        const diffMs = now - date;
        const diffMins = Math.floor(diffMs / (1000 * 60));
        const diffHours = Math.floor(diffMins / 60);
        const diffDays = Math.floor(diffHours / 24);

        if (diffMins < 1) return 'ë°©ê¸ˆ ì „';
        if (diffMins < 60) return `${diffMins}ë¶„ ì „`;
        if (diffHours < 24) return `${diffHours}ì‹œê°„ ì „`;
        if (diffDays < 7) return `${diffDays}ì¼ ì „`;
        
        return date.toLocaleDateString('ko-KR');
      }
    }

    // ì „ì—­ ì•Œë¦¼ UI ì¸ìŠ¤í„´ìŠ¤
    let globalNotificationUI = null;

    // Phase 3.2: ë©”ì‹œì§€ ê´€ë¦¬ ì‹œìŠ¤í…œ
    let messageStatsData = {};

    // ë©”ì‹œì§€ ë¡œê·¸ ë¡œë“œ
    async function loadMessageLogs() {
      const statusFilter = document.getElementById('messageStatusFilter')?.value || null;
      const typeFilter = document.getElementById('messageTypeFilter')?.value || null;
      
      try {
        const logs = await getMessageLogs(100, statusFilter, typeFilter);
        const stats = await getMessageStats();
        
        renderMessageLogs(logs);
        updateMessageStats(stats);
        messageStatsData = stats;
        
      } catch (error) {
        console.error('ë©”ì‹œì§€ ë¡œê·¸ ë¡œë“œ ì‹¤íŒ¨:', error);
        showAdminMessage('ë©”ì‹œì§€ ë¡œê·¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ë©”ì‹œì§€ ë¡œê·¸ í…Œì´ë¸” ë Œë”ë§
    function renderMessageLogs(logs) {
      const tbody = document.getElementById('messageLogsTable');
      if (!tbody) return;

      if (logs.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:16px;">ë©”ì‹œì§€ ë¡œê·¸ê°€ ì—†ìŠµë‹ˆë‹¤</td></tr>';
        return;
      }

      tbody.innerHTML = logs.map(log => `
        <tr>
          <td style="padding:8px; border:1px solid #dee2e6;">
            ${formatDateTime(log.created_at)}
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;">
            ${log.reservation_number || '-'}
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;">
            <span class="message-type-badge ${log.message_type}">
              ${log.message_type.toUpperCase()}
            </span>
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;">
            ${log.recipient_phone || log.recipient_email || '-'}
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;">
            ${log.template_code || '-'}
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;" title="${log.subject || ''}">
            ${truncateText(log.subject || '-', 30)}
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;">
            <span class="status-badge ${log.status}">
              ${getStatusText(log.status)}
            </span>
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;">
            ${log.retry_count || 0}
          </td>
          <td style="padding:8px; border:1px solid #dee2e6;">
            ${log.status === 'failed' ? 
              `<button class="action-btn" onclick="retryMessage('${log.id}')">ì¬ë°œì†¡</button>` : 
              '-'
            }
            <button class="action-btn" onclick="viewMessageDetails('${log.id}')">ìƒì„¸</button>
          </td>
        </tr>
      `).join('');
    }

    // ë©”ì‹œì§€ í†µê³„ ì—…ë°ì´íŠ¸
    function updateMessageStats(stats) {
      document.getElementById('totalMessages').textContent = stats.total || 0;
      document.getElementById('smsMessages').textContent = stats.sms || 0;
      document.getElementById('emailMessages').textContent = stats.email || 0;
      document.getElementById('sentMessages').textContent = stats.sent || 0;
      document.getElementById('failedMessages').textContent = stats.failed || 0;
      document.getElementById('pendingMessages').textContent = stats.pending || 0;
    }

    // ë©”ì‹œì§€ í…œí”Œë¦¿ ë¡œë“œ
    async function loadMessageTemplates() {
      try {
        const templates = await getMessageTemplates();
        renderMessageTemplates(templates);
      } catch (error) {
        console.error('í…œí”Œë¦¿ ë¡œë“œ ì‹¤íŒ¨:', error);
        showAdminMessage('í…œí”Œë¦¿ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ë©”ì‹œì§€ í…œí”Œë¦¿ ë Œë”ë§
    function renderMessageTemplates(templates) {
      const container = document.getElementById('templateList');
      if (!container) return;

      if (templates.length === 0) {
        container.innerHTML = '<p style="text-align:center; padding:16px;">ë“±ë¡ëœ í…œí”Œë¦¿ì´ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
      }

      container.innerHTML = templates.map(template => `
        <div class="template-card" style="background:#f8f9fa; border-radius:8px; padding:16px; margin-bottom:12px;">
          <div class="template-header" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h4 style="margin:0;">${template.template_name}</h4>
            <div>
              <span class="message-type-badge ${template.message_type}">${template.message_type.toUpperCase()}</span>
              <button class="action-btn" onclick="editTemplate('${template.template_code}')">í¸ì§‘</button>
            </div>
          </div>
          <div class="template-content">
            <p><strong>ì½”ë“œ:</strong> ${template.template_code}</p>
            ${template.subject ? `<p><strong>ì œëª©:</strong> ${template.subject}</p>` : ''}
            <p><strong>ë‚´ìš©:</strong></p>
            <div style="background:#fff; padding:12px; border-radius:4px; white-space:pre-wrap; max-height:100px; overflow-y:auto;">
              ${template.content}
            </div>
          </div>
        </div>
      `).join('');
    }

    // ì¼ì¼ ë¦¬ë§ˆì¸ë” ë°œì†¡
    async function sendDailyReminders() {
      try {
        const count = await sendDailyReminders();
        showAdminMessage(`${count}ê±´ì˜ ë¦¬ë§ˆì¸ë”ë¥¼ ë°œì†¡í–ˆìŠµë‹ˆë‹¤.`, 'success');
        await loadMessageLogs(); // ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
      } catch (error) {
        console.error('ë¦¬ë§ˆì¸ë” ë°œì†¡ ì‹¤íŒ¨:', error);
        showAdminMessage('ë¦¬ë§ˆì¸ë” ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ì‹¤íŒ¨í•œ ë©”ì‹œì§€ ì¬ë°œì†¡
    async function retryFailedMessages() {
      try {
        const count = await retryFailedMessages();
        showAdminMessage(`${count}ê±´ì˜ ë©”ì‹œì§€ë¥¼ ì¬ë°œì†¡í–ˆìŠµë‹ˆë‹¤.`, 'success');
        await loadMessageLogs(); // ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
      } catch (error) {
        console.error('ë©”ì‹œì§€ ì¬ë°œì†¡ ì‹¤íŒ¨:', error);
        showAdminMessage('ë©”ì‹œì§€ ì¬ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ê°œë³„ ë©”ì‹œì§€ ì¬ë°œì†¡
    async function retryMessage(logId) {
      try {
        // ì¬ë°œì†¡ ë¡œì§ êµ¬í˜„ (í•„ìš”ì‹œ)
        showAdminMessage('ë©”ì‹œì§€ë¥¼ ì¬ë°œì†¡í–ˆìŠµë‹ˆë‹¤.', 'success');
        await loadMessageLogs(); // ë¡œê·¸ ìƒˆë¡œê³ ì¹¨
      } catch (error) {
        console.error('ë©”ì‹œì§€ ì¬ë°œì†¡ ì‹¤íŒ¨:', error);
        showAdminMessage('ë©”ì‹œì§€ ì¬ë°œì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ë©”ì‹œì§€ ìƒì„¸ ë³´ê¸°
    function viewMessageDetails(logId) {
      // ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ êµ¬í˜„ (í•„ìš”ì‹œ)
      showAdminMessage('ë©”ì‹œì§€ ìƒì„¸ ê¸°ëŠ¥ì€ í–¥í›„ êµ¬í˜„ë©ë‹ˆë‹¤.', 'info');
    }

    // í…œí”Œë¦¿ í¸ì§‘
    function editTemplate(templateCode) {
      // í…œí”Œë¦¿ í¸ì§‘ ëª¨ë‹¬ êµ¬í˜„ (í•„ìš”ì‹œ)
      showAdminMessage('í…œí”Œë¦¿ í¸ì§‘ ê¸°ëŠ¥ì€ í–¥í›„ êµ¬í˜„ë©ë‹ˆë‹¤.', 'info');
    }

    // ìƒíƒœ í…ìŠ¤íŠ¸ ë³€í™˜
    function getStatusText(status) {
      const statusMap = {
        pending: 'ë°œì†¡ ëŒ€ê¸°',
        sent: 'ë°œì†¡ ì™„ë£Œ',
        delivered: 'ì „ë‹¬ ì™„ë£Œ',
        failed: 'ë°œì†¡ ì‹¤íŒ¨'
      };
      return statusMap[status] || status;
    }

    // í…ìŠ¤íŠ¸ ìë¥´ê¸° ìœ í‹¸ë¦¬í‹°
    function truncateText(text, maxLength) {
      if (!text) return '';
      return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    // í•„í„° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    document.addEventListener('DOMContentLoaded', function() {
      const statusFilter = document.getElementById('messageStatusFilter');
      const typeFilter = document.getElementById('messageTypeFilter');
      
      if (statusFilter) {
        statusFilter.addEventListener('change', loadMessageLogs);
      }
      if (typeFilter) {
        typeFilter.addEventListener('change', loadMessageLogs);
      }
    });

    // ====================
    // ë³€ê²½ ìš”ì²­ ê´€ë¦¬ ê¸°ëŠ¥
    // ====================

    let currentModificationRequest = null;

    // ë³€ê²½ ìš”ì²­ ëª©ë¡ ë¡œë“œ
    async function loadModificationRequests() {
      try {
        const statusFilter = document.getElementById('modificationStatusFilter')?.value || '';
        const typeFilter = document.getElementById('modificationTypeFilter')?.value || '';
        
        const result = await getModificationRequests({
          status: statusFilter,
          modification_type: typeFilter
        });

        if (result.success && result.data) {
          displayModificationRequests(result.data);
          updateModificationStats(result.data);
        } else {
          console.error('ë³€ê²½ ìš”ì²­ ë¡œë“œ ì‹¤íŒ¨:', result.error);
          showEmptyModificationState();
        }
      } catch (error) {
        console.error('ë³€ê²½ ìš”ì²­ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
        showEmptyModificationState();
      }
    }

    // ë³€ê²½ ìš”ì²­ ëª©ë¡ í‘œì‹œ
    function displayModificationRequests(requests) {
      const tbody = document.getElementById('modificationsTable');
      const emptyState = document.getElementById('modificationsEmptyState');
      
      if (!requests || requests.length === 0) {
        showEmptyModificationState();
        return;
      }

      emptyState.style.display = 'none';
      
      tbody.innerHTML = requests.map(request => {
        const statusBadge = getModificationStatusBadge(request.status);
        const typeBadge = getModificationTypeBadge(request.modification_type);
        
        return `
          <tr>
            <td style="padding:8px; border:1px solid #dee2e6;">
              ${formatDateTime(request.created_at)}
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              <strong>${request.reservation_number}</strong>
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              ${request.customer_name}
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              ${request.customer_phone}
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              ${typeBadge}
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              <div class="original-info">
                ${formatOriginalInfo(request)}
              </div>
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              <div class="requested-info">
                ${formatRequestedInfo(request)}
              </div>
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              ${statusBadge}
            </td>
            <td style="padding:8px; border:1px solid #dee2e6;">
              <button class="action-btn small" onclick="showModificationDetails('${request.id}')">
                ìƒì„¸ë³´ê¸°
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // ë³€ê²½ ìš”ì²­ í†µê³„ ì—…ë°ì´íŠ¸
    function updateModificationStats(requests) {
      const total = requests.length;
      const pending = requests.filter(r => r.status === 'pending').length;
      const approved = requests.filter(r => r.status === 'approved').length;
      const rejected = requests.filter(r => r.status === 'rejected').length;
      const completed = requests.filter(r => r.status === 'completed').length;

      document.getElementById('totalModifications').textContent = total;
      document.getElementById('pendingModifications').textContent = pending;
      document.getElementById('approvedModifications').textContent = approved;
      document.getElementById('rejectedModifications').textContent = rejected;
      document.getElementById('completedModifications').textContent = completed;
    }

    // ë¹ˆ ìƒíƒœ í‘œì‹œ
    function showEmptyModificationState() {
      const tbody = document.getElementById('modificationsTable');
      const emptyState = document.getElementById('modificationsEmptyState');
      
      tbody.innerHTML = '<tr><td colspan="9" style="text-align:center; padding:16px;">ë³€ê²½ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
      emptyState.style.display = 'block';
    }

    // ë³€ê²½ ìš”ì²­ ìƒì„¸ ëª¨ë‹¬ í‘œì‹œ
    async function showModificationDetails(modificationId) {
      try {
        const result = await getModificationRequestById(modificationId);
        
        if (result.success && result.data) {
          currentModificationRequest = result.data;
          displayModificationModal(result.data);
        } else {
          showAdminMessage('ë³€ê²½ ìš”ì²­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        }
      } catch (error) {
        console.error('ë³€ê²½ ìš”ì²­ ìƒì„¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜:', error);
        showAdminMessage('ë³€ê²½ ìš”ì²­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      }
    }

    // ë³€ê²½ ìš”ì²­ ëª¨ë‹¬ í‘œì‹œ
    function displayModificationModal(request) {
      const modalBody = document.getElementById('modificationModalBody');
      const approveBtn = document.getElementById('approveModificationBtn');
      const rejectBtn = document.getElementById('rejectModificationBtn');

      // ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€
      if (request.status !== 'pending') {
        approveBtn.style.display = 'none';
        rejectBtn.style.display = 'none';
      } else {
        approveBtn.style.display = 'inline-block';
        rejectBtn.style.display = 'inline-block';
      }

      modalBody.innerHTML = `
        <div class="modification-details">
          <div class="detail-section">
            <h4>ê¸°ë³¸ ì •ë³´</h4>
            <div class="detail-grid">
              <div class="detail-item">
                <label>ì˜ˆì•½ë²ˆí˜¸:</label>
                <span>${request.reservation_number}</span>
              </div>
              <div class="detail-item">
                <label>ê³ ê°ëª…:</label>
                <span>${request.customer_name}</span>
              </div>
              <div class="detail-item">
                <label>ì—°ë½ì²˜:</label>
                <span>${request.customer_phone}</span>
              </div>
              <div class="detail-item">
                <label>ìš”ì²­ ì‹œê°„:</label>
                <span>${formatDateTime(request.created_at)}</span>
              </div>
            </div>
          </div>

          <div class="detail-section">
            <h4>ë³€ê²½ ìš”ì²­ ë‚´ìš©</h4>
            <div class="modification-comparison">
              <div class="before-after">
                <div class="before">
                  <h5>ê¸°ì¡´ ì •ë³´</h5>
                  ${formatDetailedOriginalInfo(request)}
                </div>
                <div class="after">
                  <h5>ë³€ê²½ ìš”ì²­</h5>
                  ${formatDetailedRequestedInfo(request)}
                </div>
              </div>
            </div>
          </div>

          ${request.reason ? `
            <div class="detail-section">
              <h4>ë³€ê²½ ì‚¬ìœ </h4>
              <p class="reason-text">${request.reason}</p>
            </div>
          ` : ''}

          ${request.modification_type === 'cancellation' ? `
            <div class="detail-section">
              <h4>í™˜ë¶ˆ ì •ë³´</h4>
              <div class="refund-details">
                <div class="refund-item">
                  <label>ì›ë˜ ê¸ˆì•¡:</label>
                  <span>${formatPrice(request.original_data?.total_price || 0)}ì›</span>
                </div>
                <div class="refund-item">
                  <label>í™˜ë¶ˆìœ¨:</label>
                  <span>${request.refund_rate || 0}%</span>
                </div>
                <div class="refund-item">
                  <label>ì˜ˆìƒ í™˜ë¶ˆ ê¸ˆì•¡:</label>
                  <span class="refund-amount">${formatPrice(request.refund_amount || 0)}ì›</span>
                </div>
              </div>
            </div>
          ` : ''}

          <div class="detail-section">
            <h4>ì²˜ë¦¬ ìƒíƒœ</h4>
            <div class="status-info">
              <span class="status-badge ${request.status}">${getStatusText(request.status)}</span>
              ${request.processed_at ? `<span class="processed-time">ì²˜ë¦¬ ì‹œê°„: ${formatDateTime(request.processed_at)}</span>` : ''}
            </div>
          </div>
        </div>
      `;

      document.getElementById('modificationModal').style.display = 'block';
    }

    // ë³€ê²½ ìš”ì²­ ì²˜ë¦¬ (ìŠ¹ì¸/ê±°ë¶€)
    async function processModification(action) {
      if (!currentModificationRequest) return;

      const actionText = action === 'approved' ? 'ìŠ¹ì¸' : 'ê±°ë¶€';
      
      if (!confirm(`ì´ ë³€ê²½ ìš”ì²­ì„ ${actionText}í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }

      try {
        const result = await processModificationRequest(currentModificationRequest.id, action);

        if (result.success) {
          showAdminMessage(`ë³€ê²½ ìš”ì²­ì´ ${actionText}ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
          closeModificationModal();
          loadModificationRequests(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        } else {
          showAdminMessage(`ë³€ê²½ ìš”ì²­ ${actionText} ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${result.error}`, 'error');
        }
      } catch (error) {
        console.error(`ë³€ê²½ ìš”ì²­ ${actionText} ì¤‘ ì˜¤ë¥˜:`, error);
        showAdminMessage(`ë³€ê²½ ìš”ì²­ ${actionText} ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.`, 'error');
      }
    }

    // ë³€ê²½ ìš”ì²­ ëª¨ë‹¬ ë‹«ê¸°
    function closeModificationModal() {
      document.getElementById('modificationModal').style.display = 'none';
      currentModificationRequest = null;
    }

    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function getModificationStatusBadge(status) {
      const statusMap = {
        'pending': { text: 'ëŒ€ê¸° ì¤‘', class: 'warning' },
        'approved': { text: 'ìŠ¹ì¸ë¨', class: 'success' },
        'rejected': { text: 'ê±°ë¶€ë¨', class: 'danger' },
        'completed': { text: 'ì²˜ë¦¬ ì™„ë£Œ', class: 'info' }
      };
      
      const statusInfo = statusMap[status] || { text: status, class: 'secondary' };
      return `<span class="status-badge ${statusInfo.class}">${statusInfo.text}</span>`;
    }

    function getModificationTypeBadge(type) {
      const typeMap = {
        'date': { text: 'ë‚ ì§œ ë³€ê²½', class: 'info' },
        'guests': { text: 'ì¸ì› ë³€ê²½', class: 'warning' },
        'cancellation': { text: 'ì˜ˆì•½ ì·¨ì†Œ', class: 'danger' }
      };
      
      const typeInfo = typeMap[type] || { text: type, class: 'secondary' };
      return `<span class="type-badge ${typeInfo.class}">${typeInfo.text}</span>`;
    }

    function formatOriginalInfo(request) {
      if (request.modification_type === 'date') {
        return `${formatDate(request.original_data?.reservation_date)} ${request.original_data?.time_slot}`;
      } else if (request.modification_type === 'guests') {
        return `${request.original_data?.guest_count}ëª…`;
      } else if (request.modification_type === 'cancellation') {
        return `${formatPrice(request.original_data?.total_price || 0)}ì›`;
      }
      return '-';
    }

    function formatRequestedInfo(request) {
      if (request.modification_type === 'date') {
        return `${formatDate(request.new_data?.reservation_date)} ${request.new_data?.time_slot}`;
      } else if (request.modification_type === 'guests') {
        return `${request.new_data?.guest_count}ëª…`;
      } else if (request.modification_type === 'cancellation') {
        return `í™˜ë¶ˆ: ${formatPrice(request.refund_amount || 0)}ì›`;
      }
      return '-';
    }

    function formatDetailedOriginalInfo(request) {
      if (request.modification_type === 'date') {
        return `
          <div class="info-item">
            <label>ì˜ˆì•½ì¼:</label>
            <span>${formatDate(request.original_data?.reservation_date)}</span>
          </div>
          <div class="info-item">
            <label>ì‹œê°„:</label>
            <span>${request.original_data?.time_slot}</span>
          </div>
        `;
      } else if (request.modification_type === 'guests') {
        return `
          <div class="info-item">
            <label>ì¸ì›:</label>
            <span>${request.original_data?.guest_count}ëª…</span>
          </div>
          <div class="info-item">
            <label>ì´ ê¸ˆì•¡:</label>
            <span>${formatPrice(request.original_data?.total_price || 0)}ì›</span>
          </div>
        `;
      } else if (request.modification_type === 'cancellation') {
        return `
          <div class="info-item">
            <label>ì˜ˆì•½ì¼:</label>
            <span>${formatDate(request.original_data?.reservation_date)}</span>
          </div>
          <div class="info-item">
            <label>ê²°ì œ ê¸ˆì•¡:</label>
            <span>${formatPrice(request.original_data?.total_price || 0)}ì›</span>
          </div>
        `;
      }
      return '-';
    }

    function formatDetailedRequestedInfo(request) {
      if (request.modification_type === 'date') {
        return `
          <div class="info-item">
            <label>ìƒˆ ì˜ˆì•½ì¼:</label>
            <span>${formatDate(request.new_data?.reservation_date)}</span>
          </div>
          <div class="info-item">
            <label>ìƒˆ ì‹œê°„:</label>
            <span>${request.new_data?.time_slot}</span>
          </div>
        `;
      } else if (request.modification_type === 'guests') {
        const priceDiff = (request.new_data?.total_price || 0) - (request.original_data?.total_price || 0);
        return `
          <div class="info-item">
            <label>ìƒˆ ì¸ì›:</label>
            <span>${request.new_data?.guest_count}ëª…</span>
          </div>
          <div class="info-item">
            <label>ìƒˆ ê¸ˆì•¡:</label>
            <span>${formatPrice(request.new_data?.total_price || 0)}ì›</span>
          </div>
          <div class="info-item">
            <label>ì°¨ì•¡:</label>
            <span class="${priceDiff >= 0 ? 'positive' : 'negative'}">${priceDiff >= 0 ? '+' : ''}${formatPrice(priceDiff)}ì›</span>
          </div>
        `;
      } else if (request.modification_type === 'cancellation') {
        return `
          <div class="info-item">
            <label>ì·¨ì†Œ ìš”ì²­:</label>
            <span>ì „ì²´ ì˜ˆì•½ ì·¨ì†Œ</span>
          </div>
          <div class="info-item">
            <label>í™˜ë¶ˆ ê¸ˆì•¡:</label>
            <span class="refund-amount">${formatPrice(request.refund_amount || 0)}ì›</span>
          </div>
        `;
      }
      return '-';
    }

    // ============================
    // ê´€ë¦¬ì UI í•¨ìˆ˜ë“¤ (Phase 2.3)
    // ============================
    
    // ì‚¬ìš©ì ë©”ë‰´ í† ê¸€
    function toggleUserMenu() {
      const dropdown = document.getElementById('userMenuDropdown');
      const isVisible = dropdown.style.display === 'block';
      
      // ëª¨ë“  ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
      document.querySelectorAll('.user-menu-dropdown').forEach(d => {
        d.style.display = 'none';
      });
      
      // í˜„ì¬ ë“œë¡­ë‹¤ìš´ í† ê¸€
      if (!isVisible) {
        dropdown.style.display = 'block';
      }
    }
    
    // ê´€ë¦¬ì í”„ë¡œí•„ ë³´ê¸°
    function showProfile() {
      if (!adminAuth || !adminAuth.adminProfile) {
        showAdminMessage('í”„ë¡œí•„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        return;
      }
      
      const profile = adminAuth.adminProfile;
      const profileHtml = `
        <div class="profile-info">
          <h3>ê´€ë¦¬ì í”„ë¡œí•„</h3>
          <div class="profile-details">
            <div class="profile-item">
              <label>ì´ë©”ì¼:</label>
              <span>${profile.email}</span>
            </div>
            <div class="profile-item">
              <label>ì´ë¦„:</label>
              <span>${profile.full_name || 'ì„¤ì •ë˜ì§€ ì•ŠìŒ'}</span>
            </div>
            <div class="profile-item">
              <label>ì—­í• :</label>
              <span class="role-badge ${profile.role}">${getRoleDisplayName(profile.role)}</span>
            </div>
            <div class="profile-item">
              <label>ë§ˆì§€ë§‰ ë¡œê·¸ì¸:</label>
              <span>${profile.last_login_at ? formatDateTime(profile.last_login_at) : 'ì •ë³´ ì—†ìŒ'}</span>
            </div>
            <div class="profile-item">
              <label>ê³„ì • ìƒì„±ì¼:</label>
              <span>${formatDateTime(profile.created_at)}</span>
            </div>
          </div>
          <div class="profile-permissions">
            <h4>ê¶Œí•œ ì •ë³´</h4>
            <div class="permissions-grid">
              ${Object.entries(profile.permissions || {}).map(([resource, perms]) => `
                <div class="permission-item">
                  <div class="permission-resource">${getResourceDisplayName(resource)}</div>
                  <div class="permission-actions">
                    ${perms.read ? '<span class="perm-badge read">ì¡°íšŒ</span>' : ''}
                    ${perms.write ? '<span class="perm-badge write">ìˆ˜ì •</span>' : ''}
                    ${perms.delete ? '<span class="perm-badge delete">ì‚­ì œ</span>' : ''}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      `;
      
      // ëª¨ë‹¬ë¡œ í‘œì‹œ
      showProfileModal(profileHtml);
      closeUserMenu();
    }
    
    // í™œë™ ë¡œê·¸ ë³´ê¸°  
    async function showActivityLog() {
      try {
        if (!adminAuth || !adminAuth.isAuthenticated) {
          showAdminMessage('ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
          return;
        }
        
        // ìµœê·¼ í™œë™ ë¡œê·¸ ì¡°íšŒ
        const { data, error } = await adminAuth.supabaseClient
          .from('admin_activity_logs')
          .select('*')
          .eq('admin_id', adminAuth.currentAdmin.id)
          .order('created_at', { ascending: false })
          .limit(50);
        
        if (error) {
          throw error;
        }
        
        const logHtml = `
          <div class="activity-log">
            <h3>ë‚´ í™œë™ ë¡œê·¸</h3>
            <div class="log-list">
              ${data && data.length > 0 ? data.map(log => `
                <div class="log-item ${log.success ? 'success' : 'error'}">
                  <div class="log-header">
                    <span class="log-action">${getActionDisplayName(log.action_type)}</span>
                    <span class="log-time">${formatDateTime(log.created_at)}</span>
                  </div>
                  ${log.resource_type ? `<div class="log-resource">${getResourceDisplayName(log.resource_type)}</div>` : ''}
                  ${log.error_message ? `<div class="log-error">${log.error_message}</div>` : ''}
                </div>
              `).join('') : '<div class="no-logs">í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>'}
            </div>
          </div>
        `;
        
        showProfileModal(logHtml);
        closeUserMenu();
        
      } catch (error) {
        console.error('í™œë™ ë¡œê·¸ ì¡°íšŒ ì‹¤íŒ¨:', error);
        showAdminMessage('í™œë™ ë¡œê·¸ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
      }
    }
    
    // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    async function handleLogout() {
      if (!confirm('ì •ë§ ë¡œê·¸ì•„ì›ƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        if (adminAuth) {
          await adminAuth.logout();
        } else {
          // ì¸ì¦ ì‹œìŠ¤í…œì´ ì—†ì„ ê²½ìš° ì§ì ‘ ì²˜ë¦¬
          window.location.href = 'admin-login.html';
        }
      } catch (error) {
        console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
        // ì˜¤ë¥˜ê°€ ìˆì–´ë„ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
        window.location.href = 'admin-login.html';
      }
    }
    
    // ì‚¬ìš©ì ë©”ë‰´ ë‹«ê¸°
    function closeUserMenu() {
      const dropdown = document.getElementById('userMenuDropdown');
      if (dropdown) {
        dropdown.style.display = 'none';
      }
    }
    
    // í”„ë¡œí•„ ëª¨ë‹¬ í‘œì‹œ
    function showProfileModal(content) {
      // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆë‹¤ë©´ ì œê±°
      const existingModal = document.getElementById('profileModal');
      if (existingModal) {
        existingModal.remove();
      }
      
      // ìƒˆ ëª¨ë‹¬ ìƒì„±
      const modal = document.createElement('div');
      modal.id = 'profileModal';
      modal.className = 'modal';
      modal.style.display = 'block';
      modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
          <div class="modal-header">
            <button class="modal-close" onclick="closeProfileModal()" aria-label="close">&times;</button>
          </div>
          <div class="modal-body">
            ${content}
          </div>
          <div class="modal-footer">
            <button class="action-btn cancel" onclick="closeProfileModal()">ë‹«ê¸°</button>
          </div>
        </div>
      `;
      
      document.body.appendChild(modal);
      
      // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
      modal.addEventListener('click', function(e) {
        if (e.target === modal) {
          closeProfileModal();
        }
      });
    }
    
    // í”„ë¡œí•„ ëª¨ë‹¬ ë‹«ê¸°
    function closeProfileModal() {
      const modal = document.getElementById('profileModal');
      if (modal) {
        modal.remove();
      }
    }
    
    // ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
    function getRoleDisplayName(role) {
      const roleNames = {
        'super_admin': 'ìµœê³ ê´€ë¦¬ì',
        'admin': 'ê´€ë¦¬ì',
        'viewer': 'ì¡°íšŒì'
      };
      return roleNames[role] || role;
    }
    
    function getResourceDisplayName(resource) {
      const resourceNames = {
        'reservations': 'ì˜ˆì•½ ì‹ ì²­',
        'bookings': 'ì˜ˆì•½ í˜„í™©',
        'catalog': 'ì‹œì„¤ ê´€ë¦¬',
        'availability': 'ê°€ìš©ì„± ê´€ë¦¬',
        'modifications': 'ë³€ê²½ ìš”ì²­',
        'messages': 'ë©”ì‹œì§€ ê´€ë¦¬',
        'users': 'ì‚¬ìš©ì ê´€ë¦¬',
        'auth': 'ì¸ì¦',
        'admin_dashboard': 'ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ'
      };
      return resourceNames[resource] || resource;
    }
    
    function getActionDisplayName(action) {
      const actionNames = {
        'login': 'ë¡œê·¸ì¸',
        'logout': 'ë¡œê·¸ì•„ì›ƒ',
        'page_access': 'í˜ì´ì§€ ì ‘ê·¼',
        'create': 'ìƒì„±',
        'update': 'ìˆ˜ì •',
        'delete': 'ì‚­ì œ',
        'view': 'ì¡°íšŒ'
      };
      return actionNames[action] || action;
    }
    
    // ì™¸ë¶€ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
    document.addEventListener('click', function(e) {
      if (!e.target.closest('.admin-user-info')) {
        closeUserMenu();
      }
    });

    // DOMì´ ë¡œë“œëœ í›„ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', async function() {
      // ê¸°ì¡´ ì´ˆê¸°í™” ì½”ë“œ ì‹¤í–‰
      await loadProducts();
      loadReservations();
      
      // ì•Œë¦¼ ì‹œìŠ¤í…œ ì´ˆê¸°í™” (ì•½ê°„ì˜ ì§€ì—° í›„)
      setTimeout(async () => {
        try {
          globalNotificationUI = new NotificationUI();
          await globalNotificationUI.initialize();
        } catch (error) {
          console.error('ì•Œë¦¼ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:', error);
        }
      }, 1000);
    });
  </script>
</body>
</html>
