<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì›ìì  ì˜ˆì•½ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-card { background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 20px 0; }
        .success { border-color: #28a745; background: #d4edda; }
        .error { border-color: #dc3545; background: #f8d7da; }
        .warning { border-color: #ffc107; background: #fff3cd; }
        button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        pre { background: #343a40; color: #ffffff; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .log { margin-top: 20px; }
        .concurrent-test { background: #e3f2fd; border-color: #2196f3; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ì›ìì  ì˜ˆì•½ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸</h1>
    <p>ìˆ˜ì •ëœ ì˜ˆì•½ ì‹œìŠ¤í…œì˜ ë™ì‘ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>

    <!-- DB í•¨ìˆ˜ ì¡´ì¬ í™•ì¸ -->
    <div class="test-card" id="function-check">
        <h3>1. DB í•¨ìˆ˜ ì¡´ì¬ í™•ì¸</h3>
        <button onclick="checkAtomicFunction()">í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸</button>
        <div id="function-result"></div>
    </div>

    <!-- ê¸°ë³¸ ì˜ˆì•½ í…ŒìŠ¤íŠ¸ -->
    <div class="test-card" id="basic-test">
        <h3>2. ê¸°ë³¸ ì˜ˆì•½ í…ŒìŠ¤íŠ¸</h3>
        <button onclick="testBasicReservation()">ë‹¨ì¼ ì˜ˆì•½ ìƒì„± í…ŒìŠ¤íŠ¸</button>
        <div id="basic-result"></div>
    </div>

    <!-- ë™ì‹œì„± í…ŒìŠ¤íŠ¸ -->
    <div class="test-card concurrent-test" id="concurrent-test">
        <h3>3. ë™ì‹œì„± í…ŒìŠ¤íŠ¸ (ì¤‘ìš”!)</h3>
        <p>ê°™ì€ ìŠ¬ë¡¯ì— ë™ì‹œì— ì—¬ëŸ¬ ì˜ˆì•½ì„ ì‹œë„í•˜ì—¬ ì¤‘ë³µ ì˜ˆì•½ì´ ë°©ì§€ë˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.</p>
        <button onclick="testConcurrentReservations()">ë™ì‹œ ì˜ˆì•½ ì¶©ëŒ í…ŒìŠ¤íŠ¸</button>
        <div id="concurrent-result"></div>
    </div>

    <!-- ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ -->
    <div class="test-card" id="error-test">
        <h3>4. ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸</h3>
        <button onclick="testErrorHandling()">ì˜ëª»ëœ ë°ì´í„°ë¡œ í…ŒìŠ¤íŠ¸</button>
        <div id="error-result"></div>
    </div>

    <div class="log">
        <h3>ğŸ“‹ í…ŒìŠ¤íŠ¸ ë¡œê·¸</h3>
        <pre id="log"></pre>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="env.js"></script>
    <script src="supabase-config-v2.js"></script>
    
    <script>
        const log = document.getElementById('log');
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logLine = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            log.textContent += logLine;
            log.scrollTop = log.scrollHeight;
            console.log(logLine.trim());
        }

        // 1. DB í•¨ìˆ˜ ì¡´ì¬ í™•ì¸
        async function checkAtomicFunction() {
            const resultDiv = document.getElementById('function-result');
            try {
                addLog('create_reservation_atomic í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ì¤‘...');
                
                // ë”ë¯¸ ë°ì´í„°ë¡œ í•¨ìˆ˜ í˜¸ì¶œ (ì‹¤ì œë¡œëŠ” ì‹¤í–‰í•˜ì§€ ì•ŠìŒ)
                const { error } = await supabaseClient.rpc('create_reservation_atomic', {
                    p_name: 'TEST_CHECK',
                    p_phone: '000-0000-0000',
                    p_reservation_date: '2025-12-31',
                    p_reservation_time: '23:59:00',
                    p_guest_count: 1
                });
                
                if (error && error.message.includes('function create_reservation_atomic')) {
                    resultDiv.innerHTML = '<div class="error">âŒ í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Supabaseì—ì„œ SQL ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</div>';
                    addLog('í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ', 'error');
                } else {
                    resultDiv.innerHTML = '<div class="success">âœ… í•¨ìˆ˜ê°€ ì¡´ì¬í•©ë‹ˆë‹¤!</div>';
                    addLog('í•¨ìˆ˜ ì¡´ì¬ í™•ì¸ ì™„ë£Œ', 'success');
                }
            } catch (error) {
                if (error.message.includes('function create_reservation_atomic')) {
                    resultDiv.innerHTML = '<div class="error">âŒ í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Supabaseì—ì„œ SQL ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”.</div>';
                    addLog('í•¨ìˆ˜ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ', 'error');
                } else {
                    resultDiv.innerHTML = '<div class="warning">âš ï¸ í•¨ìˆ˜ëŠ” ì¡´ì¬í•˜ì§€ë§Œ í…ŒìŠ¤íŠ¸ ë°ì´í„°ê°€ ì²˜ë¦¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
                    addLog('í•¨ìˆ˜ ì¡´ì¬ ì¶”ì •ë¨', 'warning');
                }
            }
        }

        // 2. ê¸°ë³¸ ì˜ˆì•½ í…ŒìŠ¤íŠ¸
        async function testBasicReservation() {
            const resultDiv = document.getElementById('basic-result');
            try {
                addLog('ê¸°ë³¸ ì˜ˆì•½ í…ŒìŠ¤íŠ¸ ì‹œì‘');
                
                const testData = {
                    name: 'í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì',
                    phone: '010-1234-5678',
                    email: 'test@example.com',
                    reservation_date: '2025-12-25',
                    reservation_time: '10:00:00',
                    guest_count: 2,
                    service_type: 'í…ŒìŠ¤íŠ¸ ì„œë¹„ìŠ¤',
                    message: 'ì›ìì  ì˜ˆì•½ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.'
                };

                const result = await createReservation(testData);
                
                if (result.success) {
                    resultDiv.innerHTML = `<div class="success">âœ… ì˜ˆì•½ ì„±ê³µ!<br>ì˜ˆì•½ë²ˆí˜¸: ${result.reservation_number}<br>ID: ${result.data.id}</div>`;
                    addLog(`ì˜ˆì•½ ì„±ê³µ: ${result.reservation_number}`, 'success');
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ ì˜ˆì•½ ì‹¤íŒ¨: ${result.error}</div>`;
                    addLog(`ì˜ˆì•½ ì‹¤íŒ¨: ${result.error}`, 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}</div>`;
                addLog(`í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // 3. ë™ì‹œì„± í…ŒìŠ¤íŠ¸
        async function testConcurrentReservations() {
            const resultDiv = document.getElementById('concurrent-result');
            addLog('ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì‹œì‘ - ê°™ì€ ìŠ¬ë¡¯ì— 5ê°œ ì˜ˆì•½ ì‹œë„');
            
            const promises = [];
            const testSlot = {
                reservation_date: '2025-12-20',
                reservation_time: '14:00:00'
            };

            // 5ê°œì˜ ë™ì‹œ ì˜ˆì•½ ì‹œë„
            for (let i = 1; i <= 5; i++) {
                const testData = {
                    name: `ë™ì‹œí…ŒìŠ¤íŠ¸${i}`,
                    phone: `010-1111-${i.toString().padStart(4, '0')}`,
                    email: `test${i}@example.com`,
                    reservation_date: testSlot.reservation_date,
                    reservation_time: testSlot.reservation_time,
                    guest_count: 1,
                    message: `ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ${i}`
                };
                promises.push(createReservation(testData));
            }

            try {
                const results = await Promise.all(promises);
                
                const successful = results.filter(r => r.success).length;
                const failed = results.filter(r => !r.success).length;
                
                let html = `<div class="success">ğŸ“Š ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ê²°ê³¼:</div>`;
                html += `<ul>`;
                html += `<li>ì„±ê³µí•œ ì˜ˆì•½: ${successful}ê°œ</li>`;
                html += `<li>ì‹¤íŒ¨í•œ ì˜ˆì•½: ${failed}ê°œ</li>`;
                html += `</ul>`;
                
                if (successful === 1 && failed === 4) {
                    html += `<div class="success">âœ… ë™ì‹œì„± ì œì–´ ì„±ê³µ! ì •í™•íˆ 1ê°œë§Œ ì˜ˆì•½ë¨</div>`;
                    addLog('ë™ì‹œì„± í…ŒìŠ¤íŠ¸ í†µê³¼ - 1ê°œë§Œ ì„±ê³µ', 'success');
                } else if (successful > 1) {
                    html += `<div class="error">âŒ ì¤‘ë³µ ì˜ˆì•½ ë°œìƒ! ${successful}ê°œê°€ ëª¨ë‘ ì„±ê³µí•¨</div>`;
                    addLog(`ì¤‘ë³µ ì˜ˆì•½ ë°œìƒ: ${successful}ê°œ ì„±ê³µ`, 'error');
                } else {
                    html += `<div class="warning">âš ï¸ ì˜ˆìƒê³¼ ë‹¤ë¥¸ ê²°ê³¼</div>`;
                    addLog(`ì˜ˆìƒê³¼ ë‹¤ë¥¸ ê²°ê³¼: ì„±ê³µ ${successful}, ì‹¤íŒ¨ ${failed}`, 'warning');
                }

                // ì‹¤íŒ¨ ì´ìœ  ë¶„ì„
                results.forEach((result, index) => {
                    if (!result.success) {
                        addLog(`ì˜ˆì•½ ${index + 1} ì‹¤íŒ¨: ${result.error}`, 'info');
                    }
                });

                resultDiv.innerHTML = html;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">âŒ ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}</div>`;
                addLog(`ë™ì‹œì„± í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // 4. ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
        async function testErrorHandling() {
            const resultDiv = document.getElementById('error-result');
            addLog('ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸ ì‹œì‘');
            
            const invalidData = {
                name: '', // ë¹ˆ ì´ë¦„
                phone: 'invalid-phone', // ì˜ëª»ëœ ì „í™”ë²ˆí˜¸
                reservation_date: 'invalid-date', // ì˜ëª»ëœ ë‚ ì§œ
                reservation_time: '25:00:00' // ì˜ëª»ëœ ì‹œê°„
            };

            try {
                const result = await createReservation(invalidData);
                
                if (!result.success) {
                    resultDiv.innerHTML = `<div class="success">âœ… ì—ëŸ¬ ì²˜ë¦¬ ì •ìƒ: ${result.error}</div>`;
                    addLog(`ì—ëŸ¬ ì²˜ë¦¬ ì •ìƒ: ${result.error}`, 'success');
                } else {
                    resultDiv.innerHTML = `<div class="error">âŒ ì˜ëª»ëœ ë°ì´í„°ê°€ í†µê³¼ë¨</div>`;
                    addLog('ì˜ëª»ëœ ë°ì´í„°ê°€ í†µê³¼ë¨', 'error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="success">âœ… JavaScript ë ˆë²¨ì—ì„œ ì—ëŸ¬ ì²˜ë¦¬ë¨: ${error.message}</div>`;
                addLog(`JavaScript ì—ëŸ¬ ì²˜ë¦¬: ${error.message}`, 'success');
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            addLog('ì›ìì  ì˜ˆì•½ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ');
            addLog('ë¨¼ì € "í•¨ìˆ˜ ì¡´ì¬ ì—¬ë¶€ í™•ì¸" ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”');
        });
    </script>
</body>
</html>